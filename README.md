# BEARLAKE DETAILING BOT

Telegram-бот — виртуальный консультант студии детейлинга **BEARLAKE DETAILING & SHOP**.
Консультирует клиентов по услугам, ценам, условиям, помогает записаться на обслуживание и повышает конверсию в запись.

## Структура проекта

```
├── main.py              # Основная логика бота
├── analytics.py         # Аналитика, логирование, отчёты
├── knowledges.txt       # База знаний студии (услуги, цены, FAQ)
├── generate_report.py   # CLI-скрипт для генерации отчёта
├── requirements.txt     # Зависимости Python
├── .env                 # Переменные окружения (не в Git)
├── .gitignore           # Исключения для Git
├── Procfile             # Конфигурация для Railway/Heroku
├── railway.toml         # Настройки деплоя Railway
├── runtime.txt          # Версия Python (3.11)
├── logs/                # CSV-логи (создаётся автоматически)
│   ├── clients.csv      # Визиты клиентов
│   ├── questions.csv    # Все вопросы и запросы
│   ├── buttons.csv      # Нажатия на кнопки меню
│   ├── ratings.csv      # Оценки консультаций (1–5)
│   ├── tokens.csv       # Расход токенов GPT
│   ├── consents.csv     # Согласия на обработку ПД
│   └── bot.log          # Лог работы бота (ротация 10 МБ × 5)
└── reports/             # Сгенерированные Excel-отчёты
```

## Возможности бота

### Консультирование
- Ответы на вопросы клиентов на основе базы знаний и GPT-4o-mini
- Контекст диалога (до 20 сообщений)
- Автоматическое предложение записи после каждого информационного ответа

### Интерактивное меню (Inline-кнопки)
**Главное меню:**
- Услуги мастеров (с подменю: мойка, полировка, защита ЛКП, детейлинг салона, бронирование стекла, ремонт сколов)
- Самообслуживание (с подменю: оборудование, стоимость, что включено, правила)
- Магазин автохимии (рекомендации, скидки, ссылки на Ozon и сайт)
- Комфорт в студии (кофе, Wi-Fi, климат, доступная среда)
- Цены
- Как нас найти
- Наши преимущества
- Приветственный бонус
- Примеры работ
- Скидки
- Новинки и акции (ссылка на Telegram-канал)
- Записаться онлайн (WebApp — YClients открывается внутри Telegram)

### Повышение конверсии
- **Повторное вовлечение**: через 24 часа бездействия бот напоминает клиенту о теме, которой он интересовался, и предлагает записаться
- **Оценка консультации**: через 5 минут молчания бот просит оценить диалог (1–5 звёзд)
- **Персонализация**: бот запоминает тему последнего разговора и подставляет в напоминание

### Кэширование ответов
- Ответы на кнопки меню кэшируются в памяти на 6 часов
- Повторные нажатия одной кнопки разными клиентами — мгновенный ответ, 0 токенов
- Свободный текст от клиентов всегда идёт в GPT
- Админ-команда `/clearcache` для ручного сброса (после обновления базы знаний)

### Аналитика и отчёты
- **Команда `/report`** — генерирует и отправляет отчёт за текущий месяц прямо в Telegram (доступна только админу)
- **Автоотчёт** — 1-го числа каждого месяца в 09:00 МСК бот автоматически отправляет отчёт за прошлый месяц
- **Скрипт `generate_report.py`** — CLI для ручной генерации на сервере

Отчёт включает:
- Текстовую сводку (пользователи, сообщения, расходы в рублях)
- Excel-файл со вкладками: Сводка, По дням, Топ вопросов, Популярные кнопки, Пользователи, Графики
- Расчёт стоимости токенов в рублях (курс настраивается через `USD_RUB_RATE`)

### Соответствие ФЗ-152 «О персональных данных»
- **Согласие при первом использовании**: бот запрашивает согласие на обработку ПД перед началом работы
- **`/privacy`** — политика конфиденциальности (какие данные, зачем, как защищены, права по ст. 14–17)
- **`/deletedata`** — полное удаление данных пользователя из всех CSV и отзыв согласия
- Без согласия бот не обрабатывает сообщения и кнопки

### Надёжность
- **Таймаут OpenAI** — запрос к GPT ограничен 30 секундами; при зависании бот не блокируется, отправляет fallback-ответ
- **Обработка устаревших callback-запросов** — ошибки `query is too old` перехватываются
- **Ротация логов** — файл `bot.log` ротируется при 10 МБ, хранится до 5 копий
- **Автоперезапуск на Railway** — `restartPolicyType = "ON_FAILURE"`, до 10 попыток

## Переменные окружения (.env)

| Переменная | Обязательная | По умолчанию | Описание |
|---|---|---|---|
| `TELEGRAM_BOT_TOKEN` | Да | — | Токен Telegram-бота от @BotFather |
| `OPENAI_API_KEY` | Да | — | API-ключ OpenAI |
| `ADMIN_USER_ID` | Да | `0` | Telegram ID администратора (для /report, /clearcache) |
| `KNOWLEDGE_FILE_PATH` | Нет | `knowledges.txt` | Путь к файлу базы знаний |
| `OPENAI_MODEL` | Нет | `gpt-4o-mini` | Модель OpenAI |
| `MAX_HISTORY` | Нет | `20` | Макс. сообщений в контексте диалога |
| `OPENAI_TIMEOUT` | Нет | `30` | Таймаут запроса к GPT (секунды) |
| `RATING_DELAY` | Нет | `300` | Задержка запроса оценки (секунды, по умолчанию 5 мин) |
| `FOLLOWUP_DELAY` | Нет | `86400` | Задержка напоминания о записи (секунды, по умолчанию 24 часа) |
| `CACHE_TTL` | Нет | `21600` | Время жизни кэша ответов (секунды, по умолчанию 6 часов) |
| `USD_RUB_RATE` | Нет | `90` | Курс доллара для расчёта стоимости токенов |
| `LOG_LEVEL` | Нет | `INFO` | Уровень логирования |

## Команды бота

### Для клиентов
| Команда | Описание |
|---|---|
| `/start` | Главное меню (или запрос согласия при первом визите) |
| `/privacy` | Политика конфиденциальности |
| `/deletedata` | Удалить все свои данные и отозвать согласие |

### Для администратора
| Команда | Описание |
|---|---|
| `/report` | Сгенерировать и получить месячный отчёт |
| `/clearcache` | Очистить кэш ответов на кнопки |

## Хранимые данные клиентов

| Данные | Файл | Удаляются по /deletedata |
|---|---|---|
| Telegram ID | clients.csv, questions.csv, buttons.csv, ratings.csv, consents.csv | Да |
| Текст сообщений | questions.csv | Да |
| Нажатия кнопок | buttons.csv | Да |
| Оценки | ratings.csv | Да |
| Дата/время обращений | все CSV | Да |
| Расход токенов | tokens.csv | Нет (обезличенные) |

## Локальный запуск

```bash
# 1. Создать виртуальное окружение
python -m venv .venv

# 2. Активировать
# Windows:
.venv\Scripts\activate
# Linux/Mac:
source .venv/bin/activate

# 3. Установить зависимости
pip install -r requirements.txt

# 4. Создать .env файл с переменными (см. таблицу выше)

# 5. Запустить
python main.py
```

> При локальном запуске из России требуется VPN для доступа к OpenAI API.

## Деплой на Railway

1. Создать проект на [railway.app](https://railway.app)
2. Подключить Git-репозиторий
3. Добавить переменные окружения в Settings → Variables
4. Деплой происходит автоматически

Конфигурация уже настроена в `railway.toml` и `Procfile`.
На Railway VPN не требуется — серверы за пределами РФ.

## Генерация отчёта вручную

```bash
# Текущий / предыдущий месяц
python generate_report.py

# За конкретный месяц
python generate_report.py 2026-03
```

Файл сохраняется в `reports/report_YYYY-MM.xlsx`.

## Технический стек

- **Python 3.11**
- **python-telegram-bot 22.5** — Telegram Bot API (polling, inline-кнопки, WebApp, job queue)
- **OpenAI API** — GPT-4o-mini для генерации ответов
- **pandas + openpyxl** — формирование Excel-отчётов
- **matplotlib** — графики в отчётах
- **APScheduler** — автоотчёт по расписанию
