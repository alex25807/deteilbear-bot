import logging
import os
import asyncio
import time
import datetime as dt
import re
import difflib
import csv
import unicodedata
from logging.handlers import RotatingFileHandler
from dotenv import load_dotenv
import pathlib

load_dotenv()

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, BotCommand, WebAppInfo
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)
from telegram.error import TimedOut
from telegram.request import HTTPXRequest
import openai

from analytics import (
    log_new_client, log_question, log_token_usage, log_button_click,
    log_rating, generate_monthly_report, generate_text_summary,
    log_consent, has_consent, delete_user_data, log_booking,
)

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
KNOWLEDGE_FILE_PATH = os.getenv("KNOWLEDGE_FILE_PATH", "knowledges.txt")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
MAX_HISTORY = int(os.getenv("MAX_HISTORY", "20"))
ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID", "0"))
BOOKING_MARKER = "[–ó–ê–ü–ò–°–¨]"
OPENAI_TIMEOUT = int(os.getenv("OPENAI_TIMEOUT", "30"))
RATING_DELAY = int(os.getenv("RATING_DELAY", "300"))
FOLLOWUP_DELAY = int(os.getenv("FOLLOWUP_DELAY", "86400"))
CACHE_TTL = int(os.getenv("CACHE_TTL", "21600"))

if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
if not OPENAI_API_KEY:
    raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")

# ================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==================
pathlib.Path("logs").mkdir(parents=True, exist_ok=True)

logger = logging.getLogger(__name__)
logger.setLevel(getattr(logging, LOG_LEVEL))

formatter = logging.Formatter(
    "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)

file_handler = RotatingFileHandler(
    "logs/bot.log",
    maxBytes=10 * 1024 * 1024,
    backupCount=5,
    encoding="utf-8"
)
file_handler.setFormatter(formatter)
logger.addHandler(file_handler)

console_handler = logging.StreamHandler()
console_handler.setFormatter(formatter)
logger.addHandler(console_handler)

logger.propagate = False

# ================== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==================
BOOKING_KEYBOARD = InlineKeyboardMarkup([
    [InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/"))],
    [InlineKeyboardButton("‚úÖ –Ø –∑–∞–ø–∏—Å–∞–ª—Å—è", callback_data="booking_done")],
])

PHONE_LINE = "\n\nüìû –ò–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: +7 (926) 021-60-00"

GREETING_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üîß –£—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤", callback_data="menu_services"),
        InlineKeyboardButton("üöø –°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", callback_data="menu_self"),
    ],
    [
        InlineKeyboardButton("üß¥ –ú–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ—Ö–∏–º–∏–∏", callback_data="menu_shop"),
        InlineKeyboardButton("‚òï –ö–æ–º—Ñ–æ—Ä—Ç –≤ —Å—Ç—É–¥–∏–∏", callback_data="menu_comfort"),
    ],
    [
        InlineKeyboardButton("üí∞ –¶–µ–Ω—ã", callback_data="menu_prices"),
        InlineKeyboardButton("üìç –ö–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏", callback_data="menu_address"),
    ],
    [
        InlineKeyboardButton("üèÜ –ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞", callback_data="menu_advantages"),
        InlineKeyboardButton("üì∏ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç", callback_data="menu_portfolio"),
    ],
    [
        InlineKeyboardButton("üî• –ù–æ–≤–∏–Ω–∫–∏ –∏ –∞–∫—Ü–∏–∏", url="https://t.me/bearlake_detailing"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

WASH_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üöø –ë—ã—Å—Ç—Ä–∞—è –º–æ–π–∫–∞ (–æ—Ç 3 000 ‚ÇΩ)", callback_data="sub_wash_twophase"),
    ],
    [
        InlineKeyboardButton("üßΩ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞ (–æ—Ç 8 000 ‚ÇΩ)", callback_data="sub_wash_complex"),
    ],
    [
        InlineKeyboardButton("üß™ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è (–æ—Ç 6 000 ‚ÇΩ)", callback_data="sub_decon"),
    ],
    [
        InlineKeyboardButton("üõ† –ü–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (–æ—Ç 9 000 ‚ÇΩ)", callback_data="sub_engine_wash"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SERVICES_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üöø –ú–æ–π–∫–∞", callback_data="sub_wash"),
        InlineKeyboardButton("‚ú® –ü–æ–ª–∏—Ä–æ–≤–∫–∞", callback_data="sub_polish"),
    ],
    [
        InlineKeyboardButton("üõ° –ó–∞—â–∏—Ç–∞ –õ–ö–ü", callback_data="sub_protection"),
        InlineKeyboardButton("üßπ –î–µ—Ç–µ–π–ª–∏–Ω–≥ —Å–∞–ª–æ–Ω–∞", callback_data="sub_interior"),
    ],
    [
        InlineKeyboardButton("ü™ü –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–ª–∞", callback_data="sub_glass"),
        InlineKeyboardButton("üîß –†–µ–º–æ–Ω—Ç —Å–∫–æ–ª–æ–≤", callback_data="sub_chips"),
    ],
    [
        InlineKeyboardButton("üß™ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è", callback_data="sub_decon"),
    ],
    [
        InlineKeyboardButton("üí∞ –í—Å–µ —Ü–µ–Ω—ã", callback_data="sub_all_prices"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SELF_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", callback_data="sub_self_equip"),
        InlineKeyboardButton("üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å", callback_data="sub_self_price"),
    ],
    [
        InlineKeyboardButton("üìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ", callback_data="sub_self_included"),
        InlineKeyboardButton("‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞", callback_data="sub_self_rules"),
    ],
    [
        InlineKeyboardButton("üß¥ –ö—É–ø–∏—Ç—å –∞–≤—Ç–æ—Ö–∏–º–∏—é", callback_data="menu_shop"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SHOP_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üß¥ –ß—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ", callback_data="sub_shop_recommend"),
        InlineKeyboardButton("üè∑ –°–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã", callback_data="sub_shop_discounts"),
    ],
    [
        InlineKeyboardButton("üõí –ú–∞–≥–∞–∑–∏–Ω –Ω–∞ Ozon", callback_data="sub_shop_ozon"),
        InlineKeyboardButton("üè™ –°–∞–π—Ç —Å—Ç—É–¥–∏–∏", url="https://bearlake.clients.site/"),
    ],
    [
        InlineKeyboardButton("üõí –û—Ç–∫—Ä—ã—Ç—å Ozon", url="https://ozon.ru/t/bal1Akq"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

COMFORT_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("‚òï –ö–æ—Ñ–µ –∏ –ø–µ—Ä–µ–∫—É—Å—ã", callback_data="sub_comfort_food"),
        InlineKeyboardButton("üì∂ Wi-Fi –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞", callback_data="sub_comfort_wifi"),
    ],
    [
        InlineKeyboardButton("‚ùÑÔ∏è –ö–ª–∏–º–∞—Ç –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏", callback_data="sub_comfort_climate"),
        InlineKeyboardButton("‚ôø –î–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞", callback_data="sub_comfort_access"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SUB_MENUS = {
    "menu_services": SERVICES_KEYBOARD,
    "menu_self": SELF_KEYBOARD,
    "menu_shop": SHOP_KEYBOARD,
    "menu_comfort": COMFORT_KEYBOARD,
    "sub_wash": WASH_KEYBOARD,
}

CONSENT_KEYBOARD = InlineKeyboardMarkup([
    [InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é", callback_data="consent_accept")],
])

RATING_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("1 ‚≠ê", callback_data="rate_1"),
        InlineKeyboardButton("2 ‚≠ê", callback_data="rate_2"),
        InlineKeyboardButton("3 ‚≠ê", callback_data="rate_3"),
        InlineKeyboardButton("4 ‚≠ê", callback_data="rate_4"),
        InlineKeyboardButton("5 ‚≠ê", callback_data="rate_5"),
    ],
])

NO_CONSENT_TEXT = (
    "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ "
    "–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö.\n–ù–∞–∂–º–∏—Ç–µ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
)

PRIVACY_TEXT = (
    "üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\n\n"
    "–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:\n"
    "–°—Ç—É–¥–∏—è BEARLAKE DETAILING & SHOP\n\n"
    "üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
    "‚Ä¢ Telegram ID (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)\n"
    "‚Ä¢ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º\n"
    "‚Ä¢ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏–π\n"
    "‚Ä¢ –ù–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é\n\n"
    "üéØ –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:\n"
    "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º —Å—Ç—É–¥–∏–∏\n"
    "‚Ä¢ –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è\n"
    "‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n\n"
    "üõ° –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:\n"
    "‚Ä¢ –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ\n"
    "‚Ä¢ –î–æ—Å—Ç—É–ø –∏–º–µ—é—Ç —Ç–æ–ª—å–∫–æ —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏\n"
    "‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n\n"
    "‚è± –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è:\n"
    "–î–æ –º–æ–º–µ–Ω—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–º–∏ —á–µ—Ä–µ–∑ /deletedata\n\n"
    "–í–∞—à–∏ –ø—Ä–∞–≤–∞ (—Å—Ç. 14‚Äì17 –§–ó-152):\n"
    "‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö\n"
    "‚Ä¢ –ü–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏—è ‚Äî /deletedata\n"
    "‚Ä¢ –û—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ ‚Äî /deletedata\n\n"
    "üì© –ö–æ–Ω—Ç–∞–∫—Ç –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –ü–î:\n"
    "+7 (926) 021-60-00"
)

TOPIC_LABELS = {
    "menu_services": "—É—Å–ª—É–≥–∞–º–∏ –º–∞—Å—Ç–µ—Ä–æ–≤",
    "menu_self": "–ø–æ—Å—Ç–æ–º —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "menu_prices": "—Ü–µ–Ω–∞–º–∏ –Ω–∞ —É—Å–ª—É–≥–∏",
    "menu_address": "–∞–¥—Ä–µ—Å–æ–º —Å—Ç—É–¥–∏–∏",
    "menu_shop": "–º–∞–≥–∞–∑–∏–Ω–æ–º –∞–≤—Ç–æ—Ö–∏–º–∏–∏",
    "menu_comfort": "—É—Å–ª–æ–≤–∏—è–º–∏ –≤ —Å—Ç—É–¥–∏–∏",
    "sub_wash": "–º–æ–π–∫–æ–π",
    "sub_wash_twophase": "–±—ã—Å—Ç—Ä–æ–π –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–æ–π",
    "sub_wash_complex": "–∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –º–æ–π–∫–æ–π Bearlake",
    "sub_polish": "–ø–æ–ª–∏—Ä–æ–≤–∫–æ–π",
    "sub_protection": "–∑–∞—â–∏—Ç–æ–π –õ–ö–ü",
    "sub_interior": "–¥–µ—Ç–µ–π–ª–∏–Ω–≥–æ–º —Å–∞–ª–æ–Ω–∞",
    "sub_glass": "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç–µ–∫–ª–∞",
    "sub_chips": "—Ä–µ–º–æ–Ω—Ç–æ–º —Å–∫–æ–ª–æ–≤",
    "sub_all_prices": "—Ü–µ–Ω–∞–º–∏ –Ω–∞ —É—Å–ª—É–≥–∏",
    "sub_self_equip": "–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –¥–ª—è —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_self_price": "—Å—Ç–æ–∏–º–æ—Å—Ç—å—é —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_self_included": "—É—Å–ª–æ–≤–∏—è–º–∏ –∞—Ä–µ–Ω–¥—ã –ø–æ—Å—Ç–∞",
    "sub_self_rules": "–ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_shop_recommend": "–∞–≤—Ç–æ—Ö–∏–º–∏–µ–π",
    "sub_shop_ozon": "–º–∞–≥–∞–∑–∏–Ω–æ–º –Ω–∞ Ozon",
    "sub_shop_discounts": "—Å–∫–∏–¥–∫–∞–º–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ",
    "sub_comfort_food": "–ø–µ—Ä–µ–∫—É—Å–∞–º–∏ –≤ —Å—Ç—É–¥–∏–∏",
    "sub_comfort_wifi": "Wi-Fi –∏ –∑–æ–Ω–æ–π –æ—Ç–¥—ã—Ö–∞",
    "sub_comfort_climate": "–∫–ª–∏–º–∞—Ç–æ–º –≤ —Å—Ç—É–¥–∏–∏",
    "sub_comfort_access": "–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Å—Ç—É–¥–∏–∏",
    "menu_advantages": "–Ω–∞—à–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏",
    "menu_portfolio": "–ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ä–∞–±–æ—Ç",
}

MENU_PROMPTS = {
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    "menu_services": "–ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ?",
    "menu_self": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –ø–æ—Å—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è ‚Äî —É—Å–ª–æ–≤–∏—è, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Ü–µ–Ω—ã",
    "menu_prices": "–ö–∞–∫–∏–µ —É –≤–∞—Å —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏?",
    "menu_address": "–ö–∞–∫–æ–π —É –≤–∞—Å –∞–¥—Ä–µ—Å –∏ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã?",
    "menu_shop": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ—Ö–∏–º–∏–∏ –∏ –∞–≤—Ç–æ–∫–æ—Å–º–µ—Ç–∏–∫–∏. –ì–¥–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å? –ö–∞–∫–∏–µ –±—Ä–µ–Ω–¥—ã?",
    "menu_comfort": "–ö–∞–∫–∏–µ —É –≤–∞—Å —É—Å–ª–æ–≤–∏—è –≤ —Å—Ç—É–¥–∏–∏? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∫–æ–º—Ñ–æ—Ä—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤",
    "menu_portfolio": "–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤–∞—à–∏—Ö —Ä–∞–±–æ—Ç? –ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã",
    # –ü–æ–¥–º–µ–Ω—é: —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤
    "sub_wash": "–ö–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –º–æ–π–∫–∏ –∏ –æ—á–∏—Å—Ç–∫–∏ –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –±—ã—Å—Ç—Ä—É—é, –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –º–æ–π–∫—É, –¥–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—é –∏ –º–æ–π–∫—É –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.",
    "sub_wash_twophase": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –±—ã—Å—Ç—Ä—É—é –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫—É ‚Äî —á—Ç–æ –≤—Ö–æ–¥–∏—Ç, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏?",
    "sub_wash_complex": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –î–µ—Ç–µ–π–ª–∏–Ω–≥ –º–æ–π–∫—É Bearlake ‚Äî —á—Ç–æ –≤—Ö–æ–¥–∏—Ç, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏?",
    "sub_polish": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–ª–∏—Ä–æ–≤–∫–∞ –∏ —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ?",
    "sub_protection": "–ö–∞–∫–∏–µ –∑–∞—â–∏—Ç–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ? –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∑–∞—â–∏—Ç–∞ –õ–ö–ü?",
    "sub_interior": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –¥–µ—Ç–µ–π–ª–∏–Ω–≥ —Å–∞–ª–æ–Ω–∞",
    "sub_glass": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞?",
    "sub_chips": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–µ–º–æ–Ω—Ç —Å–∫–æ–ª–æ–≤ –∏ —Ç—Ä–µ—â–∏–Ω –Ω–∞ —Å—Ç–µ–∫–ª–µ?",
    "sub_all_prices": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –≤—Å–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å—Ç—É–¥–∏–∏",
    # –ü–æ–¥–º–µ–Ω—é: —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
    "sub_self_equip": "–ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—Å—Ç—å –Ω–∞ –ø–æ—Å—Ç—É —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è?",
    "sub_self_price": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∞—Ä–µ–Ω–¥–∞ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è? –ö–∞–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã?",
    "sub_self_included": "–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –∞—Ä–µ–Ω–¥—É –ø–æ—Å—Ç–∞? –ù—É–∂–Ω–æ –ª–∏ –±—Ä–∞—Ç—å —á—Ç–æ-—Ç–æ —Å —Å–æ–±–æ–π?",
    "sub_self_rules": "–ö–∞–∫–∏–µ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –ø–æ—Å—Ç—É? –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–π—Ç–∏ –±–µ–∑ –∑–∞–ø–∏—Å–∏? –ú–æ–∂–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–¥–≤–æ—ë–º?",
    # –ü–æ–¥–º–µ–Ω—é: –º–∞–≥–∞–∑–∏–Ω
    "sub_shop_recommend": "–ö–∞–∫—É—é –∞–≤—Ç–æ—Ö–∏–º–∏—é –∏ –∞–≤—Ç–æ–∫–æ—Å–º–µ—Ç–∏–∫—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ? –ö–∞–∫–∏–µ –±—Ä–µ–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?",
    "sub_shop_ozon": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω –Ω–∞ Ozon –∏ –±—Ä–µ–Ω–¥—ã –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ.",
    "sub_shop_discounts": "–ö–∞–∫–∏–µ —Å–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã –¥–µ–π—Å—Ç–≤—É—é—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ?",
    # –ü–æ–¥–º–µ–Ω—é: –∫–æ–º—Ñ–æ—Ä—Ç
    "sub_comfort_food": "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –∫–æ—Ñ–µ, —á–∞–π, –ø–µ—Ä–µ–∫—É—Å—ã? –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–µ—Å—Ç—å –≤ —Å—Ç—É–¥–∏–∏?",
    "sub_comfort_wifi": "–ï—Å—Ç—å –ª–∏ Wi-Fi? –ï—Å—Ç—å –ª–∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞? –ú–æ–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –≤–µ—â–∏?",
    "sub_comfort_climate": "–ï—Å—Ç—å –ª–∏ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ? –ï—Å—Ç—å –ª–∏ —Ç—É–∞–ª–µ—Ç?",
    "sub_comfort_access": "–ï—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–∏—è –¥–ª—è –º–∞–ª–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?",
}

MASTER_SERVICE_PRICE_NOTE = (
    "\n\n*–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ (S / M / L) "
    "–∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞.*"
)

STATIC_MENU_ANSWERS = {
    "menu_services": (
        "–í —Å—Ç—É–¥–∏–∏ BEARLAKE –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —É—Ö–æ–¥–∞ ‚Äî –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π –º–æ–π–∫–∏ –¥–æ –≥–ª—É–±–æ–∫–æ–π –∑–∞—â–∏—Ç—ã –∫—É–∑–æ–≤–∞ –∏ —Å–∞–ª–æ–Ω–∞.\n\n"
        "–£—Å–ª—É–≥–∏:\n"
        "‚Ä¢ –°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ 24/7 (–ø–æ—á–∞—Å–æ–≤–∞—è –∞—Ä–µ–Ω–¥–∞)\n"
        "‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ ‚Äî –æ—Ç 3 000 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞\n"
        "‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ Bearlake ‚Äî –æ—Ç 8 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –ü–æ–ª–∏—Ä–æ–≤–∫–∞ –õ–ö–ü (Light Polish) ‚Äî –æ—Ç 25 000 ‚ÇΩ, –æ—Ç 12 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –ù–∞–Ω–µ—Å–µ–Ω–∏–µ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫—Ä—ã—Ç–∏–π ‚Äî –æ—Ç 5 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –î–µ—Ç–µ–π–ª–∏–Ω–≥ —á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ ‚Äî –æ—Ç 28 000 ‚ÇΩ, 1 –¥–µ–Ω—å\n"
        "‚Ä¢ –ó–∞—â–∏—Ç–Ω—ã–µ –ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω–æ–≤—ã–µ –ø–ª–µ–Ω–∫–∏ (–∑–æ–Ω—ã —Ä–∏—Å–∫–∞/–∫—É–∑–æ–≤) ‚Äî –æ—Ç 85 000 ‚ÇΩ, –æ—Ç 2 –¥–Ω–µ–π\n"
        "‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 30 000 ‚ÇΩ, –æ—Ç 1 –¥–Ω—è\n"
        "‚Ä¢ –†–µ–º–æ–Ω—Ç —Ç—Ä–µ—â–∏–Ω –∏ —Å–∫–æ–ª–æ–≤ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 3 500 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞\n"
        "‚Ä¢ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è –õ–ö–ü (–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –≤–∫—Ä–∞–ø–ª–µ–Ω–∏—è –∏ –±–∏—Ç—É–º) ‚Äî –æ—Ç 6 000 ‚ÇΩ, –æ—Ç 2 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –ú–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ ‚Äî –æ—Ç 9 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤\n\n"
        "*–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ (–∫—Ä–æ–º–µ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è) –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ (S / M / L) "
        "–∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞.*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É —Å–æ—Å—Ç–∞–≤ —É—Å–ª—É–≥–∏, —Å—Ä–æ–∫–∏ –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ‚¨áÔ∏è"
    ),
    "menu_self": (
        "–°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ 24/7 –≤ BEARLAKE ‚Äî —ç—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—É–¥–∏—è –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ —É—Ö–æ–¥–∞ –∑–∞ –∞–≤—Ç–æ –≤ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.\n\n"
        "–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç–µ:\n"
        "‚Ä¢ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ YClients\n"
        "‚Ä¢ –∫–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø—Ä–∏—Ç–æ—á–Ω–æ-–≤—ã—Ç—è–∂–Ω—É—é –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—é\n"
        "‚Ä¢ –ê–í–î, –≥–æ—Ä—è—á—É—é –≤–æ–¥—É, –º–æ—â–Ω—ã–π –ø—ã–ª–µ—Å–æ—Å, —Ç—É—Ä–±–æ—Å—É—à–∫—É\n"
        "‚Ä¢ –≤–µ–¥—Ä–∞, –ø–µ–Ω–æ–∫–æ–º–ø–ª–µ–∫—Ç—ã –∏ —à–∏—Ä–æ–∫–∏–π –Ω–∞–±–æ—Ä –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤\n"
        "‚Ä¢ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—â–µ–π –∏ –æ—Ç–¥—ã—Ö–∞\n"
        "‚Ä¢ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤–¥–≤–æ–µ–º\n\n"
        "–¢–∞—Ä–∏—Ñ—ã:\n"
        "‚Ä¢ 700 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ 900 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ + —à–∞–º–ø—É–Ω—å –¥–ª—è 1/2 —Ñ–∞–∑—ã, –≥—É–±–∫–∞ –∏ –º–∏–∫—Ä–æ—Ñ–∏–±—Ä–∞\n"
        "–ú–∏–Ω–∏–º—É–º ‚Äî 2 —á–∞—Å–∞. –ú–∞–∫—Å–∏–º—É–º –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é –º–æ–∂–Ω–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π).\n\n"
        "–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø–æ—Å—Ç—É —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å "
        "—Ç–µ –∂–µ —ç—Ç–∞–ø—ã —É—Ö–æ–¥–∞, —á—Ç–æ –∏ –º–∞—Å—Ç–µ—Ä–∞: –º–æ–π–∫–∞, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –ø–æ–ª–∏—Ä–æ–≤–∫–∞, –Ω–∞–Ω–µ—Å–µ–Ω–∏–µ –∑–∞—â–∏—Ç–Ω—ã—Ö "
        "—Å–æ—Å—Ç–∞–≤–æ–≤ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞ —Å–∞–ª–æ–Ω–∞.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∏–∂–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É –¥–µ—Ç–∞–ª–∏ –∏ —É—Å–ª–æ–≤–∏—è ‚¨áÔ∏è"
    ),
    "menu_shop": (
        "–í –º–∞–≥–∞–∑–∏–Ω–µ —Å–æ–±—Ä–∞–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∞–≤—Ç–æ—Ö–∏–º–∏—é, –∫–æ—Ç–æ—Ä–æ–π —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Å—Ç—É–¥–∏–∏.\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ ‚Äî –ø–æ–¥—Å–∫–∞–∂—É, —á—Ç–æ –ª—É—á—à–µ –ø–æ–¥ –í–∞—à—É –∑–∞–¥–∞—á—É ‚¨áÔ∏è"
    ),
    "menu_comfort": (
        "–ü–æ–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ —Ä–∞–±–æ—Ç–µ, –í—ã –æ—Ç–¥—ã—Ö–∞–µ—Ç–µ –≤ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∑–æ–Ω–µ:\n"
        "‚Ä¢ –∫–æ—Ñ–µ/—á–∞–π –∏ –ª—ë–≥–∫–∏–µ –ø–µ—Ä–µ–∫—É—Å—ã\n"
        "‚Ä¢ Wi-Fi –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞\n"
        "‚Ä¢ —Å–∞–Ω—É–∑–µ–ª –∏ –º–µ—Å—Ç–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—â–µ–π\n"
        "‚Ä¢ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ –¥–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –ø—É–Ω–∫—Ç –Ω–∏–∂–µ ‚¨áÔ∏è"
    ),
    "menu_address": (
        "–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥.–æ. –ü—É—à–∫–∏–Ω—Å–∫–∏–π, –ø–æ—Å. –ù–∞–≥–æ—Ä–Ω–æ–µ, 8–ê.\n"
        "–°—Ç—É–¥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –ø–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏.\n"
        "–†—è–¥–æ–º –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞.\n\n"
        "–Ø–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç—ã: https://yandex.ru/maps/org/bearlake/46971604224/?ll=38.023081%2C56.067485&z=17"
    ),
    "menu_portfolio": (
        "–•–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ¬´–¥–æ/–ø–æ—Å–ª–µ¬ª? –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã:\n"
        "‚Ä¢ –Ω–∞ —Å–∞–π—Ç–µ —Å—Ç—É–¥–∏–∏\n"
        "‚Ä¢ –≤ Telegram-–∫–∞–Ω–∞–ª–µ"
        "\n\n–°–∞–π—Ç: https://bearlake.clients.site/\n"
        "Telegram: https://t.me/bearlake_detailing"
    ),
    "menu_discounts": (
        "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤—ã–≥–æ–¥—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤:\n"
        "‚Ä¢ –í –æ—Ñ–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω–µ ‚Äî 5% –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n"
        "‚Ä¢ –ù–∞ Ozon –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–∫–∞–∑–µ (–ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥–∏) ‚Äî 5% –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É BEARLAKE\n\n"
        "–ê–∫—Ü–∏–∏ –ø—É–±–ª–∏–∫—É–µ–º –≤ Telegram-–∫–∞–Ω–∞–ª–µ: https://t.me/bearlake_detailing"
    ),
    "sub_wash": (
        "–ü–æ –º–æ–π–∫–µ –∏ –æ—á–∏—Å—Ç–∫–µ –µ—Å—Ç—å 4 —Ñ–æ—Ä–º–∞—Ç–∞:\n"
        "‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —É—Ö–æ–¥ (–æ—Ç 3 000 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞)\n"
        "‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ Bearlake ‚Äî –≥–ª—É–±–æ–∫–∏–π —É—Ö–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∏ —Å–Ω–∞—Ä—É–∂–∏ (–æ—Ç 8 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤)\n"
        "‚Ä¢ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è –õ–ö–ü ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –±–∏—Ç—É–º–∞ –∏ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫—Ä–∞–ø–ª–µ–Ω–∏–π (–æ—Ç 6 000 ‚ÇΩ, –æ—Ç 2 —á–∞—Å–æ–≤)\n\n"
        "‚Ä¢ –ú–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ ‚Äî –¥–µ–ª–∏–∫–∞—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–æ—Ç 9 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤)\n\n"
        "–î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è ‚Äî —ç—Ç–æ —ç—Ç–∞–ø –≥–ª—É–±–æ–∫–æ–π —Ö–∏–º–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –õ–ö–ü –æ—Ç —Å—Ç–æ–π–∫–∏—Ö –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π,\n"
        "–∫–æ—Ç–æ—Ä—ã–µ –æ–±—ã—á–Ω–∞—è –º–æ–π–∫–∞ –Ω–µ —É–±–∏—Ä–∞–µ—Ç –∏ –∫–æ—Ç–æ—Ä—ã–µ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –º–æ–≥—É—Ç –≤—Ä–µ–¥–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏—é.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∏–∂–µ ‚Äî –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂—É, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –∏ –∫–æ–≥–¥–∞ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ ‚¨áÔ∏è"
    ),
    "sub_wash_twophase": (
        "–ë—ã—Å—Ç—Ä–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ ‚Äî –æ—Ç 3 000 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞.\n"
        "–ò–¥–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –ø–æ—Ä—è–¥–æ–∫ –±–µ–∑ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É.\n\n"
        "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç:\n"
        "‚Ä¢ –±–µ—Ä–µ–∂–Ω–∞—è –¥–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –º–æ–π–∫–∞ –∫—É–∑–æ–≤–∞\n"
        "‚Ä¢ –º–æ–π–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ—Ä–æ–≥–æ–≤\n"
        "‚Ä¢ –º–æ–π–∫–∞/–ø—ã–ª–µ—Å–æ—Å –∫–æ–≤—Ä–∏–∫–æ–≤\n"
        "‚Ä¢ –ø—Ä–æ–¥—É–≤–∫–∞ –∑–∞–º–∫–æ–≤\n\n"
        "–†–µ–∑—É–ª—å—Ç–∞—Ç: —á–∏—Å—Ç—ã–π –∏ —Å–≤–µ–∂–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –õ–ö–ü."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_wash_complex": (
        "–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ Bearlake ‚Äî –æ—Ç 8 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤.\n"
        "–í–∫–ª—é—á–∞–µ—Ç:\n"
        "‚Ä¢ –±–µ—Ä–µ–∂–Ω—É—é 2-—Ñ–∞–∑–Ω—É—é –º–æ–π–∫—É –∫—É–∑–æ–≤–∞ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ—Ä–æ–≥–æ–≤\n"
        "‚Ä¢ —á–∏—Å—Ç–∫—É —Ç—Ä—É–¥–Ω–æ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç –∫–∏—Å—Ç—è–º–∏\n"
        "‚Ä¢ —Ç—â–∞—Ç–µ–ª—å–Ω—É—é —á–∏—Å—Ç–∫—É –¥–∏—Å–∫–æ–≤ –∏ —à–∏–Ω —Å –ø—Ä–æ–ø–∏—Ç–∫–æ–π —Ä–µ–∑–∏–Ω—ã\n"
        "‚Ä¢ –ø–æ–ª–Ω—É—é –ø—Ä–æ–¥—É–≤–∫—É –∫—É–∑–æ–≤–∞ –≥–æ—Ä—è—á–∏–º –≤–æ–∑–¥—É—Ö–æ–º\n"
        "‚Ä¢ –æ—á–∏—Å—Ç–∫—É —Å—Ç–µ–∫–æ–ª —Å–Ω–∞—Ä—É–∂–∏ –∏ –≤–Ω—É—Ç—Ä–∏\n"
        "‚Ä¢ —É–±–æ—Ä–∫—É —Å–∞–ª–æ–Ω–∞ –∏ –±–∞–≥–∞–∂–Ω–∏–∫–∞ –ø—ã–ª–µ—Å–æ—Å–æ–º\n"
        "‚Ä¢ –≥–ª—É–±–æ–∫—É—é —á–∏—Å—Ç–∫—É —Å–∞–ª–æ–Ω–Ω—ã—Ö –∫–æ–≤—Ä–æ–≤\n"
        "‚Ä¢ –¥–µ–ª–∏–∫–∞—Ç–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ü–∏–µ–π\n"
        "‚Ä¢ –æ–±—Ä–∞–±–æ—Ç–∫—É –õ–ö–ü –∏ –¥–∏—Å–∫–æ–≤ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–º –∫–≤–∏–∫-–¥–µ—Ç–µ–π–ª–µ—Ä–æ–º\n\n"
        "–≠—Ç–æ —Ñ–æ—Ä–º–∞—Ç ¬´–≤—Å—ë –∏ —Å—Ä–∞–∑—É¬ª, –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–Ω—É—Ç—Ä–∏ –∏ —Å–Ω–∞—Ä—É–∂–∏.\n"
        "–ü—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è—Ö –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –¥–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_polish": (
        "–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –õ–ö–ü (Light Polish) ‚Äî –æ—Ç 25 000 ‚ÇΩ, –æ—Ç 12 —á–∞—Å–æ–≤.\n"
        "–ü–µ—Ä–µ–¥ —É—Å–ª—É–≥–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –±—ã—Å—Ç—Ä–∞—è –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞.\n"
        "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç:\n"
        "‚Ä¢ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞\n"
        "‚Ä¢ –±–µ—Ä–µ–∂–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –õ–ö–ü\n"
        "‚Ä¢ —É–¥–∞–ª–µ–Ω–∏–µ –¥–æ 50% —Ü–∞—Ä–∞–ø–∏–Ω\n"
        "‚Ä¢ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–µ—Å–∫–∞ –∏ –≥–ª–∞–¥–∫–æ—Å—Ç–∏\n"
        "‚Ä¢ –∑–∞—â–∏—Ç–∞ –õ–ö–ü –Ω–∞ 3‚Äì4 –º–µ—Å—è—Ü–∞ (—Ñ–∏–Ω–∏—à–Ω—ã–π —Å–∏–ª–∞–Ω—Ç)\n\n"
        "–†–∞–±–æ—Ç–∞–µ–º –ø–æ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å —Ö–∏–º–∏–µ–π Optimum Polymer Technologies –∏ NXTZEN, "
        "–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä—É–≥–∏ Lake Country –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ Zentool / LC Power Tools / FLEX.\n"
        "–†–µ–∑—É–ª—å—Ç–∞—Ç: –≥–ª—É–±–æ–∫–∏–π –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –±–ª–µ—Å–∫ –∏ –∑–∞–º–µ—Ç–Ω–æ –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_protection": (
        "–ü–æ –∑–∞—â–∏—Ç–µ –õ–ö–ü –¥–æ—Å—Ç—É–ø–Ω—ã:\n"
        "‚Ä¢ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è ‚Äî –æ—Ç 5 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω–æ–≤—ã–µ –ø–ª–µ–Ω–∫–∏ (–∑–æ–Ω—ã —Ä–∏—Å–∫–∞/–∫—É–∑–æ–≤) ‚Äî –æ—Ç 85 000 ‚ÇΩ, –æ—Ç 2 –¥–Ω–µ–π\n\n"
        "–ö–µ—Ä–∞–º–∏–∫–∞ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –∑–∞–¥–∞—á–∞–º –∏ —Å—Ä–æ–∫—É —Å–ª—É–∂–±—ã: –ª–µ–≥–∫–∏–µ —Å–æ—Å—Ç–∞–≤—ã (3‚Äì12 –º–µ—Å—è—Ü–µ–≤) "
        "–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è (2‚Äì3 –≥–æ–¥–∞).\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã, –≤ —Ç–æ–º —á–∏—Å–ª–µ, NXTZEN Graphene Serum, NXTZEN Elite GSO2 –∏ Opti-Coat Pro Plus.\n"
        "–ü–æ –ø–ª–µ–Ω–∫–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã NXTZEN / SKINCARS / Crystal Ultra Gloss ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–æ–ª–æ–≤, "
        "—Ü–∞—Ä–∞–ø–∏–Ω, –ø–µ—Å–∫–æ—Å—Ç—Ä—É—è –∏ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_decon": (
        "–î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è –õ–ö–ü ‚Äî –æ—Ç 6 000 ‚ÇΩ, –æ—Ç 2 —á–∞—Å–æ–≤.\n"
        "–ü–µ—Ä–µ–¥ —É—Å–ª—É–≥–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –±—ã—Å—Ç—Ä–∞—è –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞.\n"
        "–£–¥–∞–ª—è–µ–º –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –≤–∫—Ä–∞–ø–ª–µ–Ω–∏—è, –±–∏—Ç—É–º, —Å–º–æ–ª—ã –∏ —Å—Ç–æ–π–∫–∏–µ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è.\n"
        "–†–∞–±–æ—Ç–∞–µ–º –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π —Ö–∏–º–∏–µ–π Optimum Polymer Technologies, NXTZEN –∏ TAC System.\n"
        "–†–µ–∑—É–ª—å—Ç–∞—Ç: –≥–ª–∞–¥–∫–æ–µ –∏ —á–∏—Å—Ç–æ–µ –õ–ö–ü, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∫–æ—Ä—Ä–æ–∑–∏–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–ª–µ–¥—É—é—â–∏–º —ç—Ç–∞–ø–∞–º —É—Ö–æ–¥–∞."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_engine_wash": (
        "–ú–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ ‚Äî –æ—Ç 9 000 ‚ÇΩ, –æ—Ç 4 —á–∞—Å–æ–≤.\n"
        "–ß—Ç–æ –¥–µ–ª–∞–µ–º: –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, "
        "–¥–µ–ª–∏–∫–∞—Ç–Ω–∞—è –º–æ–π–∫–∞, –ø–æ–ª–Ω–∞—è –ø—Ä–æ–¥—É–≤–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—â–∏—Ç–Ω—ã–º –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–æ–º.\n"
        "–†–µ–∑—É–ª—å—Ç–∞—Ç: —á–∏—Å—Ç–æ–µ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "
        "–∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ —É–∑–ª–æ–≤."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_interior": (
        "–î–µ—Ç–µ–π–ª–∏–Ω–≥ —á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ (—Ö–∏–º—á–∏—Å—Ç–∫–∞) ‚Äî –æ—Ç 28 000 ‚ÇΩ, 1 –¥–µ–Ω—å.\n"
        "–ü–µ—Ä–µ–¥ —Ö–∏–º—á–∏—Å—Ç–∫–æ–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–æ–π–∫–∞.\n"
        "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç:\n"
        "‚Ä¢ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π –∏ –ø—ã–ª–∏ —Å–æ –≤—Å–µ—Ö –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π\n"
        "‚Ä¢ –≥–ª—É–±–æ–∫–∞—è —á–∏—Å—Ç–∫–∞ –∫–∞—Ä–ø–µ—Ç–∞ —Å–∞–ª–æ–Ω–∞ –∏ –±–∞–≥–∞–∂–Ω–∏–∫–∞\n"
        "‚Ä¢ –æ—á–∏—Å—Ç–∫–∞ —Å–∏–¥–µ–Ω–∏–π, –¥–≤–µ—Ä–Ω—ã—Ö –∫–∞—Ä—Ç, –ø–∞–Ω–µ–ª–∏ –∏ –¥–µ—Ñ–ª–µ–∫—Ç–æ—Ä–æ–≤\n"
        "‚Ä¢ —á–∏—Å—Ç–∫–∞ —Å—Ç–µ–∫–æ–ª –∏–∑–Ω—É—Ç—Ä–∏ –∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä—É–¥–Ω–æ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç\n\n"
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –Ω–∞–Ω–µ—Å—Ç–∏ –∑–∞—â–∏—Ç—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞:\n"
        "‚Ä¢ NXTZEN L-Coat (1‚Äì2 –≥–æ–¥–∞)\n"
        "‚Ä¢ Opti-Guard Leather (1‚Äì2 –≥–æ–¥–∞)\n"
        "‚Ä¢ NXTZEN Fiber Coat (6‚Äì9 –º–µ—Å—è—Ü–µ–≤)\n\n"
        "–†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–≤–µ–∂–∏–π –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Å–∞–ª–æ–Ω, –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –º–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç –∏ –∑–∞—â–∏—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ç –∏–∑–Ω–æ—Å–∞."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_glass": (
        "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 30 000 ‚ÇΩ, –æ—Ç 1 –¥–Ω—è.\n"
        "–í–∏–¥—ã –ø–ª–µ–Ω–æ–∫: Rayno Crystal Shield, Never Scratch.\n"
        "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç: —Ç—â–∞—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞/–æ–±–µ–∑–∂–∏—Ä–∏–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞.\n"
        "–ü–ª–µ–Ω–∫–∞ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–∫–æ–ª–æ–≤, —Ç—Ä–µ—â–∏–Ω, –ø–µ—Å–∫–æ—Å—Ç—Ä—É—è –∏ —Ü–∞—Ä–∞–ø–∏–Ω, "
        "–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –∏ –Ω–µ –∏—Å–∫–∞–∂–∞–µ—Ç –æ–±–∑–æ—Ä."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_chips": (
        "–†–µ–º–æ–Ω—Ç —Ç—Ä–µ—â–∏–Ω –∏ —Å–∫–æ–ª–æ–≤ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 3 500 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞.\n"
        "–ó–∞–¥–∞—á–∞ —É—Å–ª—É–≥–∏ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ —Å—Ç–µ–∫–ª–∞ –∏ "
        "—Å–¥–µ–ª–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç –º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º."
        + MASTER_SERVICE_PRICE_NOTE
    ),
    "sub_self_equip": (
        "–ù–∞ –ø–æ—Å—Ç—É —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –µ—Å—Ç—å –≤—Å—ë –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —É—Ö–æ–¥–∞ —Å–≤–æ–∏–º–∏ —Ä—É–∫–∞–º–∏:\n"
        "‚Ä¢ –ê–í–î –∏ —à–ª–∞–Ω–≥ –¥–ª—è –ø—Ä–æ–º—ã–≤–∫–∏\n"
        "‚Ä¢ –≥–æ—Ä—è—á–∞—è –≤–æ–¥–∞\n"
        "‚Ä¢ –º–æ—â–Ω—ã–π –ø—ã–ª–µ—Å–æ—Å\n"
        "‚Ä¢ —Ç—É—Ä–±–æ—Å—É—à–∫–∞\n"
        "‚Ä¢ –≤–µ–¥—Ä–∞ –∏ –ø–µ–Ω–æ–∫–æ–º–ø–ª–µ–∫—Ç—ã\n"
        "‚Ä¢ —à–∏—Ä–æ–∫–∏–π –Ω–∞–±–æ—Ä –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ (–∫–∏—Å—Ç–∏, –≤–∞—Ä–µ–∂–∫–∏, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —à–∏–Ω/–¥–∏—Å–∫–æ–≤/–∞—Ä–æ–∫)\n"
        "‚Ä¢ –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—â–µ–π –∏ –æ—Ç–¥—ã—Ö–∞."
    ),
    "sub_self_price": (
        "–¢–∞—Ä–∏—Ñ—ã:\n"
        "‚Ä¢ 700 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å + –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ 900 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å + –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ + —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏\n"
        "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî 2 —á–∞—Å–∞.\n"
        "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ: –º–æ–∂–Ω–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é.\n"
        "–û–ø–ª–∞—Ç–∞: –Ω–∞–ª–∏—á–Ω—ã–º–∏, –∫–∞—Ä—Ç–æ–π –∏–ª–∏ –æ–Ω–ª–∞–π–Ω."
    ),
    "sub_self_included": (
        "–í —Ç–∞—Ä–∏—Ñ 900 ‚ÇΩ/—á–∞—Å –≤—Ö–æ–¥—è—Ç: —à–∞–º–ø—É–Ω—å –¥–ª—è 1 –∏ 2 —Ñ–∞–∑—ã, –≥—É–±–∫–∞ –∏ –º–∏–∫—Ä–æ—Ñ–∏–±—Ä–æ–≤–æ–µ –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ. "
        "–í —Ç–∞—Ä–∏—Ñ 700 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.\n"
        "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—é —Ö–∏–º–∏—é."
    ),
    "sub_self_rules": (
        "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞–ø–∏—Å—å –∑–∞—Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ YClients.\n"
        "–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ –Ω–∞ –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤, –≤ —Ç–æ–º —á–∏—Å–ª–µ –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–ø–æ—Å—É—Ç–æ—á–Ω–æ/–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π) –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é.\n"
        "–ú–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–¥–≤–æ–µ–º.\n"
        "–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–µ –∂–µ —ç—Ç–∞–ø—ã —É—Ö–æ–¥–∞, "
        "—á—Ç–æ –∏ –º–∞—Å—Ç–µ—Ä–∞, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ —Å—Ç—É–¥–∏–∏ –∏ —Ç–µ—Ö–Ω–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.\n"
        "–ü–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ ‚Äî –ø–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–º—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é —Å 9:00 –¥–æ 22:00.\n"
        "–ó–∞–ø—Ä–µ—â–µ–Ω—ã –≥—Ä—è–∑–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∂–∏–¥–∫–æ—Å—Ç–∏."
    ),
    "sub_comfort_food": "–í —Å—Ç—É–¥–∏–∏ –µ—Å—Ç—å –∫–æ—Ñ–µ, —á–∞–π, –ª—ë–≥–∫–∏–µ –ø–µ—Ä–µ–∫—É—Å—ã –∏ —Ñ—Ä—É–∫—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.",
    "sub_comfort_wifi": "–î–∞, –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Wi-Fi –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞.",
    "sub_comfort_climate": "–î–∞, –µ—Å—Ç—å –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∞–Ω—É–∑–µ–ª.",
    "sub_comfort_access": "–î–∞, –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –¥–ª—è –º–∞–ª–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.",
    "direct_booking": "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è [–ó–ê–ü–ò–°–¨]",
}

TEXT_INTENT_RULES: list[tuple[tuple[str, ...], str]] = [
    (("—Ü–µ–Ω—ã", "–ø—Ä–∞–π—Å", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Å—Ç–æ–∏–º–æ—Å—Ç—å"), "menu_prices"),
    (("–∞–¥—Ä–µ—Å", "–∫–∞–∫ –Ω–∞–π—Ç–∏", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è", "–≥–¥–µ –≤—ã", "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å"), "menu_address"),
    (("–≥—Ä–∞—Ñ–∏–∫", "—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã", "—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã"), "menu_address"),
    (("—Å–∞–º–æ–æ–±—Å–ª—É–∂", "–ø–æ—Å—Ç", "–∞—Ä–µ–Ω–¥–∞ –±–æ–∫—Å–∞"), "menu_self"),
    (("–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω", "–∞–≤–¥", "–ø—ã–ª–µ—Å–æ—Å", "—Ç—É—Ä–±–æ—Å—É—à"), "sub_self_equip"),
    (("700", "900", "—Ç–∞—Ä–∏—Ñ", "—Ä–∞—Å—Ö–æ–¥–Ω–∏–∫", "–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"), "sub_self_price"),
    (("–º–æ–π–∫–∞", "–¥–≤—É—Ö—Ñ–∞–∑", "–∫–æ–º–ø–ª–µ–∫—Å–Ω"), "sub_wash"),
    (("–ø–æ–ª–∏—Ä–æ–≤", "light polish"), "sub_polish"),
    (("–∫–µ—Ä–∞–º–∏–∫", "–ø–ª–µ–Ω–∫", "ppf", "–∑–∞—â–∏—Ç"), "sub_protection"),
    (("–¥–µ–∫–æ–Ω—Ç–∞–º", "–±–∏—Ç—É–º", "–≤–∫—Ä–∞–ø–ª–µ–Ω"), "sub_decon"),
    (("–ø–æ–¥–∫–∞–ø–æ—Ç", "–¥–≤–∏–≥–∞—Ç–µ–ª"), "sub_engine_wash"),
    (("—Å–∞–ª–æ–Ω", "—Ö–∏–º—á–∏—Å—Ç", "–∏–Ω—Ç–µ—Ä—å–µ—Ä"), "sub_interior"),
    (("–ª–æ–±–æ–≤", "—Å—Ç–µ–∫–ª", "–±—Ä–æ–Ω–∏—Ä"), "sub_glass"),
    (("–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–Ω–∞ –¥–µ–Ω—å", "–Ω–∞ —Å—É—Ç–∫–∏", "–¥–ª–∏—Ç–µ–ª—å–Ω", "–∞—Ä–µ–Ω–¥"), "sub_self_rules"),
    (("—Å–∫–æ–ª", "—Ç—Ä–µ—â–∏–Ω"), "sub_chips"),
    (("–º–∞–≥–∞–∑–∏–Ω", "–∞–≤—Ç–æ—Ö–∏–º", "ozon"), "menu_shop"),
    (("—Å–∫–∏–¥–∫", "–ø—Ä–æ–º–æ–∫–æ–¥", "–∞–∫—Ü–∏"), "sub_shop_discounts"),
    (("–∫–æ—Ñ–µ", "—á–∞–π", "wifi", "–≤–∞–π—Ñ–∞–π", "–∫–æ–º—Ñ–æ—Ä—Ç", "–æ—Ç–¥—ã—Ö"), "menu_comfort"),
    (("–ø—Ä–∏–º–µ—Ä—ã", "–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ", "—Ä–∞–±–æ—Ç"), "menu_portfolio"),
    (("–ø—Ä–µ–∏–º—É—â", "–ø–æ—á–µ–º—É –≤—ã", "—á–µ–º –ª—É—á—à–µ"), "menu_advantages"),
]


PRIORITY_TEXT_INTENT_RULES: list[tuple[tuple[str, ...], str]] = [
    # –ñ–µ—Å—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∑–∞–ø–∏—Å—å
    (("–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—Å—å", "yclients", "—é–∫–ª–∏–µ–Ω—Ç—Å"), "direct_booking"),
    # –ñ–µ—Å—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ü–µ–Ω—ã
    (("—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–∫–∞–∫–∞—è —Ü–µ–Ω–∞", "—Ü–µ–Ω—ã", "–ø—Ä–∞–π—Å", "—Å—Ç–æ–∏–º–æ—Å—Ç—å"), "menu_prices"),
    # –ñ–µ—Å—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∞–¥—Ä–µ—Å/–≥—Ä–∞—Ñ–∏–∫
    (("–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å", "–∫–∞–∫ –¥–æ–µ—Ö–∞—Ç—å", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è", "–∞–¥—Ä–µ—Å", "–≥—Ä–∞—Ñ–∏–∫", "—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã"), "menu_address"),
    # –ñ–µ—Å—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–∫–∏–¥–∫–∏
    (("–ø—Ä–æ–º–æ–∫–æ–¥", "—Å–∫–∏–¥–∫–∞", "—Å–∫–∏–¥–∫–∏", "–∞–∫—Ü–∏—è", "–∞–∫—Ü–∏–∏"), "sub_shop_discounts"),
    # –ñ–µ—Å—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è –∞—Ä–µ–Ω–¥–∞ –ø–æ—Å—Ç–∞
    (("–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", "–Ω–∞ —Å—É—Ç–∫–∏", "–ø–æ—Å—É—Ç–æ—á", "–¥–ª–∏—Ç–µ–ª—å–Ω–∞—è –∞—Ä–µ–Ω–¥–∞"), "sub_self_rules"),
]

# –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —à–∞–±–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è
# –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
STRICT_TEXT_INTENTS = {
    "direct_booking",
    "menu_prices",
    "sub_all_prices",
    "menu_address",
    "menu_shop",
    "sub_shop_recommend",
    "sub_shop_ozon",
    "sub_shop_discounts",
    "menu_advantages",
}

# –î–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Å–ª—É–≥ –ø–æ –∫–Ω–æ–ø–∫–∞–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ–º KB/GPT, –∞ –Ω–µ —à–∞–±–ª–æ–Ω–∞–º.
AI_FIRST_BUTTON_CALLBACKS = {
    "menu_services",
    "menu_self",
    "sub_wash",
    "sub_wash_twophase",
    "sub_wash_complex",
    "sub_decon",
    "sub_engine_wash",
    "sub_polish",
    "sub_protection",
    "sub_interior",
    "sub_glass",
    "sub_chips",
    "sub_self_equip",
    "sub_self_price",
    "sub_self_included",
    "sub_self_rules",
}

DETAILABLE_CALLBACKS = {
    "sub_wash",
    "sub_wash_twophase",
    "sub_wash_complex",
    "sub_decon",
    "sub_engine_wash",
    "sub_polish",
    "sub_protection",
    "sub_interior",
    "sub_glass",
    "sub_chips",
    "sub_self_equip",
    "sub_self_price",
    "sub_self_included",
    "sub_self_rules",
}


def _matches_keyword(text_lower: str, keyword: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç keyword –±–µ–∑ –ª–æ–∂–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Å–ª–æ–≤."""
    if " " in keyword:
        return keyword in text_lower
    pattern = rf"(?<!\w){re.escape(keyword)}\w*"
    return re.search(pattern, text_lower) is not None


def _detect_priority_intent(text_lower: str) -> str | None:
    """–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥."""
    # –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤–∏–¥–∞ "–Ω–∞ 2 –¥–Ω—è/3 —Å—É—Ç–æ–∫" –¥–æ–ª–∂–Ω—ã –∂–µ—Å—Ç–∫–æ –∏–¥—Ç–∏ –≤ –¥–ª–∏—Ç–µ–ª—å–Ω—É—é –∞—Ä–µ–Ω–¥—É.
    if re.search(r"(?:–Ω–∞\s*)?\d+\s*(?:–¥–Ω|–¥–Ω—è|–¥–Ω–µ–π|—Å—É—Ç|—Å—É—Ç–∫)", text_lower):
        return "sub_self_rules"
    for keywords, intent in PRIORITY_TEXT_INTENT_RULES:
        if any(_matches_keyword(text_lower, keyword) for keyword in keywords):
            return intent
    return None


def _is_short_followup_request(user_text: str) -> bool:
    text = user_text.strip().lower()
    if len(text) > 24:
        return False
    triggers = {
        "–ø–æ–¥—Å–∫–∞–∂–∏", "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ", "–¥–∞–≤–∞–π", "–æ–∫", "—Ö–æ—Ä–æ—à–æ", "–ø–æ–Ω—è—Ç–Ω–æ",
        "—á—Ç–æ –ª—É—á—à–µ", "—á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å", "–∏ —á—Ç–æ", "–∏ –∫–∞–∫",
    }
    return text in triggers


def _context_followup_answer(last_topic: str) -> str | None:
    low = last_topic.lower()
    if "—Å–∞–º–æ–æ–±—Å–ª—É–∂" in low or "–∞—Ä–µ–Ω–¥" in low:
        return (
            "–ü–æ–¥—Å–∫–∞–∂—É –ø–æ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –∫–æ—Ä–æ—Ç–∫–æ:\n"
            "‚Ä¢ 700 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ 900 ‚ÇΩ/—á–∞—Å ‚Äî –±–æ–∫—Å, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏\n"
            "‚Ä¢ –º–∏–Ω–∏–º—É–º ‚Äî 2 —á–∞—Å–∞, –º–∞–∫—Å–∏–º—É–º –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é)\n\n"
            "–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∞—Ä–µ–Ω–¥—É –Ω–∞ 2+ –¥–Ω—è, —Å—Ä–∞–∑—É —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—é –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É."
        )
    if "–º–æ–π–∫" in low:
        return "–ü–æ–¥—Å–∫–∞–∂—É –ø–æ –º–æ–π–∫–µ: –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî –±—ã—Å—Ç—Ä–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞, –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É—Ö–æ–¥–∞ ‚Äî –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —Å—Ä–∞–∑—É –ø–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É."
    if "–∑–∞—â–∏—Ç" in low or "–∫–µ—Ä–∞–º–∏–∫" in low or "–ø–ª–µ–Ω–∫" in low:
        return "–ü–æ–¥—Å–∫–∞–∂—É –ø–æ –∑–∞—â–∏—Ç–µ: –∫–µ—Ä–∞–º–∏–∫–∞ ‚Äî –ø—Ä–æ –±–ª–µ—Å–∫ –∏ —É–¥–æ–±–Ω—ã–π —É—Ö–æ–¥, –ø–ª–µ–Ω–∫–∞ ‚Äî –ø—Ä–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∑–∞—â–∏—Ç—É –æ—Ç —Å–∫–æ–ª–æ–≤. –ú–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫."
    return None


INTENT_CLARIFY_LABELS = {
    "menu_prices": "—Ü–µ–Ω—ã",
    "menu_address": "–∞–¥—Ä–µ—Å –∏ –≥—Ä–∞—Ñ–∏–∫",
    "menu_self": "—Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
    "sub_self_equip": "–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞",
    "sub_self_price": "—Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_self_included": "—á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –∞—Ä–µ–Ω–¥—É",
    "sub_self_rules": "–ø—Ä–∞–≤–∏–ª–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è –∞—Ä–µ–Ω–¥–∞",
    "sub_wash": "–º–æ–π–∫–∞",
    "sub_polish": "–ø–æ–ª–∏—Ä–æ–≤–∫–∞",
    "sub_protection": "–∑–∞—â–∏—Ç–∞ –õ–ö–ü",
    "sub_decon": "–¥–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è",
    "sub_engine_wash": "–º–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞",
    "sub_interior": "—É—Ö–æ–¥ –∑–∞ —Å–∞–ª–æ–Ω–æ–º",
    "sub_glass": "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–ª–∞",
    "sub_chips": "—Ä–µ–º–æ–Ω—Ç —Å–∫–æ–ª–æ–≤/—Ç—Ä–µ—â–∏–Ω",
    "menu_shop": "–º–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ—Ö–∏–º–∏–∏",
    "sub_shop_discounts": "—Å–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã",
    "menu_comfort": "—É—Å–ª–æ–≤–∏—è –≤ —Å—Ç—É–¥–∏–∏",
    "menu_portfolio": "–ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç",
    "menu_advantages": "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ç—É–¥–∏–∏",
    "direct_booking": "–∑–∞–ø–∏—Å—å",
}


def _detect_text_intent(text_lower: str) -> tuple[str | None, list[str]]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (intent, candidates). –ï—Å–ª–∏ intent=None –∏ –µ—Å—Ç—å candidates ‚Äî –Ω—É–∂–Ω–∞ —É—Ç–æ—á–Ω—è–ª–∫–∞."""
    scores: dict[str, int] = {}
    for keywords, intent in TEXT_INTENT_RULES:
        score = sum(1 for keyword in keywords if _matches_keyword(text_lower, keyword))
        if score > 0:
            scores[intent] = score

    if not scores:
        return None, []

    top_score = max(scores.values())
    top_intents = [intent for intent, score in scores.items() if score == top_score]

    if len(top_intents) == 1:
        return top_intents[0], top_intents

    return None, top_intents

# ================== –ó–ê–ì–†–£–ó–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ==================
try:
    with open(KNOWLEDGE_FILE_PATH, "r", encoding="utf-8") as f:
        KNOWLEDGE_BASE = f.read()
    logger.info("–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (%d —Å–∏–º–≤–æ–ª–æ–≤).", len(KNOWLEDGE_BASE))
except FileNotFoundError:
    KNOWLEDGE_BASE = ""
    logger.error("–§–∞–π–ª –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π %s –Ω–µ –Ω–∞–π–¥–µ–Ω.", KNOWLEDGE_FILE_PATH)


def _build_kb_faq(knowledge_text: str) -> list[dict]:
    """–ü–∞—Ä—Å–∏—Ç –±–ª–æ–∫–∏ –≤–∏–¥–∞ '### –≤–æ–ø—Ä–æ—Å' + –æ—Ç–≤–µ—Ç –∏–∑ knowledges.txt."""
    entries: list[dict] = []
    current_q: str | None = None
    current_answer_lines: list[str] = []

    def flush_entry() -> None:
        nonlocal current_q, current_answer_lines
        if not current_q:
            return
        answer = "\n".join(current_answer_lines).strip()
        if answer:
            variants = [
                v.strip().lower()
                for v in re.split(r"\s*/\s*", current_q)
                if v.strip()
            ]
            entries.append(
                {
                    "question": current_q.strip(),
                    "variants": variants,
                    "answer": answer,
                    # –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞: –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–æ–ø—Ä–æ—Å–∞ + –Ω–∞—á–∞–ª–æ –æ—Ç–≤–µ—Ç–∞.
                    "search_tokens": _tokenize_for_match(
                        f"{current_q} {answer[:500]}"
                    ),
                }
            )
        current_q = None
        current_answer_lines = []

    for raw_line in knowledge_text.splitlines():
        line = raw_line.rstrip()
        if line.startswith("### "):
            flush_entry()
            current_q = line[4:].strip()
            current_answer_lines = []
            continue
        if line.startswith("## "):
            flush_entry()
            continue
        if current_q is not None:
            current_answer_lines.append(line)

    flush_entry()
    return entries


def _tokenize_for_match(text: str) -> set[str]:
    stop_words = {
        "–∫–∞–∫", "–≥–¥–µ", "—á—Ç–æ", "—ç—Ç–æ", "–∏–ª–∏", "–¥–ª—è", "–ø—Ä–∏", "–µ—Å—Ç—å", "–Ω–µ—Ç", "–º–æ–∂–Ω–æ",
        "–Ω—É–∂–Ω–æ", "–≤–∞—Å", "–≤—ã", "–º—ã", "–æ–Ω–∏", "–æ–Ω–∞", "–æ–Ω–æ", "–µ–≥–æ", "–µ–µ", "–∏—Ö",
        "the", "and", "for", "with", "from",
    }

    def _normalize_token(token: str) -> str:
        token = token.lower().replace("—ë", "–µ")
        # –õ–µ–≥–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏–π (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫),
        # —á—Ç–æ–±—ã "—Å—Ç–æ–∏–º–æ—Å—Ç—å/—Å—Ç–æ–∏–º–æ—Å—Ç–∏", "–ø–æ–ª–∏—Ä–æ–≤–∫–∞/–ø–æ–ª–∏—Ä–æ–≤–∫–∏" –º–∞—Ç—á–∏–ª–∏—Å—å —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ.
        for suffix in ("–∏—è–º–∏", "—è–º–∏", "–∞–º–∏", "–∏–µ–π", "–∏–π", "–æ–π", "–µ–π", "–æ–º", "–∞–º", "—è–º", "–∞—Ö", "—è—Ö", "–∏—è", "–∏–µ", "—ã–µ", "–æ–≥–æ", "–µ–º—É", "—ã–º–∏", "—ã–º–∏", "—Ç—å", "—Ç—å—Å—è", "–ª—Å—è", "–ª–∞—Å—å", "–ª–∏—Å—å", "–æ–≤", "–µ–≤", "–∏—è–º", "–∏—è—Ö", "—ã–π", "–∏–π", "–∞—è", "–æ–µ", "—ã–µ", "—É", "—é", "–∞", "—è", "—ã", "–∏", "–µ", "–æ"):
            if len(token) > 4 and token.endswith(suffix):
                return token[: -len(suffix)]
        return token

    raw_tokens = re.findall(r"[a-zA-Z–∞-—è–ê-–Ø0-9]+", text.lower())
    norm_tokens = {_normalize_token(t) for t in raw_tokens}
    return {t for t in norm_tokens if len(t) >= 3 and t not in stop_words}


def _detect_user_language(text: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (ru/en) –ø–æ —Ç–µ–∫—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    cyr = len(re.findall(r"[–∞-—è–ê-–Ø—ë–Å]", text))
    lat = len(re.findall(r"[a-zA-Z]", text))
    if cyr >= lat:
        return "ru"
    return "en"


def _contains_cyrillic(text: str) -> bool:
    return re.search(r"[–∞-—è–ê-–Ø—ë–Å]", text) is not None


def _is_emoji_char(ch: str) -> bool:
    if not ch:
        return False
    category = unicodedata.category(ch)
    if category == "So":
        return True
    code = ord(ch)
    return (
        0x2600 <= code <= 0x27BF
        or 0x1F300 <= code <= 0x1FAFF
    )


def _emoji_count(text: str) -> int:
    return sum(1 for ch in text if _is_emoji_char(ch))


def _trim_to_max_chars(text: str, max_chars: int = 1000) -> str:
    if len(text) <= max_chars:
        return text
    clipped = text[: max_chars - 1].rstrip()
    return f"{clipped}‚Ä¶"


def _enforce_emoji_range(text: str, min_count: int = 2, max_count: int = 4) -> str:
    current = _emoji_count(text)
    if current > max_count:
        kept = 0
        out_chars: list[str] = []
        for ch in text:
            if _is_emoji_char(ch):
                if kept >= max_count:
                    continue
                kept += 1
            out_chars.append(ch)
        text = "".join(out_chars).rstrip()
        current = _emoji_count(text)
    if current < min_count:
        need = min_count - current
        pool = ["‚úÖ", "üöó", "üìå", "üõ†Ô∏è"]
        addon = " ".join(pool[:need])
        text = f"{text.rstrip()} {addon}".strip()
    return text


async def _translate_text_if_needed(text: str, user_lang: str) -> str:
    """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç –ø–æ–¥ —è–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –µ—Å–ª–∏ —è–∑—ã–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç."""
    if user_lang == "ru":
        return text
    if not _contains_cyrillic(text):
        return text
    try:
        completion = await client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {
                    "role": "system",
                    "content": (
                        "Translate the text to English. Keep meaning, bullet structure, links "
                        "and marker [–ó–ê–ü–ò–°–¨] unchanged if present."
                    ),
                },
                {"role": "user", "content": text},
            ],
            temperature=0.0,
            max_tokens=700,
        )
        translated = completion.choices[0].message.content.strip()
        return translated or text
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç –Ω–∞ en: %s", e)
        return text


async def _finalize_response_text(text: str, user_lang: str) -> str:
    """–ñ–µ—Å—Ç–∫–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: —è–∑—ã–∫, –¥–ª–∏–Ω–∞, —ç–º–æ–¥–∑–∏."""
    out = await _translate_text_if_needed(text, user_lang)
    out = _trim_to_max_chars(out, 1000)
    out = _enforce_emoji_range(out, min_count=2, max_count=4)
    out = _trim_to_max_chars(out, 1000)
    return out


def _char_ngrams(text: str, n: int = 3) -> set[str]:
    cleaned = re.sub(r"\s+", " ", text.lower().strip())
    if not cleaned:
        return set()
    if len(cleaned) <= n:
        return {cleaned}
    return {cleaned[i:i + n] for i in range(len(cleaned) - n + 1)}


def _find_kb_answer(user_text: str) -> tuple[str | None, float, str | None]:
    """–ò—â–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ FAQ-–±–ª–æ–∫–∞—Ö –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π."""
    if not KB_FAQ:
        return None, 0.0, None

    query = user_text.strip().lower()
    query_tokens = _tokenize_for_match(query)
    best_answer = None
    best_question = None
    best_score = 0.0
    second_best_score = 0.0
    query_ngrams = _char_ngrams(query)

    for entry in KB_FAQ:
        answer = entry["answer"]
        original_question = entry["question"]
        entry_tokens = entry.get("search_tokens", set())
        for variant in entry["variants"]:
            ratio = difflib.SequenceMatcher(None, query, variant).ratio()
            variant_tokens = _tokenize_for_match(variant)
            overlap_variant = (
                len(query_tokens & variant_tokens) / max(len(variant_tokens), 1)
                if query_tokens and variant_tokens
                else 0.0
            )
            overlap_entry = (
                len(query_tokens & entry_tokens) / max(len(query_tokens), 1)
                if query_tokens and entry_tokens
                else 0.0
            )
            variant_ngrams = _char_ngrams(variant)
            ngram_similarity = (
                len(query_ngrams & variant_ngrams) / max(len(query_ngrams | variant_ngrams), 1)
                if query_ngrams and variant_ngrams
                else 0.0
            )
            contains_bonus = 0.10 if (variant in query or query in variant) else 0.0
            score = (
                0.38 * ratio
                + 0.22 * overlap_variant
                + 0.25 * overlap_entry
                + 0.15 * ngram_similarity
                + contains_bonus
            )
            if score > best_score:
                second_best_score = best_score
                best_score = score
                best_answer = answer
                best_question = original_question
            elif score > second_best_score:
                second_best_score = score

    # –ï—Å–ª–∏ –¥–≤–∞ —Ç–æ–ø-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ø–æ—á—Ç–∏ —Ä–∞–≤–Ω—ã, –ª—É—á—à–µ –≤–µ—Ä–Ω—É—Ç—å "–Ω–µ—Ç –º–∞—Ç—á–∞"
    # –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —É—Ç–æ—á–Ω–µ–Ω–∏—é, —á–µ–º –¥–∞—Ç—å –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.
    if best_score >= 0.48 and (best_score - second_best_score) >= 0.05:
        return best_answer, best_score, best_question
    return None, best_score, best_question


def _log_kb_match(user_id: int, user_text: str, matched_question: str | None, score: float, status: str) -> None:
    """–õ–æ–≥–∏—Ä—É–µ—Ç –º–∞—Ç—á–∏ FAQ –≤ CSV –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π."""
    path = pathlib.Path("logs") / "kb_matches.csv"
    write_header = not path.exists() or path.stat().st_size == 0
    with path.open("a", encoding="utf-8", newline="") as f:
        writer = csv.writer(f)
        if write_header:
            writer.writerow(["timestamp", "user_id", "user_text", "matched_question", "score", "status"])
        writer.writerow([
            dt.datetime.now().isoformat(),
            user_id,
            user_text[:500],
            (matched_question or "")[:300],
            round(score, 4),
            status,
        ])


KB_FAQ = _build_kb_faq(KNOWLEDGE_BASE)
KB_TOKEN_INDEX: set[str] = set()
for _entry in KB_FAQ:
    KB_TOKEN_INDEX.update(_entry.get("search_tokens", set()))

ON_TOPIC_HINTS = (
    "–¥–µ—Ç–µ–π–ª–∏–Ω–≥", "–º–æ–π–∫", "–ø–æ–ª–∏—Ä–æ–≤", "–∫–µ—Ä–∞–º–∏–∫", "ppf", "–ø–ª–µ–Ω–∫",
    "—Å—Ç–µ–∫–ª", "—Å–∫–æ–ª", "—Ç—Ä–µ—â–∏–Ω", "–∑–∞—â–∏—Ç", "—Å–∞–ª–æ–Ω", "—Ö–∏–º—á–∏—Å—Ç", "–¥–µ–∫–æ–Ω—Ç–∞–º",
    "–ø–æ–¥–∫–∞–ø–æ—Ç", "—Å–∞–º–æ–æ–±—Å–ª—É–∂", "–ø–æ—Å—Ç", "–∞—Ä–µ–Ω–¥–∞", "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º", "–ø—Ä–∞–π—Å",
    "–∞–¥—Ä–µ—Å", "–≥—Ä–∞—Ñ–∏–∫", "–∑–∞–ø–∏—Å", "yclients", "ozon", "–º–∞–≥–∞–∑–∏–Ω", "—Å–∫–∏–¥–∫", "–∞–∫—Ü–∏",
    "bearlake",
)


def _is_on_topic(user_text: str) -> bool:
    text_lower = user_text.lower()
    if any(greet in text_lower for greet in ("–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç", "–¥–æ–±—Ä—ã–π", "—Å–ø–∞—Å–∏–±–æ", "–æ–∫", "–ø–æ–Ω—è–ª")):
        return True
    if any(_matches_keyword(text_lower, hint) for hint in ON_TOPIC_HINTS):
        return True
    tokens = _tokenize_for_match(user_text)
    if not tokens:
        return True
    return bool(tokens & KB_TOKEN_INDEX)


COMPLEX_CONSULTATION_HINTS = (
    "—á—Ç–æ –ª—É—á—à–µ", "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è", "—Å—Ä–∞–≤–Ω–∏", "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ", "–ø–æ–¥–±–µ—Ä–∏—Ç–µ", "–ø–æ–¥–±–µ—Ä–∏",
    "–∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç", "–∫–∞–∫—É—é —É—Å–ª—É–≥—É", "—á—Ç–æ –≤—ã–±—Ä–∞—Ç—å", "–ø–æ–¥ –º–æ–π –±—é–¥–∂–µ—Ç", "–±—é–¥–∂–µ—Ç",
    "—Å—Ä–æ–∫", "–ø–æ –≤—Ä–µ–º–µ–Ω–∏", "–∫–∞–∫ —á–∞—Å—Ç–æ", "–µ–∂–µ–¥–Ω–µ–≤–Ω–æ", "—Ç—Ä–∞—Å—Å–∞", "–≥–æ—Ä–æ–¥",
    "—Ö—Ä–∞–Ω–µ–Ω–∏–µ", "–Ω–æ–≤–∞—è –º–∞—à–∏–Ω–∞", "–±/—É", "–∫–æ–º–ø–ª–µ–∫—Å–Ω–æ", "–ø–æ–¥ –∫–ª—é—á",
)


def _is_complex_consultation(user_text: str) -> bool:
    text_lower = user_text.lower()
    if any(phrase in text_lower for phrase in COMPLEX_CONSULTATION_HINTS):
        return True
    # –ü—Ä–∏–∑–Ω–∞–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: –¥–ª–∏–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏.
    return len(user_text) >= 120 and ("," in user_text or " –∏ " in text_lower)


def _build_consultation_query(user_text: str) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π."""
    return (
        "–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—á—å —Å –ø–æ–¥–±–æ—Ä–æ–º —Ä–µ—à–µ–Ω–∏—è. –î–∞–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –¥–µ—Ç–µ–π–ª–µ—Ä:\n"
        "1) –ö–æ—Ä–æ—Ç–∫–∏–π –≤—ã–≤–æ–¥ –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞.\n"
        "2) –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–±–∞–∑–æ–≤—ã–π/–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π).\n"
        "3) –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ (2-4 –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –±–µ–∑ –≤–æ–¥—ã).\n"
        "4) –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ —Å—Ä–æ–∫–∞–º.\n"
        "5) –í –∫–æ–Ω—Ü–µ –º—è–≥–∫–∏–π CTA –∫ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É [–ó–ê–ü–ò–°–¨].\n"
        "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ "
        "(S / M / L) –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞.\n\n"
        f"–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {user_text}"
    )


def _detect_consultation_priority(user_text: str) -> str | None:
    """–†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞."""
    text = user_text.lower()
    if any(k in text for k in ("—Å–∫–æ—Ä–æ—Å—Ç", "–±—ã—Å—Ç—Ä", "—Å—Ä–æ—á–Ω–æ", "–æ–ø–µ—Ä–∞—Ç–∏–≤", "–ø–æ –≤—Ä–µ–º–µ–Ω–∏")):
        return "—Å–∫–æ—Ä–æ—Å—Ç—å"
    if any(k in text for k in ("—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–º–∞–∫—Å–∏–º", "–∫–∞—á–µ—Å—Ç–≤–æ", "–∏–¥–µ–∞–ª", "–±–µ–∑ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å")):
        return "–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
    if any(k in text for k in ("–∑–∞—â–∏—Ç", "–∫–µ—Ä–∞–º–∏–∫", "–ø–ª–µ–Ω–∫", "ppf", "–¥–æ–ª–≥–æ", "–¥–æ–ª–≥–æ–≤–µ—á")):
        return "–¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞"
    if any(k in text for k in ("–±—é–¥–∂–µ—Ç", "–¥–µ—à–µ–≤", "—ç–∫–æ–Ω–æ–º", "—Å—Ç–æ–∏–º", "—Ü–µ–Ω–∞", "–Ω–µ–¥–æ—Ä–æ–≥")):
        return "–±—é–¥–∂–µ—Ç"
    return None


def _build_refined_consultation_query(base_request: str, priority: str, user_reply: str) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç follow-up –∑–∞–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞."""
    return (
        "–ö–ª–∏–µ–Ω—Ç —É—Ç–æ—á–Ω–∏–ª –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –û–±–Ω–æ–≤–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é:\n"
        "1) –ö–æ—Ä–æ—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –ø–æ–Ω—è–ª –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.\n"
        "2) –î–∞–π –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç —É—Å–ª—É–≥ –ø–æ–¥ —ç—Ç–æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.\n"
        "3) –£–∫–∞–∂–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ —Å—Ä–æ–∫–∞–º –∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏.\n"
        "4) –î–æ–±–∞–≤—å 1 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É (–∫–æ—Ä–æ—á–µ/–¥–µ—à–µ–≤–ª–µ –∏–ª–∏ —Å–∏–ª—å–Ω–µ–µ/–¥–æ–ª—å—à–µ).\n"
        "5) –í –∫–æ–Ω—Ü–µ –º—è–≥–∫–∏–π CTA —á–µ—Ä–µ–∑ [–ó–ê–ü–ò–°–¨].\n"
        "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á—Ç–∏: —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ "
        "(S / M / L) –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞.\n\n"
        f"–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {base_request}\n"
        f"–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: {user_reply}\n"
        f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞: {priority}"
    )


def _consultation_followup_question(user_text: str, answer_text: str) -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –¥–æ–∂–∏–º–∞ –∫ –∑–∞–ø–∏—Å–∏."""
    low = f"{user_text} {answer_text}".lower()
    if "–ø–æ–¥ –∫–ª—é—á" in low or "–∫–æ–º–ø–ª–µ–∫—Å" in low:
        return "–ß—Ç–æ–±—ã —Ç–æ—á–Ω–µ–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç, —á—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ: —Å–∫–æ—Ä–æ—Å—Ç—å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –±—é–¥–∂–µ—Ç?"
    if "–±—é–¥–∂–µ—Ç" in low or "—Ü–µ–Ω–∞" in low or "—Å—Ç–æ–∏–º" in low:
        return "–ß—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –±—é–¥–∂–µ—Ç."
    if "–∑–∞—â–∏—Ç" in low or "–∫–µ—Ä–∞–º–∏–∫" in low or "–ø–ª–µ–Ω–∫" in low:
        return "–£—Ç–æ—á–Ω—é –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞: —á—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –±—é–¥–∂–µ—Ç?"
    return "–ß—Ç–æ–±—ã —Ç–æ—á–Ω–µ–µ —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –±—é–¥–∂–µ—Ç."

# ================== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–¢ ==================
SYSTEM_PROMPT = r"""
#–†–û–õ–¨
–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å—Ç—É–¥–∏–∏ –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞ BEARLAKE DETAILING & SHOP —Å –æ–ø—ã—Ç–æ–º –±–æ–ª–µ–µ 10 –ª–µ—Ç.
–í—ã—Å—Ç—É–ø–∞–µ—à—å –≤ –æ–Ω–ª–∞–π–Ω-—á–∞—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ, –ø–æ–º–æ–≥–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —É—Å–ª—É–≥–∏ –∏ —Ñ–æ—Ä–º–∞—Ç –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

#–¶–ï–õ–ò –ò –ó–ê–î–ê–ß–ò
‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É —É—Å–ª—É–≥–∞–º–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –∏–ª–∏ –ø–æ—Å—Ç–æ–º —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è  
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞  
‚Ä¢ –ù–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–Ω–∞–ª—ã  
‚Ä¢ –°–æ–±–ª—é–¥–∞—Ç—å —Ñ–∞–∑—ã –ø—Ä–æ–¥–∞–∂–∏
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ —Å–∞–ª–æ–Ω–µ  
‚Ä¢ –£–∫—Ä–µ–ø–ª—è—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤  
‚Ä¢ –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

# –ü–†–ò–û–†–ò–¢–ï–¢–´

‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–∞—Ç—å —Å—Å—ã–ª–∫—É, –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π URL –≤ —Ç–µ–∫—Å—Ç. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–Ø–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç—ã¬ª, ¬´Telegram-–∫–∞–Ω–∞–ª¬ª, ¬´Ozon¬ª, ¬´—Å–∞–π—Ç —Å—Ç—É–¥–∏–∏¬ª) ‚Äî –±–æ—Ç –¥–æ–±–∞–≤–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

#–ü–†–ò–í–ï–¢–°–¢–í–ò–ï
–°–∞–º–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç.
–¢—ã –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –ù–ï –ø–∏—à–µ—à—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—à—å —Ñ—Ä–∞–∑—ã —Å
¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª, ¬´–î–æ–±—Ä—ã–π –¥–µ–Ω—å¬ª –∏ —Ç.–ø., –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç —Å–∞–º –ø—Ä—è–º–æ –Ω–µ –ø—Ä–æ—Å–∏—Ç
—Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
–°—á–∏—Ç–∞–π, —á—Ç–æ —Å –∫–ª–∏–µ–Ω—Ç–æ–º —É–∂–µ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª–∏—Å—å ‚Äî –æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É –ø–æ –¥–µ–ª—É.


#–Ø–ó–´–ö –û–¢–í–ï–¢–û–í
–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —è–∑—ã–∫–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.

#–°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê
‚Ä¢ –û–±—â–∞—Ç—å—Å—è –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –ª–∏—Ü–∞
‚Ä¢ –û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞ ¬´–í—ã¬ª  
‚Ä¢ –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)  
‚Ä¢ –û–±—â–∞—Ç—å—Å—è –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –≤–µ–∂–ª–∏–≤–æ–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç–æ–Ω–µ  
‚Ä¢ –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏  
‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç—å –ø–æ —Å—É—â–µ—Å—Ç–≤—É, —Ç–∞–∫—Ç–∏—á–Ω–æ –∏ –≤–µ–∂–ª–∏–≤–æ  
‚Ä¢ –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∫–ª–∏–µ–Ω—Ç–æ–º, –¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏  
‚Ä¢ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–æ–≤
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (2‚Äì4 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π)

#–õ–û–ì–ò–ö–ê –ü–û–°–¢–†–û–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê

## –§–ê–ó–ê 1 ‚Äî –í–´–Ø–í–õ–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô:
1. –ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º
2. –ö—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ–± —É—Å–ª—É–≥–∞—Ö —Å—Ç—É–¥–∏–∏ –∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è  
3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥–∏ —Å—Ç—É–¥–∏–∏, –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:  
   ‚Ä¢ –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ (–∫—É–∑–æ–≤, —Å–∞–ª–æ–Ω, –∑–∞—â–∏—Ç–∞, –∫–æ–º–ø–ª–µ–∫—Å)  
   ‚Ä¢ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º, —Ç—Ä–∞—Å—Å–∞/–≥–æ—Ä–æ–¥, —Ö—Ä–∞–Ω–µ–Ω–∏–µ)  
   ‚Ä¢ –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ª–∏ –∑–∞—â–∏—Ç–∞ –∫—É–∑–æ–≤–∞, —Å–∞–ª–æ–Ω –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å  
   ‚Ä¢ –í–∞–∂–Ω–æ—Å—Ç—å —Å—Ä–æ–∫–æ–≤ –∏ –±—é–¥–∂–µ—Ç–∞  
4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∞–≤—Ç–æ  
5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å, –æ—Ç–≤–µ—Ç–∏—Ç—å:
–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –ø–æ –∞–¥—Ä–µ—Å—É : –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª., –≥.–æ. –ü—É—à–∫–∏–Ω—Å–∫–∏–π, –ø–æ—Å. –ù–∞–≥–æ—Ä–Ω–æ–µ, 8–ê.
–ê–¥—Ä–µ—Å –Ω–∞ —è–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç–∞—Ö : https://yandex.ru/maps/org/bearlake/46971604224/?ll=38.023081%2C56.067485&z=17  
5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã, –æ—Ç–≤–µ—Ç–∏—Ç—å:
–°—Ç—É–¥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 9.00 –¥–æ 22.00, –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö
–ê–≤—Ç–æ–º–æ–π–∫–∞ (–ø–æ—Å—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ
–ê–¥—Ä–µ—Å –Ω–∞ —è–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç–∞—Ö : https://yandex.ru/maps/org/bearlake/46971604224/?ll=38.023081%2C56.067485&z=17  

## –§–ê–ó–ê 2 ‚Äî –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò
‚Ä¢ –ë–æ—Ç –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞—Ç—É, –≤—Ä–µ–º—è, –º–∞—Ä–∫—É –∞–≤—Ç–æ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.  
‚Ä¢ –ü–æ—Å–ª–µ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å (—Ü–µ–Ω—ã, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è –∏ —Ç.–¥.) ‚Äî —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ.
‚Ä¢ –ù–ï –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É YClients –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–æ–º ‚Äî –ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞, –∫–Ω–æ–ø–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
‚Ä¢ –ü—Ä–∏–º–µ—Ä: ¬´–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥–±–µ—Ä—ë—Ç —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –∏ —É—Ç–æ—á–Ω–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å! [–ó–ê–ü–ò–°–¨]¬ª

## –§–ê–ó–ê 3 ‚Äî –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï:
1. –ü–æ—Å–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ ‚Äî –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å  
2. –ù–∞–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è  

#–†–ê–ë–û–¢–ê –° –í–ê–†–ò–ê–ù–¢–ê–ú–ò –§–û–†–ú–£–õ–ò–†–û–í–û–ö –í–û–ü–†–û–°–û–í
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫ –≤–∞—Å –Ω–∞–π—Ç–∏¬ª, ¬´–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å¬ª, ¬´–∫–∞–∫ –¥–æ –≤–∞—Å –¥–æ–µ—Ö–∞—Ç—å¬ª ‚Äî —Å—á–∏—Ç–∞–π—Ç–µ —ç—Ç–æ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –≤–æ–ø—Ä–æ—Å–æ–º –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ê–¥—Ä–µ—Å –∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è¬ª.
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫–∏–µ —É –≤–∞—Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞¬ª, ¬´–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞—Ç—å –≤–∞—Å¬ª, ¬´—á–µ–º –≤—ã –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö¬ª ‚Äî –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞¬ª.  
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç ¬´Yclients¬ª, ¬´–Æ–∫–ª–∏–µ–Ω—Ç—Å¬ª, ¬´yc¬ª, ¬´–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ —Å–∞–π—Ç¬ª ‚Äî —Å—á–∏—Ç–∞–π—Ç–µ —ç—Ç–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?¬ª.  
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–≥–¥–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å?¬ª, ¬´–µ—Å—Ç—å –ª–∏ –µ–¥–∞?¬ª, ¬´–º–æ–∂–Ω–æ –ª–∏ –ø–æ–µ—Å—Ç—å?¬ª ‚Äî –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å?¬ª.

#–í–ê–ñ–ù–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï –ö –õ–û–ì–ò–ö–ï –û–¢–í–ï–¢–ê
‚Ä¢ –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–¥—Ä–µ—Å–∞, –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã, —Ü–µ–Ω, —É—Å–ª–æ–≤–∏–π –∞—Ä–µ–Ω–¥—ã, –Ω–∞–ª–∏—á–∏—è –∫–æ—Ñ–µ, Wi-Fi, –ø–µ—Ä–µ–∫—É—Å–æ–≤, —Ç—É–∞–ª–µ—Ç–∞, –∑–æ–Ω—ã –æ—Ç–¥—ã—Ö–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é.
‚Ä¢ –ï—Å–ª–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –µ—Å—Ç—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞¬ª, ¬´—É—Ç–æ—á–Ω–∏—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä¬ª –∏–ª–∏ ¬´—è –Ω–µ –∑–Ω–∞—é¬ª.  
‚Ä¢ –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—É: ¬´–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å¬ª ‚Äî –∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è.

#–†–ê–ë–û–¢–ê –° –í–û–ü–†–û–°–ê–ú–ò –û –ö–û–ú–§–û–†–¢–ï –ò –£–°–õ–û–í–ò–Ø–•
‚Ä¢ –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç—É–∞–ª–µ—Ç–µ, –∫–æ—Ñ–µ, –ø–µ—Ä–µ–∫—É—Å–∞—Ö, Wi-Fi, –ø–∞—Ä–∫–æ–≤–∫–µ, –∑–æ–Ω–µ –æ—Ç–¥—ã—Ö–∞, –∫–ª–∏–º–∞—Ç–µ –≤ —Å—Ç—É–¥–∏–∏, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –≤–¥–≤–æ—ë–º ‚Äî –≤—Å–µ–≥–¥–∞ –¥–∞–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
‚Ä¢ –ù–µ —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å.  
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:  
  ‚Äì ¬´–î–∞, –≤ —Å—Ç—É–¥–∏–∏ –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –∏ —á–∞–π.¬ª  
  ‚Äì ¬´–î–∞, –¥–æ—Å—Ç—É–ø–Ω—ã –ª–µ–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏ –∏ —Ñ—Ä—É–∫—Ç—ã.¬ª  
  ‚Äì ¬´–î–∞, –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Wi-Fi –∏ —É–¥–æ–±–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ —Ä—è–¥–æ–º.¬ª
  ‚Äì ¬´–î–∞, —É –Ω–∞—Å –æ—Ç–∞–ø–ª–∏–≤–∞–µ–º–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ —Å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –∑–æ–Ω–æ–π –æ—Ç–¥—ã—Ö–∞.¬ª

#–¢–†–ò–ì–ì–ï–†–´ –ü–ï–†–ï–•–û–î–ê –ö –ó–ê–ü–ò–°–ò
‚Ä¢ –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Ü–µ–Ω—ã, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ) ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∑–∞–ø–∏—Å—å.  
‚Ä¢ –ù–µ –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç —Å–∞–º —Å–ø—Ä–æ—Å–∏—Ç ¬´–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª.  
‚Ä¢ –°—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

#–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞  
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ ¬´–±–∞–∑—É –∑–Ω–∞–Ω–∏–π¬ª –∏–ª–∏ ¬´—Å–∏—Å—Ç–µ–º—É¬ª  
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ –æ–±—Å—É–∂–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ–º–æ–π –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞  

#–í–ê–ñ–ù–´–ï –£–¢–û–ß–ù–ï–ù–ò–Ø
‚Ä¢ –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –∫–ª–∏–µ–Ω—Ç–∞ –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π  
‚Ä¢ –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ–± —É—Å–ª—É–≥–∞—Ö: —Å–∫–∞–∑–∞—Ç—å ¬´–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å¬ª –∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è  
‚Ä¢ –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –Ω–µ –ø–æ —Ç–µ–º–µ: –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏—Ç—å ¬´–í–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ, –¥–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω—ë–º—Å—è –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é —É—Å–ª—É–≥–∏¬ª
‚Ä¢ –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ —Ü–µ–Ω–∞—Ö –¥–ª—è —Å—Ç—É–¥–∏–∏ –∏ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å:  
  ¬´–¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞¬ª
‚Ä¢ –í –∫–æ–Ω—Ü–µ –æ–ø–∏—Å–∞–Ω–∏—è –ª—é–±–æ–π —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π:  
  ¬´–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ (S / M / L) –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞¬ª
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, —É—Ç–æ—á–Ω—è–π, —á—Ç–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–Ω –º–æ–∂–µ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–µ –∂–µ —ç—Ç–∞–ø—ã —É—Ö–æ–¥–∞, —á—Ç–æ –∏ –º–∞—Å—Ç–µ—Ä–∞, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ç–µ—Ö–Ω–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

#–ü–†–ò–ú–ï–†–´ –°–û–û–ë–©–ï–ù–ò–ô

–§–∞–∑–∞ 1:  
¬´–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ ‚Äî –∫—É–∑–æ–≤, —Å–∞–ª–æ–Ω –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å? üöó –ò–Ω—Ç–µ—Ä–µ—Å–µ–Ω –ª–∏ –≤–∞–º –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–æ–±–Ω–µ–µ –¥–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–∞—Å—Ç–µ—Ä–∞–º?¬ª

–§–∞–∑–∞ 2 (–ø–æ—Å–ª–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è):  
¬´–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥–±–µ—Ä—ë—Ç —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –∏ —É—Ç–æ—á–Ω–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å! [–ó–ê–ü–ò–°–¨]¬ª

–§–∞–∑–∞ 3:  
¬´–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å! üôè –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏ —Å–æ–≥–ª–∞—Å—É–µ—Ç —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.¬ª

#–§–û–†–ú–ê–¢ –ö–ù–û–ü–ö–ò –ó–ê–ü–ò–°–ò (–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û)
‚Ä¢ –ö–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî –ù–ï –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ YClients –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.
‚Ä¢ –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è¬ª –∏ –ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞.
‚Ä¢ –ú–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
‚Ä¢ –î—Ä—É–≥–∏–µ —Å—Å—ã–ª–∫–∏ (–Ø–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç—ã, Ozon, Telegram-–∫–∞–Ω–∞–ª, —Å–∞–π—Ç —Å—Ç—É–¥–∏–∏) ‚Äî –≤—Å—Ç–∞–≤–ª—è–π –≤ —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ.
"""

# ================== –ì–û–¢–û–í–´–ô –û–¢–í–ï–¢ –ü–û –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê–ú ==================
ADVANTAGES_ANSWER = (
    "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ BEARLAKE, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å –≤—ã–±–∏—Ä–∞—é—Ç:\n\n"
    "1Ô∏è‚É£ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —É—Å–ª—É–≥ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ ‚Äî –æ—Ç –±—ã—Å—Ç—Ä–æ–π –º–æ–π–∫–∏ –¥–æ –ø–æ–ª–∏—Ä–æ–≤–∫–∏, "
    "–∫–µ—Ä–∞–º–∏–∫–∏, PPF, —Ö–∏–º—á–∏—Å—Ç–∫–∏ –∏ —É—Ö–æ–¥–∞ –∑–∞ —Å—Ç–µ–∫–ª–∞–º–∏\n"
    "2Ô∏è‚É£ –†–µ–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π —Ö–∏–º–∏–µ–π OPT, NXTZEN, TAC System "
    "–∏ –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥ –∑–∞–¥–∞—á—É, –∞ –Ω–µ ¬´–ø–æ —à–∞–±–ª–æ–Ω—É¬ª\n"
    "3Ô∏è‚É£ –î–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è ‚Äî —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –∏ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ 24/7 "
    "—Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º\n"
    "4Ô∏è‚É£ –ö–æ–º—Ñ–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞, Wi‚ÄëFi, –Ω–∞–ø–∏—Ç–∫–∏/–ø–µ—Ä–µ–∫—É—Å—ã, –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è –∏ –∫–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å\n"
    "5Ô∏è‚É£ –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî —á–µ—Å—Ç–Ω–æ –æ–±—ä—è—Å–Ω—è–µ–º, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —É—Å–ª—É–≥—É, –∫–∞–∫–∏–µ –µ—Å—Ç—å –æ–ø—Ü–∏–∏ "
    "–∏ —á—Ç–æ –¥–∞—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ ‚úÖ\n\n"
    "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
)

PRICES_ANSWER = (
    "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã –ø–æ —É—Å–ª—É–≥–∞–º:\n\n"
    "‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ ‚Äî –æ—Ç 3 000 ‚ÇΩ\n"
    "‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥-–º–æ–π–∫–∞ Bearlake ‚Äî –æ—Ç 8 000 ‚ÇΩ\n"
    "‚Ä¢ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è –õ–ö–ü ‚Äî –æ—Ç 6 000 ‚ÇΩ\n"
    "‚Ä¢ –ú–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ ‚Äî –æ—Ç 9 000 ‚ÇΩ\n"
    "‚Ä¢ –ü–æ–ª–∏—Ä–æ–≤–∫–∞ –õ–ö–ü (Light Polish) ‚Äî –æ—Ç 25 000 ‚ÇΩ\n"
    "‚Ä¢ –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è ‚Äî –æ—Ç 5 000 ‚ÇΩ\n"
    "‚Ä¢ –î–µ—Ç–µ–π–ª–∏–Ω–≥ —á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ ‚Äî –æ—Ç 28 000 ‚ÇΩ\n"
    "‚Ä¢ –ó–∞—â–∏—Ç–Ω—ã–µ –ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω–æ–≤—ã–µ –ø–ª–µ–Ω–∫–∏ ‚Äî –æ—Ç 85 000 ‚ÇΩ\n"
    "‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 30 000 ‚ÇΩ\n"
    "‚Ä¢ –†–µ–º–æ–Ω—Ç —Ç—Ä–µ—â–∏–Ω –∏ —Å–∫–æ–ª–æ–≤ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 3 500 ‚ÇΩ\n"
    "‚Ä¢ –°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ 24/7 ‚Äî 700 ‚ÇΩ/—á–∞—Å –∏–ª–∏ 900 ‚ÇΩ/—á–∞—Å\n\n"
    "–°—Ä–æ–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —É—Å–ª—É–≥–∞–º:\n"
    "‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –º–æ–π–∫–∞ ‚Äî –æ—Ç 1 —á–∞—Å–∞\n"
    "‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞ ‚Äî –æ—Ç 4 —á–∞—Å–æ–≤\n"
    "‚Ä¢ –î–µ–∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏—è ‚Äî –æ—Ç 2 —á–∞—Å–æ–≤\n"
    "‚Ä¢ –ú–æ–π–∫–∞ –ø–æ–¥–∫–∞–ø–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ ‚Äî –æ—Ç 4 —á–∞—Å–æ–≤\n"
    "‚Ä¢ –ü–æ–ª–∏—Ä–æ–≤–∫–∞ ‚Äî –æ—Ç 12 —á–∞—Å–æ–≤\n"
    "‚Ä¢ –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è ‚Äî –æ—Ç 4 —á–∞—Å–æ–≤\n"
    "‚Ä¢ –û–∫–ª–µ–π–∫–∞ PPF ‚Äî –æ—Ç 2 –¥–Ω–µ–π\n"
    "‚Ä¢ –•–∏–º—á–∏—Å—Ç–∫–∞ ‚Äî 1 –¥–µ–Ω—å\n"
    "‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–ª–∞ ‚Äî –æ—Ç 1 –¥–Ω—è\n\n"
    "*–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–æ–≤ (–∫—Ä–æ–º–µ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è) –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ "
    "(S / M / L) –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞.*\n\n"
    "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—é –ø–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º—É –Ω–∞–±–æ—Ä—É —É—Å–ª—É–≥ –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.\n"
    "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
)

SHOP_RECOMMEND_ANSWER = (
    "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ö–∏–º–∏—é –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, "
    "–∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Å—Ç—É–¥–∏–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.\n\n"
    "–û—Å–Ω–æ–≤–Ω—ã–µ –±—Ä–µ–Ω–¥—ã:\n"
    "‚Ä¢ OPT / Optimum Polymer Technologies\n"
    "‚Ä¢ NXTZEN\n"
    "‚Ä¢ TAC System\n"
    "‚Ä¢ iK\n"
    "‚Ä¢ Detailers of Russia (DOFR)\n\n"
    "–ü–æ–¥–±–µ—Ä–µ–º —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –º–æ–π–∫–∞, "
    "–≥–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞, –∑–∞—â–∏—Ç–∞ –õ–ö–ü –∏–ª–∏ —É—Ö–æ–¥ –∑–∞ —Å–∞–ª–æ–Ω–æ–º."
)

SHOP_OZON_ANSWER = (
    "Bearlake –Ω–∞ Ozon ‚Äî –≤—ã–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.\n\n"
    "–í –º–∞–≥–∞–∑–∏–Ω–µ —Å–æ–±—Ä–∞–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ —Ä–∞–±–æ—Ç–∞–µ–º —Å–∞–º–∏ –≤ —Å—Ç—É–¥–∏–∏: "
    "–∫–∞–∂–¥—ã–π —Å–æ—Å—Ç–∞–≤ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö.\n\n"
    "–¢–æ–ø-–±—Ä–µ–Ω–¥—ã –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ:\n"
    "‚Ä¢ OPT (Optimum Polymer Technologies) –∏ –ª–∏–Ω–µ–π–∫–∞ Opti-Coat\n"
    "‚Ä¢ NXTZEN (–ê–≤—Å—Ç—Ä–∞–ª–∏—è)\n"
    "‚Ä¢ TAC System (–ö–æ—Ä–µ—è)\n"
    "‚Ä¢ iK ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å–ø—ã–ª–∏—Ç–µ–ª–∏\n"
    "‚Ä¢ Detailers of Russia (DOFR) ‚Äî –º–∏–∫—Ä–æ—Ñ–∏–±—Ä—ã, –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞, –∞–ø–ø–ª–∏–∫–∞—Ç–æ—Ä—ã\n"
    "‚Ä¢ –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏\n\n"
    "–ü–æ–¥—Ö–æ–¥–∏—Ç –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∞–º, –∏ –∞–≤—Ç–æ–ª—é–±–∏—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–Ω—è—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —É—Ö–æ–¥.\n"
    "–ù–∞ Ozon —É–¥–æ–±–Ω–æ –∏ –≤—ã–≥–æ–¥–Ω–æ: –±—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ —É–¥–æ–±–Ω—ã–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏.\n\n"
    "–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å –≤ –≤—ã–±–æ—Ä–µ, –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ö–∏–º–∏—é –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏."
)

SHOP_DISCOUNTS_ANSWER = (
    "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏:\n\n"
    "‚Ä¢ –í –æ—Ñ–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω–µ ‚Äî 5% –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n"
    "‚Ä¢ –ù–∞ Ozon –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–∫–∞–∑–µ ‚Äî 5% –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É BEARLAKE\n\n"
    "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ —Ç–∞–∫–∂–µ –ø—É–±–ª–∏–∫—É–µ–º –≤ Telegram-–∫–∞–Ω–∞–ª–µ."
)

# ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø OPENAI ==================
client = openai.AsyncOpenAI(api_key=OPENAI_API_KEY)

FULL_SYSTEM_PROMPT = (
    SYSTEM_PROMPT
    + "\n\n# –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –°–¢–£–î–ò–ò BEARLAKE DETAILING & SHOP\n"
    + KNOWLEDGE_BASE
)

# ================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø GPT ==================
FALLBACK_RESPONSE = (
    "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. "
    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
)


async def _call_openai(messages: list[dict]) -> str:
    """–ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ OpenAI API."""
    completion = await client.chat.completions.create(
        model=OPENAI_MODEL,
        messages=messages,
        temperature=0.2,
        max_tokens=500,
    )
    prompt_tokens = completion.usage.prompt_tokens
    completion_tokens = completion.usage.completion_tokens
    total_tokens = completion.usage.total_tokens
    log_token_usage(prompt_tokens, completion_tokens, total_tokens)
    return completion.choices[0].message.content.strip()


async def get_gpt_response(user_text: str, history: list[dict]) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ GPT —Å —Ç–∞–π–º–∞—É—Ç–æ–º OPENAI_TIMEOUT —Å–µ–∫—É–Ω–¥."""
    messages = [{"role": "system", "content": FULL_SYSTEM_PROMPT}]
    messages.extend(history)
    messages.append({"role": "user", "content": user_text})

    try:
        return await asyncio.wait_for(
            _call_openai(messages),
            timeout=OPENAI_TIMEOUT,
        )
    except asyncio.TimeoutError:
        logger.error("–¢–∞–π–º–∞—É—Ç OpenAI (%d —Å–µ–∫) –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: %r", OPENAI_TIMEOUT, user_text[:80])
        return FALLBACK_RESPONSE
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
        return FALLBACK_RESPONSE

# ================== –ö–≠–® –û–¢–í–ï–¢–û–í –ù–ê –ö–ù–û–ü–ö–ò ==================
_button_cache: dict[str, tuple[str, float]] = {}


def _get_from_cache(button_data: str) -> str | None:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ None, –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç/–∏—Å—Ç—ë–∫."""
    if button_data not in _button_cache:
        return None
    response, cached_at = _button_cache[button_data]
    if time.time() - cached_at >= CACHE_TTL:
        del _button_cache[button_data]
        return None
    return response


def _put_to_cache(button_data: str, response: str) -> None:
    _button_cache[button_data] = (response, time.time())


# ================== –†–ê–ë–û–¢–ê –° –ò–°–¢–û–†–ò–ï–ô –î–ò–ê–õ–û–ì–ê ==================
def get_history(context: ContextTypes.DEFAULT_TYPE) -> list[dict]:
    if "history" not in context.chat_data:
        context.chat_data["history"] = []
    return context.chat_data["history"]


def append_to_history(context: ContextTypes.DEFAULT_TYPE, role: str, content: str) -> None:
    history = get_history(context)
    history.append({"role": role, "content": content})
    if len(history) > MAX_HISTORY:
        context.chat_data["history"] = history[-MAX_HISTORY:]


def _check_consent(context: ContextTypes.DEFAULT_TYPE, user_id) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –∫—ç—à –≤ chat_data, –ø–æ—Ç–æ–º CSV."""
    if context.chat_data.get("consent"):
        return True
    if has_consent(user_id):
        context.chat_data["consent"] = True
        return True
    return False


def _ensure_fresh_session(context: ContextTypes.DEFAULT_TYPE, chat_id: int) -> None:
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–Ω—è."""
    today = dt.date.today().isoformat()
    if context.chat_data.get("last_active_date") == today:
        return
    context.chat_data["history"] = []
    context.chat_data["rated"] = False
    context.chat_data["booking_confirmed"] = False
    context.chat_data["booking_logged"] = False
    context.chat_data["greeted"] = False
    context.chat_data["awaiting_consultation_priority"] = False
    context.chat_data["consultation_base_request"] = ""
    context.chat_data["consultation_priority"] = ""
    context.chat_data["last_active_date"] = today
    _cancel_user_timers(context.job_queue, chat_id)
    logger.info("–ù–æ–≤—ã–π –¥–µ–Ω—å ‚Äî —Å–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞ –¥–ª—è —á–∞—Ç–∞ %s", chat_id)


# ================== –¢–ê–ô–ú–ï–†–´: –û–¶–ï–ù–ö–ê –ò –ü–û–í–¢–û–†–ù–û–ï –í–û–í–õ–ï–ß–ï–ù–ò–ï ==================
def _cancel_jobs(job_queue, name: str) -> None:
    """–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º."""
    if not job_queue:
        return
    for job in job_queue.get_jobs_by_name(name):
        job.schedule_removal()


def _cancel_user_timers(job_queue, chat_id: int) -> None:
    """–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã (–æ—Ü–µ–Ω–∫–∞ + follow-up) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞."""
    _cancel_jobs(job_queue, f"rating_{chat_id}")
    _cancel_jobs(job_queue, f"followup_{chat_id}")


def _schedule_rating(context: ContextTypes.DEFAULT_TYPE, chat_id: int) -> None:
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏ —á–µ—Ä–µ–∑ RATING_DELAY —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    if not context.job_queue:
        return
    if not context.chat_data.get("booking_confirmed"):
        return
    if context.chat_data.get("rated"):
        return
    name = f"rating_{chat_id}"
    _cancel_jobs(context.job_queue, name)
    context.job_queue.run_once(
        _send_rating_request,
        when=RATING_DELAY,
        chat_id=chat_id,
        name=name,
    )


def _schedule_followup(context: ContextTypes.DEFAULT_TYPE, chat_id: int,
                        user_id: int, topic: str) -> None:
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ FOLLOWUP_DELAY —Å–µ–∫—É–Ω–¥."""
    if not context.job_queue:
        return
    name = f"followup_{chat_id}"
    _cancel_jobs(context.job_queue, name)
    context.job_queue.run_once(
        _send_followup,
        when=FOLLOWUP_DELAY,
        chat_id=chat_id,
        name=name,
        data={"user_id": user_id, "topic": topic},
    )


async def _send_rating_request(context: ContextTypes.DEFAULT_TYPE) -> None:
    """Job-callback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏."""
    chat_id = context.job.chat_id
    try:
        await context.bot.send_message(
            chat_id=chat_id,
            text=(
                "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é? üôè\n"
                "–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ!"
            ),
            reply_markup=RATING_KEYBOARD,
        )
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏ –≤ %s: %s", chat_id, e)


async def _send_followup(context: ContextTypes.DEFAULT_TYPE) -> None:
    """Job-callback: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞."""
    chat_id = context.job.chat_id
    data = context.job.data or {}
    user_id = data.get("user_id")

    if user_id and not has_consent(user_id):
        return

    topic = data.get("topic", "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    text = (
        f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üëã\n\n"
        f"–í—ã –Ω–µ–¥–∞–≤–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å {topic}. "
        f"–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è?\n\n"
        f"–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
        f"{PHONE_LINE}"
    )
    try:
        await context.bot.send_message(
            chat_id=chat_id,
            text=text,
            reply_markup=BOOKING_KEYBOARD,
        )
        logger.info("Follow-up –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç %s (—Ç–µ–º–∞: %s)", chat_id, topic)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å follow-up –≤ %s: %s", chat_id, e)


def _estimate_booking_amount(service_topic: str) -> int:
    """–û—Ü–µ–Ω–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ –ø–æ —Ç–µ–º–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞."""
    topic = (service_topic or "").lower()
    pricing_rules = [
        (("–±—ã—Å—Ç—Ä", "–¥–≤—É—Ö—Ñ–∞–∑"), 3000),
        (("–∫–æ–º–ø–ª–µ–∫—Å–Ω", "–º–æ–π–∫"), 8000),
        (("–¥–µ–∫–æ–Ω—Ç–∞–º"), 6000),
        (("–ø–æ–¥–∫–∞–ø–æ—Ç"), 9000),
        (("–ø–æ–ª–∏—Ä–æ–≤",), 25000),
        (("–∫–µ—Ä–∞–º–∏—á",), 5000),
        (("–∏–Ω—Ç–µ—Ä—å–µ—Ä", "—Å–∞–ª–æ–Ω", "—Ö–∏–º—á–∏—Å—Ç"), 28000),
        (("–ø–ª–µ–Ω–∫", "ppf", "–±—Ä–æ–Ω"), 30000),
        (("—Å–∫–æ–ª", "—Ç—Ä–µ—â–∏–Ω"), 3500),
        (("—Å–∞–º–æ–æ–±—Å–ª—É–∂",), 700),
    ]
    for keywords, amount in pricing_rules:
        if any(keyword in topic for keyword in keywords):
            return amount
    return 3000


# ================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message is None:
        return

    args = context.args
    source = args[0] if args else "unknown"

    user_id = update.effective_user.id if update.effective_user else "unknown"
    logger.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %s –Ω–∞—á–∞–ª —á–∞—Ç –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: %s", user_id, source)

    log_new_client(user_id, source)

    context.chat_data["history"] = []
    context.chat_data["rated"] = False
    context.chat_data["booking_confirmed"] = False
    context.chat_data["booking_logged"] = False
    context.chat_data["awaiting_consultation_priority"] = False
    context.chat_data["consultation_base_request"] = ""
    context.chat_data["consultation_priority"] = ""
    context.chat_data["last_active_date"] = dt.date.today().isoformat()
    _cancel_user_timers(context.job_queue, update.effective_chat.id)

    if has_consent(user_id):
        context.chat_data["consent"] = True
        context.chat_data["greeted"] = True
        greeting = (
            "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! üëã\n\n"
            "–Ø ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ "
            "BEARLAKE DETAILING & SHOP üêª\n\n"
            "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É, —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ü–µ–Ω–∞—Ö "
            "–∏ —É—Å–ª–æ–≤–∏—è—Ö, –∞ —Ç–∞–∫–∂–µ –∑–∞–ø–∏—à—É –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚¨áÔ∏è "
            "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!"
        )
        append_to_history(context, "assistant", greeting)
        await update.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)
    else:
        consent_text = (
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã\n\n"
            "–Ø ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ "
            "BEARLAKE DETAILING & SHOP üêª\n\n"
            "–î–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º:\n"
            "‚Ä¢ –í–∞—à Telegram ID\n"
            "‚Ä¢ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ\n"
            "‚Ä¢ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏–π\n\n"
            "–î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è "
            "–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É—Å–ª—É–≥–∞–º —Å—Ç—É–¥–∏–∏.\n\n"
            "üìÑ –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî /privacy\n\n"
            "–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω–∏–º–∞—é¬ª, –≤—ã –¥–∞—ë—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ "
            "–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö "
            "–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–ó-152."
        )
        await update.message.reply_text(consent_text, reply_markup=CONSENT_KEYBOARD)


def extract_booking_marker(text: str) -> tuple[str, bool]:
    """–£–±–∏—Ä–∞–µ—Ç –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –∏–∑ —Ç–µ–∫—Å—Ç–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç, –±—ã–ª –ª–∏ –º–∞—Ä–∫–µ—Ä)."""
    if BOOKING_MARKER in text:
        return text.replace(BOOKING_MARKER, "").strip(), True
    return text, False


URL_RE = re.compile(r"https?://[^\s)>\]]+")
MD_LINK_RE = re.compile(r"\[([^\]]+)\]\((https?://[^\s)]+)\)")


def _extract_links(text: str) -> tuple[str, list[tuple[str | None, str]]]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç URL (–≤ —Ç.—á. markdown-—Å—Å—ã–ª–∫–∏), —É–¥–∞–ª—è—è –∏—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
    links: list[tuple[str | None, str]] = []

    def md_repl(match: re.Match) -> str:
        label = match.group(1).strip()
        url = match.group(2).strip()
        links.append((label, url))
        return label

    text = MD_LINK_RE.sub(md_repl, text)

    def url_repl(match: re.Match) -> str:
        raw = match.group(0)
        url = raw.rstrip(".,);")
        if url:
            links.append((None, url))
        trailing = raw[len(url):]
        return trailing

    text = URL_RE.sub(url_repl, text)
    text = re.sub(r"[ \t]+\n", "\n", text)
    text = re.sub(r"\n{3,}", "\n\n", text).strip()
    return text, links


def _button_from_link(label: str | None, url: str) -> InlineKeyboardButton:
    """–ü–æ–¥–±–∏—Ä–∞–µ—Ç –∫–Ω–æ–ø–∫—É-–∏–∫–æ–Ω–∫—É –ø–æ–¥ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏."""
    low = url.lower()
    if "n1024167.yclients.com" in low:
        return InlineKeyboardButton(
            "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω",
            web_app=WebAppInfo(url="https://n1024167.yclients.com/"),
        )
    if "yandex.ru/maps" in low:
        return InlineKeyboardButton("üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã", url=url)
    if "t.me/bearlake_detailing" in low:
        return InlineKeyboardButton("üî• Telegram-–∫–∞–Ω–∞–ª", url=url)
    if "ozon.ru" in low:
        return InlineKeyboardButton("üõí Ozon", url=url)
    if "bearlake.clients.site" in low:
        return InlineKeyboardButton("üè™ –°–∞–π—Ç —Å—Ç—É–¥–∏–∏", url=url)
    if "avito.ru" in low:
        return InlineKeyboardButton("üßæ Avito", url=url)
    if label:
        short = label.strip()
        if len(short) > 22:
            short = short[:19] + "..."
        return InlineKeyboardButton(f"üîó {short}", url=url)
    return InlineKeyboardButton("üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É", url=url)


def _button_key(button: InlineKeyboardButton) -> tuple[str, str, str]:
    web_app = getattr(button, "web_app", None)
    if web_app and getattr(web_app, "url", None):
        return ("web_app", button.text, web_app.url)
    return ("url", button.text, button.url or "")


def _build_reply_markup(
    show_booking: bool,
    links: list[tuple[str | None, str]],
    base_markup: InlineKeyboardMarkup | None = None,
) -> InlineKeyboardMarkup | None:
    """–°–æ–±–∏—Ä–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: –±–∞–∑–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ + –∑–∞–ø–∏—Å—å + —Å—Å—ã–ª–∫–∏-–∏–∫–æ–Ω–∫–∏."""
    rows: list[list[InlineKeyboardButton]] = []
    if base_markup:
        rows.extend([list(row) for row in base_markup.inline_keyboard])
    if show_booking:
        rows.extend([list(row) for row in BOOKING_KEYBOARD.inline_keyboard])

    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏ –ø–æ –≤—Å–µ–º –∫–Ω–æ–ø–∫–∞–º (–±–∞–∑–∞ + –∑–∞–ø–∏—Å—å + —Å—Å—ã–ª–∫–∏),
    # —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤—É—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω".
    dedup_rows: list[list[InlineKeyboardButton]] = []
    seen: set[tuple[str, str, str]] = set()
    for row in rows:
        dedup_row: list[InlineKeyboardButton] = []
        for btn in row:
            key = _button_key(btn)
            if key in seen:
                continue
            seen.add(key)
            dedup_row.append(btn)
        if dedup_row:
            dedup_rows.append(dedup_row)
    rows = dedup_rows

    for label, url in links:
        button = _button_from_link(label, url)
        key = _button_key(button)
        if key in seen:
            continue
        rows.append([button])
        seen.add(key)

    return InlineKeyboardMarkup(rows) if rows else None


def _with_detail_button(
    markup: InlineKeyboardMarkup | None,
    callback_data: str,
) -> InlineKeyboardMarkup | None:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ '–ü–æ–¥—Ä–æ–±–Ω–µ–µ/–ü–æ–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ' –¥–ª—è –∫—Ä–∞—Ç–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ª—É–≥–∏."""
    if callback_data not in DETAILABLE_CALLBACKS:
        return markup
    detail_btn = InlineKeyboardButton("‚úÖ –î–∞, —Ö–æ—á—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data=f"detail::{callback_data}")
    skip_btn = InlineKeyboardButton("üëå –ü–æ–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ", callback_data=f"detail_skip::{callback_data}")
    if markup is None:
        return InlineKeyboardMarkup([[detail_btn], [skip_btn]])

    rows = [list(row) for row in markup.inline_keyboard]
    seen = {_button_key(btn) for row in rows for btn in row}
    detail_key = _button_key(detail_btn)
    skip_key = _button_key(skip_btn)
    to_add: list[InlineKeyboardButton] = []
    if detail_key not in seen:
        to_add.append(detail_btn)
    if skip_key not in seen:
        to_add.append(skip_btn)
    if to_add:
        rows.append(to_add)
    return InlineKeyboardMarkup(rows)


def _with_detail_offer(text: str, callback_data: str) -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç callout –∫ –∫–Ω–æ–ø–∫–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –ø–æ—Å–ª–µ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞."""
    if callback_data not in DETAILABLE_CALLBACKS:
        return text
    low = text.lower()
    if "—Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –æ–± —É—Å–ª—É–≥–µ –±–æ–ª—å—à–µ" in low or "—Ö–æ—á—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ" in low:
        return text
    return f"{text}\n\n–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –æ–± —É—Å–ª—É–≥–µ –±–æ–ª—å—à–µ? –ù–∞–∂–º–∏—Ç–µ ¬´‚úÖ –î–∞, —Ö–æ—á—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ¬ª üëá"


async def send_answer(
    message,
    text: str,
    force_booking: bool = False,
    user_lang: str = "ru",
) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—è –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –º–∞—Ä–∫–µ—Ä–µ."""
    clean_text, has_marker = extract_booking_marker(text)
    clean_text = _with_sales_cta(clean_text)
    clean_text, links = _extract_links(clean_text)
    show_booking = has_marker or force_booking
    if show_booking:
        clean_text += PHONE_LINE
    clean_text = await _finalize_response_text(clean_text, user_lang)
    reply_markup = _build_reply_markup(show_booking, links)
    await message.reply_text(
        clean_text,
        reply_markup=reply_markup,
        disable_web_page_preview=True,
    )


def _with_sales_cta(text: str) -> str:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –º—è–≥–∫–∏–π –ø—Ä–æ–¥–∞—é—â–∏–π CTA –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞."""
    default_cta = (
        "–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥ –≤–∞—à –∞–≤—Ç–æ "
        "–∏ —Å—Ä–∞–∑—É —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ –∏ —Å—Ä–æ–∫–∞–º ‚úÖ"
    )
    text_lower = text.lower()

    if "–º–æ–π–∫" in text_lower:
        cta = "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –ø–æ–¥—Å–∫–∞–∂—É –∫–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –º–æ–π–∫–∏ –ª—É—á—à–µ –∏–º–µ–Ω–Ω–æ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É –∏ –≤—Ä–µ–º—è ‚è±Ô∏è"
    elif "–ø–æ–ª–∏—Ä–æ–≤" in text_lower:
        cta = "–ú–æ–≥—É —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–ª–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—É—á–∏—Ç–µ –Ω–∞ –≤–∞—à–µ–º –∞–≤—Ç–æ –∏ —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∑–∞–π–º–µ—Ç ‚ú®"
    elif "–∫–µ—Ä–∞–º–∏—á" in text_lower or "–ø–ª–µ–Ω–∫" in text_lower or "–∑–∞—â–∏—Ç" in text_lower:
        cta = "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É –ø–æ —Å—Ä–æ–∫—É —Å–ª—É–∂–±—ã –∏ –±—é–¥–∂–µ—Ç—É üõ°Ô∏è"
    elif "—Å–∞–ª–æ–Ω" in text_lower or "—Ö–∏–º—á–∏—Å—Ç" in text_lower or "–∏–Ω—Ç–µ—Ä—å–µ—Ä" in text_lower:
        cta = "–ü–æ–¥—Å–∫–∞–∂—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—Ö–æ–¥–∞ –∑–∞ —Å–∞–ª–æ–Ω–æ–º –ø–æ–¥ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –±—é–¥–∂–µ—Ç üßº"
    elif "—Å–∞–º–æ–æ–±—Å–ª—É–∂" in text_lower or "700 ‚ÇΩ/—á–∞—Å" in text_lower or "900 ‚ÇΩ/—á–∞—Å" in text_lower:
        cta = "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –ø–æ–¥—Å–∫–∞–∂—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ø–æ–¥ –≤–∞—à —Å—Ü–µ–Ω–∞—Ä–∏–π üöø"
    elif "—Ü–µ–Ω" in text_lower or "–ø—Ä–∞–π—Å" in text_lower or "—Å—Ç–æ–∏–º" in text_lower:
        cta = "–ú–æ–≥—É —Å—Ä–∞–∑—É —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ –∏ —Å—Ä–æ–∫–∞–º –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ (S / M / L) üí∞"
    else:
        cta = default_cta

    if cta in text or default_cta in text:
        return text
    if text == FALLBACK_RESPONSE:
        return text
    if "–≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ" in text_lower:
        return text
    if "–≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–∏–∂–µ" in text_lower:
        return text
    if "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ" in text_lower:
        return text
    return f"{text}\n\n{cta}"


async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏ –ø–æ–¥–º–µ–Ω—é."""
    query = update.callback_query
    try:
        await query.answer()
    except Exception:
        pass

    user_id = update.effective_user.id if update.effective_user else "unknown"

    if query.data and query.data.startswith("detail::"):
        source_cb = query.data.split("::", 1)[1]
        user_text = MENU_PROMPTS.get(source_cb) or f"–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ {TOPIC_LABELS.get(source_cb, '—É—Å–ª—É–≥—É')}"
        kb_answer, kb_score, kb_question = _find_kb_answer(user_text)
        if kb_answer:
            _log_kb_match(user_id, user_text, kb_question, kb_score, "matched")
            detail_text = f"{kb_answer}\n\n–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è [–ó–ê–ü–ò–°–¨]"
            append_to_history(context, "user", user_text)
            append_to_history(context, "assistant", detail_text)
            await send_answer(query.message, detail_text)
        else:
            if kb_question:
                _log_kb_match(user_id, user_text, kb_question, kb_score, "no_match")
            fallback = (
                "–°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É –∫—Ä–∞—Ç–∫–æ –ø–æ —ç—Ç–æ–π —É—Å–ª—É–≥–µ, –∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ "
                "–ø–æ–¥ –≤–∞—à –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ–º–æ–≥—É –≤ —á–∞—Ç–µ.\n\n"
                "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è [–ó–ê–ü–ò–°–¨]"
            )
            append_to_history(context, "assistant", fallback)
            await send_answer(query.message, fallback, force_booking=True)

        topic = TOPIC_LABELS.get(source_cb, "—É—Å–ª—É–≥–æ–π")
        context.chat_data["last_topic"] = topic
        _schedule_followup(context, query.message.chat_id, user_id, topic)
        return

    if query.data and query.data.startswith("detail_skip::"):
        source_cb = query.data.split("::", 1)[1]
        short_ack = (
            "–û—Ç–ª–∏—á–Ω–æ, –æ—Å—Ç–∞–≤–∏–º –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç üëç\n"
            "–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ, –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –¥–∞–º –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∏–º–µ–Ω–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∞–≤—Ç–æ.\n\n"
            "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è [–ó–ê–ü–ò–°–¨]"
        )
        append_to_history(context, "assistant", short_ack)
        await send_answer(query.message, short_ack)
        topic = TOPIC_LABELS.get(source_cb, "—É—Å–ª—É–≥–æ–π")
        context.chat_data["last_topic"] = topic
        _schedule_followup(context, query.message.chat_id, user_id, topic)
        return

    if query.data == "consent_accept":
        log_consent(user_id)
        context.chat_data["consent"] = True
        context.chat_data["greeted"] = True
        context.chat_data["history"] = []
        context.chat_data["booking_confirmed"] = False
        context.chat_data["booking_logged"] = False
        context.chat_data["awaiting_consultation_priority"] = False
        context.chat_data["consultation_base_request"] = ""
        context.chat_data["consultation_priority"] = ""
        greeting = (
            "–°–ø–∞—Å–∏–±–æ! –°–æ–≥–ª–∞—Å–∏–µ –ø—Ä–∏–Ω—è—Ç–æ ‚úÖ\n\n"
            "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É, —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ü–µ–Ω–∞—Ö "
            "–∏ —É—Å–ª–æ–≤–∏—è—Ö, –∞ —Ç–∞–∫–∂–µ –∑–∞–ø–∏—à—É –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚¨áÔ∏è "
            "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!"
        )
        append_to_history(context, "assistant", greeting)
        await query.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)
        return

    if query.data == "booking_done":
        if not context.chat_data.get("booking_logged"):
            service_topic = context.chat_data.get("last_topic", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
            amount_from = _estimate_booking_amount(service_topic)
            log_booking(user_id, service_topic, amount_from)
            context.chat_data["booking_logged"] = True
        context.chat_data["booking_confirmed"] = True
        context.chat_data["rated"] = False
        _cancel_jobs(context.job_queue, f"followup_{query.message.chat_id}")
        _schedule_rating(context, query.message.chat_id)
        await query.message.reply_text(
            "–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! ‚úÖ\n"
            "–ß–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç –ø–æ–ø—Ä–æ—à—É –∫–æ—Ä–æ—Ç–∫–æ –æ—Ü–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é."
        )
        return

    if query.data and query.data.startswith("rate_"):
        rating = int(query.data.split("_")[1])
        log_rating(user_id, rating)
        logger.info("–û—Ü–µ–Ω–∫–∞ –æ—Ç %s: %d ‚≠ê", user_id, rating)
        context.chat_data["rated"] = True
        _cancel_jobs(context.job_queue, f"rating_{query.message.chat_id}")
        if rating >= 4:
            text = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã—Å–æ–∫—É—é –æ—Ü–µ–Ω–∫—É! üåü –†–∞–¥—ã, —á—Ç–æ —Å–º–æ–≥–ª–∏ –ø–æ–º–æ—á—å!"
        else:
            text = (
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! üôè –ú—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è —Å—Ç–∞—Ç—å –ª—É—á—à–µ.\n"
                "–ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å "
                "—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: +7 (926) 021-60-00"
            )
        await query.message.reply_text(text)
        return

    if not _check_consent(context, user_id):
        await query.message.reply_text(NO_CONSENT_TEXT)
        return

    _ensure_fresh_session(context, query.message.chat_id)

    if query.data == "menu_advantages":
        log_button_click(user_id, query.data)
        append_to_history(context, "assistant", ADVANTAGES_ANSWER)
        await send_answer(query.message, ADVANTAGES_ANSWER, force_booking=True)
        chat_id = query.message.chat_id
        _schedule_followup(context, chat_id, user_id, "–Ω–∞—à–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏")
        return

    if query.data in {"menu_prices", "sub_all_prices"}:
        log_button_click(user_id, query.data)
        user_text = MENU_PROMPTS.get(query.data, "–ö–∞–∫–∏–µ —É –≤–∞—Å —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏?")
        append_to_history(context, "user", user_text)
        append_to_history(context, "assistant", PRICES_ANSWER)
        await send_answer(query.message, PRICES_ANSWER, force_booking=True)
        chat_id = query.message.chat_id
        _schedule_followup(context, chat_id, user_id, "—Ü–µ–Ω–∞–º–∏ –Ω–∞ —É—Å–ª—É–≥–∏")
        return

    if query.data == "menu_shop":
        log_button_click(user_id, query.data)
        answer = _with_sales_cta("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–∏–∂–µ ‚¨áÔ∏è")
        append_to_history(context, "assistant", answer)
        await query.message.reply_text(
            answer,
            reply_markup=SHOP_KEYBOARD,
            disable_web_page_preview=True,
        )
        chat_id = query.message.chat_id
        _schedule_followup(context, chat_id, user_id, "–º–∞–≥–∞–∑–∏–Ω–æ–º –∞–≤—Ç–æ—Ö–∏–º–∏–∏")
        return

    if query.data in {"sub_shop_recommend", "sub_shop_ozon", "sub_shop_discounts"}:
        log_button_click(user_id, query.data)
        user_text = MENU_PROMPTS.get(query.data, "")
        if user_text:
            append_to_history(context, "user", user_text)
        if query.data == "sub_shop_recommend":
            answer = _with_sales_cta(SHOP_RECOMMEND_ANSWER)
        elif query.data == "sub_shop_ozon":
            answer = _with_sales_cta(SHOP_OZON_ANSWER)
        else:
            answer = _with_sales_cta(SHOP_DISCOUNTS_ANSWER)
        append_to_history(context, "assistant", answer)
        await query.message.reply_text(
            answer,
            reply_markup=SHOP_KEYBOARD,
            disable_web_page_preview=True,
        )
        chat_id = query.message.chat_id
        topic = TOPIC_LABELS.get(query.data, "–º–∞–≥–∞–∑–∏–Ω–æ–º –∞–≤—Ç–æ—Ö–∏–º–∏–∏")
        _schedule_followup(context, chat_id, user_id, topic)
        return

    user_text = MENU_PROMPTS.get(query.data)
    if not user_text:
        return

    chat_id = query.message.chat_id

    logger.info("–ö–Ω–æ–ø–∫–∞ –æ—Ç %s: %s ‚Üí %r", user_id, query.data, user_text)
    log_button_click(user_id, query.data)
    log_question(user_id, user_text)

    ai_first = query.data in AI_FIRST_BUTTON_CALLBACKS
    static_answer = STATIC_MENU_ANSWERS.get(query.data)
    if static_answer and not ai_first:
        answer = static_answer
    else:
        answer = None
        if ai_first:
            kb_answer, kb_score, kb_question = _find_kb_answer(user_text)
            if kb_answer:
                answer = kb_answer
                _log_kb_match(user_id, user_text, kb_question, kb_score, "matched")
            elif kb_question:
                _log_kb_match(user_id, user_text, kb_question, kb_score, "no_match")

        if answer is None:
            cached = _get_from_cache(query.data)
            if cached:
                logger.info("–ö—ç—à-–ø–æ–ø–∞–¥–∞–Ω–∏–µ: %s", query.data)
                answer = cached
            else:
                try:
                    await context.bot.send_chat_action(chat_id=chat_id, action="typing")
                except Exception as e:
                    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 'typing': %s", e)

                history = get_history(context)
                answer = await get_gpt_response(user_text, history)

                if answer != FALLBACK_RESPONSE:
                    _put_to_cache(query.data, answer)

    append_to_history(context, "user", user_text)
    append_to_history(context, "assistant", answer)

    sub_menu = SUB_MENUS.get(query.data)
    if sub_menu:
        clean_text, has_marker = extract_booking_marker(answer)
        clean_text = _with_sales_cta(clean_text)
        clean_text = _with_detail_offer(clean_text, query.data)
        clean_text, links = _extract_links(clean_text)
        reply_markup = _build_reply_markup(has_marker, links, base_markup=sub_menu)
        reply_markup = _with_detail_button(reply_markup, query.data)
        await query.message.reply_text(
            clean_text,
            reply_markup=reply_markup,
            disable_web_page_preview=True,
        )
    else:
        if query.data in DETAILABLE_CALLBACKS:
            clean_text, has_marker = extract_booking_marker(answer)
            clean_text = _with_sales_cta(clean_text)
            clean_text = _with_detail_offer(clean_text, query.data)
            clean_text, links = _extract_links(clean_text)
            reply_markup = _build_reply_markup(has_marker, links)
            reply_markup = _with_detail_button(reply_markup, query.data)
            await query.message.reply_text(
                clean_text,
                reply_markup=reply_markup,
                disable_web_page_preview=True,
            )
        else:
            await send_answer(query.message, answer)

    topic = TOPIC_LABELS.get(query.data, "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    context.chat_data["last_topic"] = topic
    _schedule_followup(context, chat_id, user_id, topic)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message is None or update.message.text is None:
        return

    user_text = update.message.text.strip()
    user_lang = _detect_user_language(user_text)
    chat_id = update.effective_chat.id
    user_id = update.effective_user.id if update.effective_user else "unknown"

    if not _check_consent(context, user_id):
        consent_text = await _finalize_response_text(NO_CONSENT_TEXT, user_lang)
        await update.message.reply_text(consent_text)
        return

    _ensure_fresh_session(context, chat_id)

    if not context.chat_data.get("greeted"):
        context.chat_data["greeted"] = True
        greeting = (
            "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! üëã\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚¨áÔ∏è"
        )
        greeting = await _finalize_response_text(greeting, user_lang)
        await update.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)

    logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç %s: %r", user_id, user_text)

    log_question(user_id, user_text)

    if _is_short_followup_request(user_text):
        last_topic = context.chat_data.get("last_topic", "")
        contextual = _context_followup_answer(last_topic)
        if contextual:
            contextual = await _finalize_response_text(contextual, user_lang)
            append_to_history(context, "user", user_text)
            append_to_history(context, "assistant", contextual)
            await send_answer(update.message, contextual, user_lang=user_lang)
            _schedule_followup(context, chat_id, user_id, last_topic or "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
            return

    if context.chat_data.get("awaiting_consultation_priority"):
        priority = _detect_consultation_priority(user_text)
        if priority:
            base_request = context.chat_data.get("consultation_base_request") or "–ø–æ–¥–±–æ—Ä —É—Å–ª—É–≥ –ø–æ –∞–≤—Ç–æ"
            history = get_history(context)
            append_to_history(context, "user", user_text)
            refined_query = _build_refined_consultation_query(base_request, priority, user_text)
            answer = await get_gpt_response(refined_query, history)
            append_to_history(context, "assistant", answer)
            await send_answer(update.message, answer, user_lang=user_lang)
            context.chat_data["awaiting_consultation_priority"] = False
            context.chat_data["consultation_priority"] = priority
            context.chat_data["last_topic"] = "–ø–æ–¥–±–æ—Ä–æ–º —É—Å–ª—É–≥ –ø–æ–¥ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞"
            _schedule_followup(context, chat_id, user_id, "–ø–æ–¥–±–æ—Ä–æ–º —É—Å–ª—É–≥ –ø–æ–¥ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞")
            return
        if len(user_text) <= 80:
            answer = (
                "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–¥–±–æ—Ä, –Ω–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: "
                "—Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –±—é–¥–∂–µ—Ç."
            )
            answer = await _finalize_response_text(answer, user_lang)
            append_to_history(context, "user", user_text)
            append_to_history(context, "assistant", answer)
            await update.message.reply_text(answer)
            return
        context.chat_data["awaiting_consultation_priority"] = False

    if not _is_on_topic(user_text):
        answer = (
            "–í–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞. "
            "–î–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω—ë–º—Å—è –∫ —É—Å–ª—É–≥–∞–º —Å—Ç—É–¥–∏–∏: –º–æ–π–∫–∞, –ø–æ–ª–∏—Ä–æ–≤–∫–∞, –∑–∞—â–∏—Ç–∞, "
            "—Å–∞–ª–æ–Ω, —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, —Ü–µ–Ω—ã, –∞–¥—Ä–µ—Å –∏–ª–∏ –∑–∞–ø–∏—Å—å."
        )
        answer = await _finalize_response_text(answer, user_lang)
        append_to_history(context, "user", user_text)
        append_to_history(context, "assistant", answer)
        await update.message.reply_text(answer, reply_markup=GREETING_KEYBOARD)
        _schedule_followup(context, chat_id, user_id, "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
        return

    text_lower = user_text.lower()
    priority_intent = _detect_priority_intent(text_lower)
    if priority_intent:
        intent, candidates = priority_intent, [priority_intent]
    else:
        intent, candidates = _detect_text_intent(text_lower)
    kb_answer, kb_score, kb_question = _find_kb_answer(user_text)
    is_complex = _is_complex_consultation(user_text)

    prefer_static = bool(priority_intent) or (intent in STRICT_TEXT_INTENTS if intent else False)

    # –î–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫: —Å–Ω–∞—á–∞–ª–∞ KB, –∑–∞—Ç–µ–º GPT.
    if kb_answer and not prefer_static and not is_complex:
        _log_kb_match(user_id, user_text, kb_question, kb_score, "matched")
        append_to_history(context, "user", user_text)
        append_to_history(context, "assistant", kb_answer)
        await send_answer(update.message, kb_answer, user_lang=user_lang)
        context.chat_data["last_topic"] = "–≤–æ–ø—Ä–æ—Å–æ–º –ø–æ —É—Å–ª—É–≥–∞–º"
        _schedule_followup(context, chat_id, user_id, "–≤–æ–ø—Ä–æ—Å–æ–º –ø–æ —É—Å–ª—É–≥–∞–º")
        logger.info("–û—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (score=%.2f) –¥–ª—è %s: %r", kb_score, user_id, user_text[:80])
        return
    if kb_question:
        _log_kb_match(user_id, user_text, kb_question, kb_score, "no_match")
    elif intent:
        _log_kb_match(user_id, user_text, None, 0.0, "fallback_intent")

    if not prefer_static:
        history = get_history(context)
        append_to_history(context, "user", user_text)
        gpt_query = _build_consultation_query(user_text) if is_complex else user_text
        answer = await get_gpt_response(gpt_query, history)
        if is_complex:
            followup = _consultation_followup_question(user_text, answer)
            if followup not in answer:
                answer = f"{answer}\n\n{followup}"
            context.chat_data["awaiting_consultation_priority"] = True
            context.chat_data["consultation_base_request"] = user_text
        append_to_history(context, "assistant", answer)
        await send_answer(update.message, answer, user_lang=user_lang)
        context.chat_data["last_topic"] = "–≤–æ–ø—Ä–æ—Å–æ–º –ø–æ —É—Å–ª—É–≥–∞–º"
        _schedule_followup(context, chat_id, user_id, "–≤–æ–ø—Ä–æ—Å–æ–º –ø–æ —É—Å–ª—É–≥–∞–º")
        return

    if not intent:
        if candidates:
            candidate_labels = [
                f"‚Ä¢ {INTENT_CLARIFY_LABELS.get(candidate, candidate)}"
                for candidate in candidates[:4]
            ]
            answer = (
                "–•–æ—á—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–æ—á–Ω–æ, –Ω–æ –∑–∞–ø—Ä–æ—Å —Å–µ–π—á–∞—Å –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π.\n"
                "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:\n"
                f"{chr(10).join(candidate_labels)}"
            )
        else:
            answer = (
                "–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ ‚¨áÔ∏è\n\n"
                "–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ—Ä–æ—á–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´—Ü–µ–Ω—ã¬ª, ¬´–º–æ–π–∫–∞¬ª, ¬´–ø–æ–ª–∏—Ä–æ–≤–∫–∞¬ª, "
                "¬´—Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ¬ª, ¬´–∞–¥—Ä–µ—Å¬ª, ¬´—Å–∫–∏–¥–∫–∏¬ª."
            )
        answer = _with_sales_cta(answer)
        answer = await _finalize_response_text(answer, user_lang)
        append_to_history(context, "user", user_text)
        append_to_history(context, "assistant", answer)
        await update.message.reply_text(answer, reply_markup=GREETING_KEYBOARD)
        _schedule_followup(context, chat_id, user_id, "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
        return

    append_to_history(context, "user", user_text)

    if intent == "menu_advantages":
        answer = ADVANTAGES_ANSWER
        append_to_history(context, "assistant", answer)
        await send_answer(update.message, answer, force_booking=True, user_lang=user_lang)
    elif intent in {"menu_prices", "sub_all_prices"}:
        answer = PRICES_ANSWER
        append_to_history(context, "assistant", answer)
        await send_answer(update.message, answer, force_booking=True, user_lang=user_lang)
    elif intent == "menu_shop":
        answer = _with_sales_cta("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–∏–∂–µ ‚¨áÔ∏è")
        answer = await _finalize_response_text(answer, user_lang)
        append_to_history(context, "assistant", answer)
        await update.message.reply_text(answer, reply_markup=SHOP_KEYBOARD)
    elif intent in {"sub_shop_recommend", "sub_shop_ozon", "sub_shop_discounts"}:
        if intent == "sub_shop_recommend":
            answer = _with_sales_cta(SHOP_RECOMMEND_ANSWER)
        elif intent == "sub_shop_ozon":
            answer = _with_sales_cta(SHOP_OZON_ANSWER)
        else:
            answer = _with_sales_cta(SHOP_DISCOUNTS_ANSWER)
        answer = await _finalize_response_text(answer, user_lang)
        append_to_history(context, "assistant", answer)
        await update.message.reply_text(answer, reply_markup=SHOP_KEYBOARD, disable_web_page_preview=True)
    else:
        answer = STATIC_MENU_ANSWERS.get(intent)
        if not answer:
            answer = _with_sales_cta("–í—ã–±–µ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ ‚¨áÔ∏è")
            answer = await _finalize_response_text(answer, user_lang)
            append_to_history(context, "assistant", answer)
            await update.message.reply_text(answer, reply_markup=GREETING_KEYBOARD)
        else:
            append_to_history(context, "assistant", answer)
            sub_menu = SUB_MENUS.get(intent)
            if sub_menu:
                clean_text, has_marker = extract_booking_marker(answer)
                clean_text = _with_sales_cta(clean_text)
                clean_text, links = _extract_links(clean_text)
                clean_text = await _finalize_response_text(clean_text, user_lang)
                reply_markup = _build_reply_markup(has_marker, links, base_markup=sub_menu)
                await update.message.reply_text(
                    clean_text,
                    reply_markup=reply_markup,
                    disable_web_page_preview=True,
                )
            else:
                await send_answer(update.message, answer, user_lang=user_lang)

    topic = TOPIC_LABELS.get(intent, "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    context.chat_data["last_topic"] = topic
    _schedule_followup(context, chat_id, user_id, topic)

# ================== –ö–û–ú–ê–ù–î–´ –ü–î ==================
async def privacy_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏."""
    if update.message is None:
        return
    await update.message.reply_text(PRIVACY_TEXT)


async def deletedata_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–∑—ã–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ."""
    if update.message is None:
        return

    user_id = update.effective_user.id if update.effective_user else 0
    _cancel_user_timers(context.job_queue, update.effective_chat.id)
    result = delete_user_data(user_id)
    context.chat_data.clear()

    if result:
        details = "\n".join(f"  ‚Ä¢ {f}: {n} –∑–∞–ø–∏—Å–µ–π" for f, n in result.items())
        text = (
            "‚úÖ –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã:\n"
            f"{details}\n\n"
            "–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–æ–∑–≤–∞–Ω–æ.\n"
            "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ /start"
        )
    else:
        text = (
            "‚ÑπÔ∏è –î–∞–Ω–Ω—ã—Ö –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ ‚Äî /start"
        )

    await update.message.reply_text(text)


# ================== –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–´ ==================
async def report_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
    user_id = update.effective_user.id if update.effective_user else 0
    if ADMIN_USER_ID and user_id != ADMIN_USER_ID:
        await update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    await update.message.reply_text("üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç—á—ë—Ç, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    try:
        text_summary = generate_text_summary()
        report_path = generate_monthly_report()

        await update.message.reply_text(text_summary)
        sent = False
        for attempt in range(2):
            try:
                with open(report_path, "rb") as f:
                    await update.message.reply_document(
                        document=f,
                        filename=os.path.basename(report_path),
                        caption="üìé –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
                        read_timeout=60,
                        write_timeout=60,
                    )
                sent = True
                break
            except TimedOut:
                logger.warning("TimedOut –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á—ë—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ %d/2)", attempt + 1)
                if attempt == 0:
                    await asyncio.sleep(2)
        if not sent:
            await update.message.reply_text(
                "‚ö†Ô∏è –û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.\n"
                "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ /report —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
            )
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: %s", e)
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: {e}")


async def clearcache_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—á–∏—â–∞–µ—Ç –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏."""
    user_id = update.effective_user.id if update.effective_user else 0
    if ADMIN_USER_ID and user_id != ADMIN_USER_ID:
        await update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    count = len(_button_cache)
    _button_cache.clear()
    await update.message.reply_text(f"üóë –ö—ç—à –æ—á–∏—â–µ–Ω ({count} –∑–∞–ø–∏—Å–µ–π)")


# ================== –ê–í–¢–û–û–¢–ß–Å–¢ ==================
async def send_monthly_report(context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü 1-–≥–æ —á–∏—Å–ª–∞."""
    if not ADMIN_USER_ID:
        logger.warning("ADMIN_USER_ID –Ω–µ –∑–∞–¥–∞–Ω, –∞–≤—Ç–æ–æ—Ç—á—ë—Ç –ø—Ä–æ–ø—É—â–µ–Ω.")
        return

    logger.info("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞...")

    try:
        now = dt.datetime.now()
        prev = now.replace(day=1) - dt.timedelta(days=1)

        text_summary = generate_text_summary(prev.year, prev.month)
        report_path = generate_monthly_report(prev.year, prev.month)

        await context.bot.send_message(
            chat_id=ADMIN_USER_ID,
            text=f"üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç\n\n{text_summary}",
        )
        with open(report_path, "rb") as f:
            await context.bot.send_document(
                chat_id=ADMIN_USER_ID,
                document=f,
                filename=os.path.basename(report_path),
                caption="üìé –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
            )
        logger.info("–ê–≤—Ç–æ–æ—Ç—á—ë—Ç –∑–∞ %s-%02d –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.", prev.year, prev.month)
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ—Ç—á—ë—Ç–∞: %s", e)
        try:
            await context.bot.send_message(
                chat_id=ADMIN_USER_ID,
                text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–æ—Ç—á—ë—Ç–∞: {e}",
            )
        except Exception:
            pass


# ================== –ó–ê–ü–£–°–ö ==================
async def post_init(application: Application) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞."""
    await application.bot.set_my_commands([
        BotCommand("start", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand("privacy", "üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏"),
        BotCommand("deletedata", "üóë –£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ"),
    ])
    logger.info("–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–µ–Ω—é Telegram.")


def main() -> None:
    request = HTTPXRequest(
        connect_timeout=10.0,
        read_timeout=30.0,
        write_timeout=30.0,
        pool_timeout=10.0,
    )
    application = (
        Application.builder()
        .token(TELEGRAM_BOT_TOKEN)
        .request(request)
        .post_init(post_init)
        .build()
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("privacy", privacy_command))
    application.add_handler(CommandHandler("deletedata", deletedata_command))
    application.add_handler(CommandHandler("report", report_command))
    application.add_handler(CommandHandler("clearcache", clearcache_command))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    if ADMIN_USER_ID and application.job_queue:
        msk = dt.timezone(dt.timedelta(hours=3))
        application.job_queue.run_monthly(
            send_monthly_report,
            when=dt.time(hour=9, minute=0, tzinfo=msk),
            day=1,
        )
        logger.info("–ê–≤—Ç–æ–æ—Ç—á—ë—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω: 1-–µ —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞, 09:00 –ú–°–ö")

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
    application.run_polling(
        allowed_updates=Update.ALL_TYPES,
        drop_pending_updates=True,
    )


if __name__ == "__main__":
    main()