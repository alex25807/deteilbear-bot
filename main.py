import logging
import os
import asyncio
import time
import datetime as dt
from logging.handlers import RotatingFileHandler
from dotenv import load_dotenv
import pathlib

load_dotenv()

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, BotCommand, WebAppInfo
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)
from telegram.request import HTTPXRequest
import openai

from analytics import (
    log_new_client, log_question, log_token_usage, log_button_click,
    log_rating, generate_monthly_report, generate_text_summary,
    log_consent, has_consent, delete_user_data,
)

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
KNOWLEDGE_FILE_PATH = os.getenv("KNOWLEDGE_FILE_PATH", "knowledges.txt")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
MAX_HISTORY = int(os.getenv("MAX_HISTORY", "20"))
ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID", "0"))
BOOKING_MARKER = "[–ó–ê–ü–ò–°–¨]"
OPENAI_TIMEOUT = int(os.getenv("OPENAI_TIMEOUT", "30"))
RATING_DELAY = int(os.getenv("RATING_DELAY", "300"))
FOLLOWUP_DELAY = int(os.getenv("FOLLOWUP_DELAY", "86400"))
CACHE_TTL = int(os.getenv("CACHE_TTL", "21600"))

if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
if not OPENAI_API_KEY:
    raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")

# ================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==================
pathlib.Path("logs").mkdir(parents=True, exist_ok=True)

logger = logging.getLogger(__name__)
logger.setLevel(getattr(logging, LOG_LEVEL))

formatter = logging.Formatter(
    "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)

file_handler = RotatingFileHandler(
    "logs/bot.log",
    maxBytes=10 * 1024 * 1024,
    backupCount=5,
    encoding="utf-8"
)
file_handler.setFormatter(formatter)
logger.addHandler(file_handler)

console_handler = logging.StreamHandler()
console_handler.setFormatter(formatter)
logger.addHandler(console_handler)

logger.propagate = False

# ================== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==================
BOOKING_KEYBOARD = InlineKeyboardMarkup([
    [InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/"))],
])

PHONE_LINE = "\n\nüìû –ò–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: +7 (926) 021-60-00"

GREETING_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üîß –£—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤", callback_data="menu_services"),
        InlineKeyboardButton("üöø –°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", callback_data="menu_self"),
    ],
    [
        InlineKeyboardButton("üß¥ –ú–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ—Ö–∏–º–∏–∏", callback_data="menu_shop"),
        InlineKeyboardButton("‚òï –ö–æ–º—Ñ–æ—Ä—Ç –≤ —Å—Ç—É–¥–∏–∏", callback_data="menu_comfort"),
    ],
    [
        InlineKeyboardButton("üí∞ –¶–µ–Ω—ã", callback_data="menu_prices"),
        InlineKeyboardButton("üìç –ö–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏", callback_data="menu_address"),
    ],
    [
        InlineKeyboardButton("üèÜ –ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞", callback_data="menu_advantages"),
        InlineKeyboardButton("üéÅ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å", callback_data="menu_bonus"),
    ],
    [
        InlineKeyboardButton("üì∏ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç", callback_data="menu_portfolio"),
        InlineKeyboardButton("üè∑ –°–∫–∏–¥–∫–∏", callback_data="menu_discounts"),
    ],
    [
        InlineKeyboardButton("üî• –ù–æ–≤–∏–Ω–∫–∏ –∏ –∞–∫—Ü–∏–∏", url="https://t.me/bearlake_detailing"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SERVICES_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üöø –ú–æ–π–∫–∞ –∫—É–∑–æ–≤–∞", callback_data="sub_wash"),
        InlineKeyboardButton("‚ú® –ü–æ–ª–∏—Ä–æ–≤–∫–∞", callback_data="sub_polish"),
    ],
    [
        InlineKeyboardButton("üõ° –ó–∞—â–∏—Ç–∞ –õ–ö–ü", callback_data="sub_protection"),
        InlineKeyboardButton("üßπ –î–µ—Ç–µ–π–ª–∏–Ω–≥ —Å–∞–ª–æ–Ω–∞", callback_data="sub_interior"),
    ],
    [
        InlineKeyboardButton("ü™ü –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–ª–∞", callback_data="sub_glass"),
        InlineKeyboardButton("üîß –†–µ–º–æ–Ω—Ç —Å–∫–æ–ª–æ–≤", callback_data="sub_chips"),
    ],
    [
        InlineKeyboardButton("üí∞ –í—Å–µ —Ü–µ–Ω—ã", callback_data="sub_all_prices"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SELF_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", callback_data="sub_self_equip"),
        InlineKeyboardButton("üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å", callback_data="sub_self_price"),
    ],
    [
        InlineKeyboardButton("üìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ", callback_data="sub_self_included"),
        InlineKeyboardButton("‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞", callback_data="sub_self_rules"),
    ],
    [
        InlineKeyboardButton("üß¥ –ö—É–ø–∏—Ç—å –∞–≤—Ç–æ—Ö–∏–º–∏—é", callback_data="menu_shop"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SHOP_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("üß¥ –ß—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ", callback_data="sub_shop_recommend"),
        InlineKeyboardButton("üè∑ –°–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã", callback_data="sub_shop_discounts"),
    ],
    [
        InlineKeyboardButton("üõí –ú–∞–≥–∞–∑–∏–Ω –Ω–∞ Ozon", url="https://ozon.ru/t/bal1Akq"),
        InlineKeyboardButton("üè™ –°–∞–π—Ç —Å—Ç—É–¥–∏–∏", url="https://bearlake.clients.site/"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

COMFORT_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("‚òï –ö–æ—Ñ–µ –∏ –ø–µ—Ä–µ–∫—É—Å—ã", callback_data="sub_comfort_food"),
        InlineKeyboardButton("üì∂ Wi-Fi –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞", callback_data="sub_comfort_wifi"),
    ],
    [
        InlineKeyboardButton("‚ùÑÔ∏è –ö–ª–∏–º–∞—Ç –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏", callback_data="sub_comfort_climate"),
        InlineKeyboardButton("‚ôø –î–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞", callback_data="sub_comfort_access"),
    ],
    [
        InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω", web_app=WebAppInfo(url="https://n1024167.yclients.com/")),
    ],
])

SUB_MENUS = {
    "menu_services": SERVICES_KEYBOARD,
    "menu_self": SELF_KEYBOARD,
    "menu_shop": SHOP_KEYBOARD,
    "menu_comfort": COMFORT_KEYBOARD,
}

CONSENT_KEYBOARD = InlineKeyboardMarkup([
    [InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é", callback_data="consent_accept")],
])

RATING_KEYBOARD = InlineKeyboardMarkup([
    [
        InlineKeyboardButton("1 ‚≠ê", callback_data="rate_1"),
        InlineKeyboardButton("2 ‚≠ê", callback_data="rate_2"),
        InlineKeyboardButton("3 ‚≠ê", callback_data="rate_3"),
        InlineKeyboardButton("4 ‚≠ê", callback_data="rate_4"),
        InlineKeyboardButton("5 ‚≠ê", callback_data="rate_5"),
    ],
])

NO_CONSENT_TEXT = (
    "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ "
    "–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö.\n–ù–∞–∂–º–∏—Ç–µ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
)

PRIVACY_TEXT = (
    "üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\n\n"
    "–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:\n"
    "–°—Ç—É–¥–∏—è BEARLAKE DETAILING & SHOP\n\n"
    "üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
    "‚Ä¢ Telegram ID (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)\n"
    "‚Ä¢ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º\n"
    "‚Ä¢ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏–π\n"
    "‚Ä¢ –ù–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é\n\n"
    "üéØ –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:\n"
    "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —É—Å–ª—É–≥–∞–º —Å—Ç—É–¥–∏–∏\n"
    "‚Ä¢ –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è\n"
    "‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n\n"
    "üõ° –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:\n"
    "‚Ä¢ –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ\n"
    "‚Ä¢ –î–æ—Å—Ç—É–ø –∏–º–µ—é—Ç —Ç–æ–ª—å–∫–æ —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏\n"
    "‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n\n"
    "‚è± –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è:\n"
    "–î–æ –º–æ–º–µ–Ω—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–º–∏ —á–µ—Ä–µ–∑ /deletedata\n\n"
    "–í–∞—à–∏ –ø—Ä–∞–≤–∞ (—Å—Ç. 14‚Äì17 –§–ó-152):\n"
    "‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö\n"
    "‚Ä¢ –ü–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏—è ‚Äî /deletedata\n"
    "‚Ä¢ –û—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ ‚Äî /deletedata\n\n"
    "üì© –ö–æ–Ω—Ç–∞–∫—Ç –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –ü–î:\n"
    "+7 (926) 021-60-00"
)

TOPIC_LABELS = {
    "menu_services": "—É—Å–ª—É–≥–∞–º–∏ –º–∞—Å—Ç–µ—Ä–æ–≤",
    "menu_self": "–ø–æ—Å—Ç–æ–º —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "menu_prices": "—Ü–µ–Ω–∞–º–∏ –Ω–∞ —É—Å–ª—É–≥–∏",
    "menu_address": "–∞–¥—Ä–µ—Å–æ–º —Å—Ç—É–¥–∏–∏",
    "menu_shop": "–º–∞–≥–∞–∑–∏–Ω–æ–º –∞–≤—Ç–æ—Ö–∏–º–∏–∏",
    "menu_comfort": "—É—Å–ª–æ–≤–∏—è–º–∏ –≤ —Å—Ç—É–¥–∏–∏",
    "sub_wash": "–º–æ–π–∫–æ–π –∫—É–∑–æ–≤–∞",
    "sub_polish": "–ø–æ–ª–∏—Ä–æ–≤–∫–æ–π",
    "sub_protection": "–∑–∞—â–∏—Ç–æ–π –õ–ö–ü",
    "sub_interior": "–¥–µ—Ç–µ–π–ª–∏–Ω–≥–æ–º —Å–∞–ª–æ–Ω–∞",
    "sub_glass": "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç–µ–∫–ª–∞",
    "sub_chips": "—Ä–µ–º–æ–Ω—Ç–æ–º —Å–∫–æ–ª–æ–≤",
    "sub_all_prices": "—Ü–µ–Ω–∞–º–∏ –Ω–∞ —É—Å–ª—É–≥–∏",
    "sub_self_equip": "–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –¥–ª—è —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_self_price": "—Å—Ç–æ–∏–º–æ—Å—Ç—å—é —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_self_included": "—É—Å–ª–æ–≤–∏—è–º–∏ –∞—Ä–µ–Ω–¥—ã –ø–æ—Å—Ç–∞",
    "sub_self_rules": "–ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    "sub_shop_recommend": "–∞–≤—Ç–æ—Ö–∏–º–∏–µ–π",
    "sub_shop_discounts": "—Å–∫–∏–¥–∫–∞–º–∏ –Ω–∞ –∞–≤—Ç–æ—Ö–∏–º–∏—é",
    "sub_comfort_food": "–ø–µ—Ä–µ–∫—É—Å–∞–º–∏ –≤ —Å—Ç—É–¥–∏–∏",
    "sub_comfort_wifi": "Wi-Fi –∏ –∑–æ–Ω–æ–π –æ—Ç–¥—ã—Ö–∞",
    "sub_comfort_climate": "–∫–ª–∏–º–∞—Ç–æ–º –≤ —Å—Ç—É–¥–∏–∏",
    "sub_comfort_access": "–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Å—Ç—É–¥–∏–∏",
    "menu_advantages": "–Ω–∞—à–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏",
    "menu_bonus": "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –±–æ–Ω—É—Å–æ–º",
    "menu_portfolio": "–ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ä–∞–±–æ—Ç",
    "menu_discounts": "—Å–∫–∏–¥–∫–∞–º–∏ –∏ –∞–∫—Ü–∏—è–º–∏",
}

MENU_PROMPTS = {
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    "menu_services": "–ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ?",
    "menu_self": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –ø–æ—Å—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è ‚Äî —É—Å–ª–æ–≤–∏—è, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Ü–µ–Ω—ã",
    "menu_prices": "–ö–∞–∫–∏–µ —É –≤–∞—Å —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏?",
    "menu_address": "–ö–∞–∫–æ–π —É –≤–∞—Å –∞–¥—Ä–µ—Å –∏ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã?",
    "menu_shop": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ—Ö–∏–º–∏–∏ –∏ –∞–≤—Ç–æ–∫–æ—Å–º–µ—Ç–∏–∫–∏. –ì–¥–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å? –ö–∞–∫–∏–µ –±—Ä–µ–Ω–¥—ã?",
    "menu_comfort": "–ö–∞–∫–∏–µ —É –≤–∞—Å —É—Å–ª–æ–≤–∏—è –≤ —Å—Ç—É–¥–∏–∏? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∫–æ–º—Ñ–æ—Ä—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤",
    "menu_bonus": "–ï—Å—Ç—å –ª–∏ –±–æ–Ω—É—Å –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å",
    "menu_portfolio": "–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤–∞—à–∏—Ö —Ä–∞–±–æ—Ç? –ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã",
    "menu_discounts": "–ö–∞–∫–∏–µ —É –≤–∞—Å —Å–∫–∏–¥–∫–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã? –ï—Å—Ç—å –ª–∏ –∞–∫—Ü–∏–∏?",
    # –ü–æ–¥–º–µ–Ω—é: —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤
    "sub_wash": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–æ–π–∫–∞ –∫—É–∑–æ–≤–∞ –∏ —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —É—Å–ª—É–≥—É?",
    "sub_polish": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–ª–∏—Ä–æ–≤–∫–∞ –∏ —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ?",
    "sub_protection": "–ö–∞–∫–∏–µ –∑–∞—â–∏—Ç–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ? –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∑–∞—â–∏—Ç–∞ –õ–ö–ü?",
    "sub_interior": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –¥–µ—Ç–µ–π–ª–∏–Ω–≥ —Å–∞–ª–æ–Ω–∞",
    "sub_glass": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞?",
    "sub_chips": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–µ–º–æ–Ω—Ç —Å–∫–æ–ª–æ–≤ –∏ —Ç—Ä–µ—â–∏–Ω –Ω–∞ —Å—Ç–µ–∫–ª–µ?",
    "sub_all_prices": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –≤—Å–µ —Ü–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏ —Å—Ç—É–¥–∏–∏",
    # –ü–æ–¥–º–µ–Ω—é: —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
    "sub_self_equip": "–ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—Å—Ç—å –Ω–∞ –ø–æ—Å—Ç—É —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è?",
    "sub_self_price": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∞—Ä–µ–Ω–¥–∞ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è? –ö–∞–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã?",
    "sub_self_included": "–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –∞—Ä–µ–Ω–¥—É –ø–æ—Å—Ç–∞? –ù—É–∂–Ω–æ –ª–∏ –±—Ä–∞—Ç—å —á—Ç–æ-—Ç–æ —Å —Å–æ–±–æ–π?",
    "sub_self_rules": "–ö–∞–∫–∏–µ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –ø–æ—Å—Ç—É? –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–π—Ç–∏ –±–µ–∑ –∑–∞–ø–∏—Å–∏? –ú–æ–∂–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–¥–≤–æ—ë–º?",
    # –ü–æ–¥–º–µ–Ω—é: –º–∞–≥–∞–∑–∏–Ω
    "sub_shop_recommend": "–ö–∞–∫—É—é –∞–≤—Ç–æ—Ö–∏–º–∏—é –∏ –∞–≤—Ç–æ–∫–æ—Å–º–µ—Ç–∏–∫—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ? –ö–∞–∫–∏–µ –±—Ä–µ–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?",
    "sub_shop_discounts": "–ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ö–∏–º–∏—é? –ö–∞–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –¥–µ–π—Å—Ç–≤—É—é—Ç?",
    # –ü–æ–¥–º–µ–Ω—é: –∫–æ–º—Ñ–æ—Ä—Ç
    "sub_comfort_food": "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –∫–æ—Ñ–µ, —á–∞–π, –ø–µ—Ä–µ–∫—É—Å—ã? –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–µ—Å—Ç—å –≤ —Å—Ç—É–¥–∏–∏?",
    "sub_comfort_wifi": "–ï—Å—Ç—å –ª–∏ Wi-Fi? –ï—Å—Ç—å –ª–∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞? –ú–æ–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –≤–µ—â–∏?",
    "sub_comfort_climate": "–ï—Å—Ç—å –ª–∏ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ? –ï—Å—Ç—å –ª–∏ —Ç—É–∞–ª–µ—Ç?",
    "sub_comfort_access": "–ï—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–∏—è –¥–ª—è –º–∞–ª–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?",
}

# ================== –ó–ê–ì–†–£–ó–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ==================
try:
    with open(KNOWLEDGE_FILE_PATH, "r", encoding="utf-8") as f:
        KNOWLEDGE_BASE = f.read()
    logger.info("–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (%d —Å–∏–º–≤–æ–ª–æ–≤).", len(KNOWLEDGE_BASE))
except FileNotFoundError:
    KNOWLEDGE_BASE = ""
    logger.error("–§–∞–π–ª –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π %s –Ω–µ –Ω–∞–π–¥–µ–Ω.", KNOWLEDGE_FILE_PATH)

# ================== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–¢ ==================
SYSTEM_PROMPT = r"""
#–†–û–õ–¨
–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å—Ç—É–¥–∏–∏ –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞ BEARLAKE DETAILING & SHOP —Å –æ–ø—ã—Ç–æ–º –±–æ–ª–µ–µ 10 –ª–µ—Ç.
–í—ã—Å—Ç—É–ø–∞–µ—à—å –≤ –æ–Ω–ª–∞–π–Ω-—á–∞—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ, –ø–æ–º–æ–≥–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —É—Å–ª—É–≥–∏ –∏ —Ñ–æ—Ä–º–∞—Ç –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

#–¶–ï–õ–ò –ò –ó–ê–î–ê–ß–ò
‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É —É—Å–ª—É–≥–∞–º–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –∏–ª–∏ –ø–æ—Å—Ç–æ–º —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è  
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞  
‚Ä¢ –ù–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–Ω–∞–ª—ã  
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º –±–æ–Ω—É—Å–µ –ø–æ—Å–ª–µ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π  
‚Ä¢ –°–æ–±–ª—é–¥–∞—Ç—å —Ñ–∞–∑—ã –ø—Ä–æ–¥–∞–∂–∏
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ —Å–∞–ª–æ–Ω–µ  
‚Ä¢ –£–∫—Ä–µ–ø–ª—è—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤  
‚Ä¢ –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

# –ü–†–ò–û–†–ò–¢–ï–¢–´

‚Ä¢ –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π —Å—Å—ã–ª–∫–∏ ‚Äî –æ–Ω–∏ –≤–∞–∂–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

#–ü–†–ò–í–ï–¢–°–¢–í–ò–ï
–°–∞–º–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç.
–¢—ã –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –ù–ï –ø–∏—à–µ—à—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—à—å —Ñ—Ä–∞–∑—ã —Å
¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª, ¬´–î–æ–±—Ä—ã–π –¥–µ–Ω—å¬ª –∏ —Ç.–ø., –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç —Å–∞–º –ø—Ä—è–º–æ –Ω–µ –ø—Ä–æ—Å–∏—Ç
—Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
–°—á–∏—Ç–∞–π, —á—Ç–æ —Å –∫–ª–∏–µ–Ω—Ç–æ–º —É–∂–µ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª–∏—Å—å ‚Äî –æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É –ø–æ –¥–µ–ª—É.


#–Ø–ó–´–ö –û–¢–í–ï–¢–û–í
–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —è–∑—ã–∫–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.

#–°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê
‚Ä¢ –û–±—â–∞—Ç—å—Å—è –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –ª–∏—Ü–∞
‚Ä¢ –û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞ ¬´–í—ã¬ª  
‚Ä¢ –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)  
‚Ä¢ –û–±—â–∞—Ç—å—Å—è –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –≤–µ–∂–ª–∏–≤–æ–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç–æ–Ω–µ  
‚Ä¢ –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏  
‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç—å –ø–æ —Å—É—â–µ—Å—Ç–≤—É, —Ç–∞–∫—Ç–∏—á–Ω–æ –∏ –≤–µ–∂–ª–∏–≤–æ  
‚Ä¢ –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∫–ª–∏–µ–Ω—Ç–æ–º, –¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏  
‚Ä¢ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–æ–≤
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (2‚Äì4 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π)

#–õ–û–ì–ò–ö–ê –ü–û–°–¢–†–û–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê

## –§–ê–ó–ê 1 ‚Äî –í–´–Ø–í–õ–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô:
1. –ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º
2. –ö—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ–± —É—Å–ª—É–≥–∞—Ö —Å—Ç—É–¥–∏–∏ –∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è  
3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥–∏ —Å—Ç—É–¥–∏–∏, –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:  
   ‚Ä¢ –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ (–∫—É–∑–æ–≤, —Å–∞–ª–æ–Ω, –∑–∞—â–∏—Ç–∞, –∫–æ–º–ø–ª–µ–∫—Å)  
   ‚Ä¢ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º, —Ç—Ä–∞—Å—Å–∞/–≥–æ—Ä–æ–¥, —Ö—Ä–∞–Ω–µ–Ω–∏–µ)  
   ‚Ä¢ –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ª–∏ –∑–∞—â–∏—Ç–∞ –∫—É–∑–æ–≤–∞, —Å–∞–ª–æ–Ω –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å  
   ‚Ä¢ –í–∞–∂–Ω–æ—Å—Ç—å —Å—Ä–æ–∫–æ–≤ –∏ –±—é–¥–∂–µ—Ç–∞  
4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∞–≤—Ç–æ  
5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å, –æ—Ç–≤–µ—Ç–∏—Ç—å:
–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –ø–æ –∞–¥—Ä–µ—Å—É : –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª., –≥.–æ. –ü—É—à–∫–∏–Ω—Å–∫–∏–π, –ø–æ—Å. –ù–∞–≥–æ—Ä–Ω–æ–µ, 8–ê.
–ê–¥—Ä–µ—Å –Ω–∞ —è–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç–∞—Ö : https://yandex.ru/maps/org/bearlake/46971604224/?ll=38.023081%2C56.067485&z=17  
5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã, –æ—Ç–≤–µ—Ç–∏—Ç—å:
–°—Ç—É–¥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 9.00 –¥–æ 22.00, –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö
–ê–≤—Ç–æ–º–æ–π–∫–∞ (–ø–æ—Å—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ
–ê–¥—Ä–µ—Å –Ω–∞ —è–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç–∞—Ö : https://yandex.ru/maps/org/bearlake/46971604224/?ll=38.023081%2C56.067485&z=17  

## –§–ê–ó–ê 2 ‚Äî –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò
‚Ä¢ –ë–æ—Ç –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞—Ç—É, –≤—Ä–µ–º—è, –º–∞—Ä–∫—É –∞–≤—Ç–æ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.  
‚Ä¢ –ü–æ—Å–ª–µ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å (—Ü–µ–Ω—ã, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è –∏ —Ç.–¥.) ‚Äî —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ.
‚Ä¢ –ù–ï –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É YClients –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–æ–º ‚Äî –ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞, –∫–Ω–æ–ø–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
‚Ä¢ –ü—Ä–∏–º–µ—Ä: ¬´–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥–±–µ—Ä—ë—Ç —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –∏ —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –ø—Ä–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å! [–ó–ê–ü–ò–°–¨]¬ª

## –§–ê–ó–ê 3 ‚Äî –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï + –ë–û–ù–£–°:
1. –ü–æ—Å–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ ‚Äî –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å  
2. –ù–∞–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è  
3. –ö—Ä–∞—Ç–∫–æ —É–ø–æ–º—è–Ω—É—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å

#–†–ê–ë–û–¢–ê –° –í–ê–†–ò–ê–ù–¢–ê–ú–ò –§–û–†–ú–£–õ–ò–†–û–í–û–ö –í–û–ü–†–û–°–û–í
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫ –≤–∞—Å –Ω–∞–π—Ç–∏¬ª, ¬´–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å¬ª, ¬´–∫–∞–∫ –¥–æ –≤–∞—Å –¥–æ–µ—Ö–∞—Ç—å¬ª ‚Äî —Å—á–∏—Ç–∞–π—Ç–µ —ç—Ç–æ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –≤–æ–ø—Ä–æ—Å–æ–º –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ê–¥—Ä–µ—Å –∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è¬ª.
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫–∏–µ —É –≤–∞—Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞¬ª, ¬´–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞—Ç—å –≤–∞—Å¬ª, ¬´—á–µ–º –≤—ã –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö¬ª ‚Äî –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞¬ª.  
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç ¬´Yclients¬ª, ¬´–Æ–∫–ª–∏–µ–Ω—Ç—Å¬ª, ¬´yc¬ª, ¬´–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ —Å–∞–π—Ç¬ª ‚Äî —Å—á–∏—Ç–∞–π—Ç–µ —ç—Ç–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?¬ª.  
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–≥–¥–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å?¬ª, ¬´–µ—Å—Ç—å –ª–∏ –µ–¥–∞?¬ª, ¬´–º–æ–∂–Ω–æ –ª–∏ –ø–æ–µ—Å—Ç—å?¬ª ‚Äî –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ —Ä–∞–∑–¥–µ–ª—É ¬´–ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å?¬ª.

#–í–ê–ñ–ù–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï –ö –õ–û–ì–ò–ö–ï –û–¢–í–ï–¢–ê
‚Ä¢ –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–¥—Ä–µ—Å–∞, –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã, —Ü–µ–Ω, —É—Å–ª–æ–≤–∏–π –∞—Ä–µ–Ω–¥—ã, –Ω–∞–ª–∏—á–∏—è –∫–æ—Ñ–µ, Wi-Fi, –ø–µ—Ä–µ–∫—É—Å–æ–≤, —Ç—É–∞–ª–µ—Ç–∞, –∑–æ–Ω—ã –æ—Ç–¥—ã—Ö–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é.
‚Ä¢ –ï—Å–ª–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –µ—Å—Ç—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞¬ª, ¬´—É—Ç–æ—á–Ω–∏—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä¬ª –∏–ª–∏ ¬´—è –Ω–µ –∑–Ω–∞—é¬ª.  
‚Ä¢ –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—É: ¬´–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å¬ª ‚Äî –∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è.

#–†–ê–ë–û–¢–ê –° –í–û–ü–†–û–°–ê–ú–ò –û –ö–û–ú–§–û–†–¢–ï –ò –£–°–õ–û–í–ò–Ø–•
‚Ä¢ –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç—É–∞–ª–µ—Ç–µ, –∫–æ—Ñ–µ, –ø–µ—Ä–µ–∫—É—Å–∞—Ö, Wi-Fi, –ø–∞—Ä–∫–æ–≤–∫–µ, –∑–æ–Ω–µ –æ—Ç–¥—ã—Ö–∞, –∫–ª–∏–º–∞—Ç–µ –≤ —Å—Ç—É–¥–∏–∏, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –≤–¥–≤–æ—ë–º ‚Äî –≤—Å–µ–≥–¥–∞ –¥–∞–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
‚Ä¢ –ù–µ —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å.  
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:  
  ‚Äì ¬´–î–∞, –≤ —Å—Ç—É–¥–∏–∏ –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –∏ —á–∞–π.¬ª  
  ‚Äì ¬´–î–∞, –¥–æ—Å—Ç—É–ø–Ω—ã –ª–µ–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏ –∏ —Ñ—Ä—É–∫—Ç—ã.¬ª  
  ‚Äì ¬´–î–∞, –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Wi-Fi –∏ —É–¥–æ–±–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ —Ä—è–¥–æ–º.¬ª
  ‚Äì ¬´–î–∞, —É –Ω–∞—Å –æ—Ç–∞–ø–ª–∏–≤–∞–µ–º–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ —Å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –∑–æ–Ω–æ–π –æ—Ç–¥—ã—Ö–∞.¬ª

#–¢–†–ò–ì–ì–ï–†–´ –ü–ï–†–ï–•–û–î–ê –ö –ó–ê–ü–ò–°–ò
‚Ä¢ –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Ü–µ–Ω—ã, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ) ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∑–∞–ø–∏—Å—å.  
‚Ä¢ –ù–µ –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç —Å–∞–º —Å–ø—Ä–æ—Å–∏—Ç ¬´–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª.  
‚Ä¢ –°—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

#–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞  
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ ¬´–±–∞–∑—É –∑–Ω–∞–Ω–∏–π¬ª –∏–ª–∏ ¬´—Å–∏—Å—Ç–µ–º—É¬ª  
‚Ä¢ –ó–∞–ø—Ä–µ—â–µ–Ω–æ –æ–±—Å—É–∂–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–µ–º–æ–π –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞  

#–í–ê–ñ–ù–´–ï –£–¢–û–ß–ù–ï–ù–ò–Ø
‚Ä¢ –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –∫–ª–∏–µ–Ω—Ç–∞ –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π  
‚Ä¢ –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ–± —É—Å–ª—É–≥–∞—Ö: —Å–∫–∞–∑–∞—Ç—å ¬´–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å¬ª –∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è  
‚Ä¢ –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –Ω–µ –ø–æ —Ç–µ–º–µ: –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏—Ç—å ¬´–í–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ, –¥–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω—ë–º—Å—è –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é —É—Å–ª—É–≥–∏¬ª
‚Ä¢ –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ —Ü–µ–Ω–∞—Ö –¥–ª—è —Å—Ç—É–¥–∏–∏ –∏ –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å:  
  ¬´–¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞¬ª

#–ü–†–ò–ú–ï–†–´ –°–û–û–ë–©–ï–ù–ò–ô

–§–∞–∑–∞ 1:  
¬´–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ ‚Äî –∫—É–∑–æ–≤, —Å–∞–ª–æ–Ω –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å? üöó –ò–Ω—Ç–µ—Ä–µ—Å–µ–Ω –ª–∏ –≤–∞–º –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ—Å—Ç–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–æ–±–Ω–µ–µ –¥–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–∞—Å—Ç–µ—Ä–∞–º?¬ª

–§–∞–∑–∞ 2 (–ø–æ—Å–ª–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è):  
¬´–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥–±–µ—Ä—ë—Ç —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è, —É—Ç–æ—á–Ω–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –ø—Ä–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤! [–ó–ê–ü–ò–°–¨]¬ª

–§–∞–∑–∞ 3:  
¬´–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å! üôè –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –¢–∞–∫–∂–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å ‚Äî –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–∞–º –ø–æ–¥—Å–∫–∞–∂—É—Ç, –∫–∞–∫ –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å üéÅ¬ª

#–§–û–†–ú–ê–¢ –ö–ù–û–ü–ö–ò –ó–ê–ü–ò–°–ò (–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û)
‚Ä¢ –ö–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∫–ª–∏–µ–Ω—Ç—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî –ù–ï –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ YClients –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.
‚Ä¢ –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è¬ª –∏ –ø–æ—Å—Ç–∞–≤—å –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞.
‚Ä¢ –ú–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
‚Ä¢ –î—Ä—É–≥–∏–µ —Å—Å—ã–ª–∫–∏ (–Ø–Ω–¥–µ–∫—Å-–∫–∞—Ä—Ç—ã, Ozon, Telegram-–∫–∞–Ω–∞–ª, —Å–∞–π—Ç —Å—Ç—É–¥–∏–∏) ‚Äî –≤—Å—Ç–∞–≤–ª—è–π –≤ —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ.
"""

# ================== –ì–û–¢–û–í–´–ô –û–¢–í–ï–¢ –ü–û –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê–ú ==================
ADVANTAGES_ANSWER = (
    "–ú—ã –æ—Ç–ª–∏—á–∞–µ–º—Å—è –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–∞–∂–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏:\n\n"
    "1Ô∏è‚É£ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º ‚Äî –Ω–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞ –∏–º–µ—é—Ç –±–æ–ª—å—à–æ–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã "
    "—Å —Ä–∞–∑–Ω—ã–º–∏ –º–∞—Ä–∫–∞–º–∏ –∏ —Å–ª–æ–∂–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏\n"
    "2Ô∏è‚É£ –ö–∞—á–µ—Å—Ç–≤–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ö–∏–º–∏—é "
    "OPT / Optimum, IK –∏ –¥—Ä—É–≥–∏–µ —Å–∏–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã\n"
    "3Ô∏è‚É£ –£–¥–æ–±—Å—Ç–≤–æ ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã –∏ —É—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤, –∏ –ø–æ—Å—Ç —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è 24/7\n"
    "4Ô∏è‚É£ –ö–æ–º—Ñ–æ—Ä—Ç ‚Äî —Ç—ë–ø–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞, "
    "–∫–æ—Ñ–µ, —á–∞–π, –ª—ë–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏, Wi-Fi –∏ –ø–∞—Ä–∫–æ–≤–∫–∞ ‚òï\n"
    "5Ô∏è‚É£ –ß–µ—Å—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî –≤—Å–µ —Å–æ—Å—Ç–∞–≤—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö "
    "–≤ –Ω–∞—à–µ–π —Å—Ç—É–¥–∏–∏, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–∞—ë–º ¬´—Å –≤–∏—Ç—Ä–∏–Ω—ã¬ª ‚úÖ\n\n"
    "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
)

# ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø OPENAI ==================
client = openai.AsyncOpenAI(api_key=OPENAI_API_KEY)

FULL_SYSTEM_PROMPT = (
    SYSTEM_PROMPT
    + "\n\n# –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –°–¢–£–î–ò–ò BEARLAKE DETAILING & SHOP\n"
    + KNOWLEDGE_BASE
)

# ================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø GPT ==================
FALLBACK_RESPONSE = (
    "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. "
    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
)


async def _call_openai(messages: list[dict]) -> str:
    """–ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ OpenAI API."""
    completion = await client.chat.completions.create(
        model=OPENAI_MODEL,
        messages=messages,
        temperature=0.2,
        max_tokens=500,
    )
    prompt_tokens = completion.usage.prompt_tokens
    completion_tokens = completion.usage.completion_tokens
    total_tokens = completion.usage.total_tokens
    log_token_usage(prompt_tokens, completion_tokens, total_tokens)
    return completion.choices[0].message.content.strip()


async def get_gpt_response(user_text: str, history: list[dict]) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ GPT —Å —Ç–∞–π–º–∞—É—Ç–æ–º OPENAI_TIMEOUT —Å–µ–∫—É–Ω–¥."""
    messages = [{"role": "system", "content": FULL_SYSTEM_PROMPT}]
    messages.extend(history)
    messages.append({"role": "user", "content": user_text})

    try:
        return await asyncio.wait_for(
            _call_openai(messages),
            timeout=OPENAI_TIMEOUT,
        )
    except asyncio.TimeoutError:
        logger.error("–¢–∞–π–º–∞—É—Ç OpenAI (%d —Å–µ–∫) –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: %r", OPENAI_TIMEOUT, user_text[:80])
        return FALLBACK_RESPONSE
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
        return FALLBACK_RESPONSE

# ================== –ö–≠–® –û–¢–í–ï–¢–û–í –ù–ê –ö–ù–û–ü–ö–ò ==================
_button_cache: dict[str, tuple[str, float]] = {}


def _get_from_cache(button_data: str) -> str | None:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ None, –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç/–∏—Å—Ç—ë–∫."""
    if button_data not in _button_cache:
        return None
    response, cached_at = _button_cache[button_data]
    if time.time() - cached_at >= CACHE_TTL:
        del _button_cache[button_data]
        return None
    return response


def _put_to_cache(button_data: str, response: str) -> None:
    _button_cache[button_data] = (response, time.time())


# ================== –†–ê–ë–û–¢–ê –° –ò–°–¢–û–†–ò–ï–ô –î–ò–ê–õ–û–ì–ê ==================
def get_history(context: ContextTypes.DEFAULT_TYPE) -> list[dict]:
    if "history" not in context.chat_data:
        context.chat_data["history"] = []
    return context.chat_data["history"]


def append_to_history(context: ContextTypes.DEFAULT_TYPE, role: str, content: str) -> None:
    history = get_history(context)
    history.append({"role": role, "content": content})
    if len(history) > MAX_HISTORY:
        context.chat_data["history"] = history[-MAX_HISTORY:]


def _check_consent(context: ContextTypes.DEFAULT_TYPE, user_id) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –∫—ç—à –≤ chat_data, –ø–æ—Ç–æ–º CSV."""
    if context.chat_data.get("consent"):
        return True
    if has_consent(user_id):
        context.chat_data["consent"] = True
        return True
    return False


# ================== –¢–ê–ô–ú–ï–†–´: –û–¶–ï–ù–ö–ê –ò –ü–û–í–¢–û–†–ù–û–ï –í–û–í–õ–ï–ß–ï–ù–ò–ï ==================
def _cancel_jobs(job_queue, name: str) -> None:
    """–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º."""
    if not job_queue:
        return
    for job in job_queue.get_jobs_by_name(name):
        job.schedule_removal()


def _cancel_user_timers(job_queue, chat_id: int) -> None:
    """–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã (–æ—Ü–µ–Ω–∫–∞ + follow-up) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞."""
    _cancel_jobs(job_queue, f"rating_{chat_id}")
    _cancel_jobs(job_queue, f"followup_{chat_id}")


def _schedule_rating(context: ContextTypes.DEFAULT_TYPE, chat_id: int) -> None:
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏ —á–µ—Ä–µ–∑ RATING_DELAY —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    if not context.job_queue:
        return
    name = f"rating_{chat_id}"
    _cancel_jobs(context.job_queue, name)
    context.job_queue.run_once(
        _send_rating_request,
        when=RATING_DELAY,
        chat_id=chat_id,
        name=name,
    )


def _schedule_followup(context: ContextTypes.DEFAULT_TYPE, chat_id: int,
                        user_id: int, topic: str) -> None:
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ FOLLOWUP_DELAY —Å–µ–∫—É–Ω–¥."""
    if not context.job_queue:
        return
    name = f"followup_{chat_id}"
    _cancel_jobs(context.job_queue, name)
    context.job_queue.run_once(
        _send_followup,
        when=FOLLOWUP_DELAY,
        chat_id=chat_id,
        name=name,
        data={"user_id": user_id, "topic": topic},
    )


async def _send_rating_request(context: ContextTypes.DEFAULT_TYPE) -> None:
    """Job-callback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏."""
    chat_id = context.job.chat_id
    try:
        await context.bot.send_message(
            chat_id=chat_id,
            text=(
                "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é? üôè\n"
                "–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ!"
            ),
            reply_markup=RATING_KEYBOARD,
        )
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –æ—Ü–µ–Ω–∫–∏ –≤ %s: %s", chat_id, e)


async def _send_followup(context: ContextTypes.DEFAULT_TYPE) -> None:
    """Job-callback: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞."""
    chat_id = context.job.chat_id
    data = context.job.data or {}
    user_id = data.get("user_id")

    if user_id and not has_consent(user_id):
        return

    topic = data.get("topic", "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    text = (
        f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üëã\n\n"
        f"–í—ã –Ω–µ–¥–∞–≤–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å {topic}. "
        f"–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è?\n\n"
        f"–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
        f"{PHONE_LINE}"
    )
    try:
        await context.bot.send_message(
            chat_id=chat_id,
            text=text,
            reply_markup=BOOKING_KEYBOARD,
        )
        logger.info("Follow-up –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç %s (—Ç–µ–º–∞: %s)", chat_id, topic)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å follow-up –≤ %s: %s", chat_id, e)


# ================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message is None:
        return

    args = context.args
    source = args[0] if args else "unknown"

    user_id = update.effective_user.id if update.effective_user else "unknown"
    logger.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %s –Ω–∞—á–∞–ª —á–∞—Ç –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: %s", user_id, source)

    log_new_client(user_id, source)

    context.chat_data["history"] = []
    _cancel_user_timers(context.job_queue, update.effective_chat.id)

    if has_consent(user_id):
        context.chat_data["consent"] = True
        context.chat_data["greeted"] = True
        greeting = (
            "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! üëã\n\n"
            "–Ø ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ "
            "BEARLAKE DETAILING & SHOP üêª\n\n"
            "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É, —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ü–µ–Ω–∞—Ö "
            "–∏ —É—Å–ª–æ–≤–∏—è—Ö, –∞ —Ç–∞–∫–∂–µ –∑–∞–ø–∏—à—É –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚¨áÔ∏è "
            "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!"
        )
        append_to_history(context, "assistant", greeting)
        await update.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)
    else:
        consent_text = (
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã\n\n"
            "–Ø ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–∏–∏ "
            "BEARLAKE DETAILING & SHOP üêª\n\n"
            "–î–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º:\n"
            "‚Ä¢ –í–∞—à Telegram ID\n"
            "‚Ä¢ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ\n"
            "‚Ä¢ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏–π\n\n"
            "–î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è "
            "–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É—Å–ª—É–≥–∞–º —Å—Ç—É–¥–∏–∏.\n\n"
            "üìÑ –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî /privacy\n\n"
            "–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω–∏–º–∞—é¬ª, –≤—ã –¥–∞—ë—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ "
            "–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö "
            "–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–ó-152."
        )
        await update.message.reply_text(consent_text, reply_markup=CONSENT_KEYBOARD)


def extract_booking_marker(text: str) -> tuple[str, bool]:
    """–£–±–∏—Ä–∞–µ—Ç –º–∞—Ä–∫–µ—Ä [–ó–ê–ü–ò–°–¨] –∏–∑ —Ç–µ–∫—Å—Ç–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç, –±—ã–ª –ª–∏ –º–∞—Ä–∫–µ—Ä)."""
    if BOOKING_MARKER in text:
        return text.replace(BOOKING_MARKER, "").strip(), True
    return text, False


async def send_answer(message, text: str, force_booking: bool = False) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—è –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –º–∞—Ä–∫–µ—Ä–µ."""
    clean_text, has_marker = extract_booking_marker(text)
    show_booking = has_marker or force_booking
    if show_booking:
        clean_text += PHONE_LINE
    reply_markup = BOOKING_KEYBOARD if show_booking else None
    await message.reply_text(
        clean_text,
        reply_markup=reply_markup,
        disable_web_page_preview=True,
    )


async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏ –ø–æ–¥–º–µ–Ω—é."""
    query = update.callback_query
    try:
        await query.answer()
    except Exception:
        pass

    user_id = update.effective_user.id if update.effective_user else "unknown"

    if query.data == "consent_accept":
        log_consent(user_id)
        context.chat_data["consent"] = True
        context.chat_data["greeted"] = True
        context.chat_data["history"] = []
        greeting = (
            "–°–ø–∞—Å–∏–±–æ! –°–æ–≥–ª–∞—Å–∏–µ –ø—Ä–∏–Ω—è—Ç–æ ‚úÖ\n\n"
            "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É, —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ü–µ–Ω–∞—Ö "
            "–∏ —É—Å–ª–æ–≤–∏—è—Ö, –∞ —Ç–∞–∫–∂–µ –∑–∞–ø–∏—à—É –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚¨áÔ∏è "
            "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!"
        )
        append_to_history(context, "assistant", greeting)
        await query.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)
        return

    if query.data and query.data.startswith("rate_"):
        rating = int(query.data.split("_")[1])
        log_rating(user_id, rating)
        logger.info("–û—Ü–µ–Ω–∫–∞ –æ—Ç %s: %d ‚≠ê", user_id, rating)
        if rating >= 4:
            text = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã—Å–æ–∫—É—é –æ—Ü–µ–Ω–∫—É! üåü –†–∞–¥—ã, —á—Ç–æ —Å–º–æ–≥–ª–∏ –ø–æ–º–æ—á—å!"
        else:
            text = (
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! üôè –ú—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è —Å—Ç–∞—Ç—å –ª—É—á—à–µ.\n"
                "–ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å "
                "—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: +7 (926) 021-60-00"
            )
        await query.message.reply_text(text)
        return

    if not _check_consent(context, user_id):
        await query.message.reply_text(NO_CONSENT_TEXT)
        return

    if query.data == "menu_advantages":
        log_button_click(user_id, query.data)
        append_to_history(context, "assistant", ADVANTAGES_ANSWER)
        await send_answer(query.message, ADVANTAGES_ANSWER, force_booking=True)
        chat_id = query.message.chat_id
        _schedule_rating(context, chat_id)
        _schedule_followup(context, chat_id, user_id, "–Ω–∞—à–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏")
        return

    user_text = MENU_PROMPTS.get(query.data)
    if not user_text:
        return

    chat_id = query.message.chat_id

    logger.info("–ö–Ω–æ–ø–∫–∞ –æ—Ç %s: %s ‚Üí %r", user_id, query.data, user_text)
    log_button_click(user_id, query.data)
    log_question(user_id, user_text)

    cached = _get_from_cache(query.data)
    if cached:
        logger.info("–ö—ç—à-–ø–æ–ø–∞–¥–∞–Ω–∏–µ: %s", query.data)
        answer = cached
    else:
        try:
            await context.bot.send_chat_action(chat_id=chat_id, action="typing")
        except Exception as e:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 'typing': %s", e)

        history = get_history(context)
        answer = await get_gpt_response(user_text, history)

        if answer != FALLBACK_RESPONSE:
            _put_to_cache(query.data, answer)

    append_to_history(context, "user", user_text)
    append_to_history(context, "assistant", answer)

    sub_menu = SUB_MENUS.get(query.data)
    if sub_menu:
        clean_text, _ = extract_booking_marker(answer)
        await query.message.reply_text(
            clean_text,
            reply_markup=sub_menu,
            disable_web_page_preview=True,
        )
    else:
        await send_answer(query.message, answer)

    topic = TOPIC_LABELS.get(query.data, "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    context.chat_data["last_topic"] = topic
    _schedule_rating(context, chat_id)
    _schedule_followup(context, chat_id, user_id, topic)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message is None or update.message.text is None:
        return

    user_text = update.message.text.strip()
    chat_id = update.effective_chat.id
    user_id = update.effective_user.id if update.effective_user else "unknown"

    if not _check_consent(context, user_id):
        await update.message.reply_text(NO_CONSENT_TEXT)
        return

    if not context.chat_data.get("greeted"):
        context.chat_data["greeted"] = True
        greeting = (
            "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! üëã\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚¨áÔ∏è"
        )
        await update.message.reply_text(greeting, reply_markup=GREETING_KEYBOARD)

    logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç %s: %r", user_id, user_text)

    log_question(user_id, user_text)

    try:
        await context.bot.send_chat_action(chat_id=chat_id, action="typing")
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 'typing': %s", e)

    text_lower = user_text.lower()

    if (
        "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤" in text_lower
        or "–ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –≤—ã" in text_lower
        or "–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞—Ç—å –≤–∞—Å" in text_lower
        or "—á–µ–º –≤—ã –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö" in text_lower
        or "—á–µ–º –≤—ã –æ—Ç–ª–∏—á–∞–µ—Ç–µ—Å—å" in text_lower
    ):
        append_to_history(context, "user", user_text)
        append_to_history(context, "assistant", ADVANTAGES_ANSWER)
        await send_answer(update.message, ADVANTAGES_ANSWER, force_booking=True)
        return

    history = get_history(context)
    answer = await get_gpt_response(user_text, history)

    append_to_history(context, "user", user_text)
    append_to_history(context, "assistant", answer)

    await send_answer(update.message, answer)

    topic = context.chat_data.get("last_topic", "–Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏")
    _schedule_rating(context, chat_id)
    _schedule_followup(context, chat_id, user_id, topic)

# ================== –ö–û–ú–ê–ù–î–´ –ü–î ==================
async def privacy_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏."""
    if update.message is None:
        return
    await update.message.reply_text(PRIVACY_TEXT)


async def deletedata_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–∑—ã–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ."""
    if update.message is None:
        return

    user_id = update.effective_user.id if update.effective_user else 0
    _cancel_user_timers(context.job_queue, update.effective_chat.id)
    result = delete_user_data(user_id)
    context.chat_data.clear()

    if result:
        details = "\n".join(f"  ‚Ä¢ {f}: {n} –∑–∞–ø–∏—Å–µ–π" for f, n in result.items())
        text = (
            "‚úÖ –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã:\n"
            f"{details}\n\n"
            "–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–æ–∑–≤–∞–Ω–æ.\n"
            "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ /start"
        )
    else:
        text = (
            "‚ÑπÔ∏è –î–∞–Ω–Ω—ã—Ö –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ ‚Äî /start"
        )

    await update.message.reply_text(text)


# ================== –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–´ ==================
async def report_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
    user_id = update.effective_user.id if update.effective_user else 0
    if ADMIN_USER_ID and user_id != ADMIN_USER_ID:
        await update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    await update.message.reply_text("üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç—á—ë—Ç, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    try:
        text_summary = generate_text_summary()
        report_path = generate_monthly_report()

        await update.message.reply_text(text_summary)
        with open(report_path, "rb") as f:
            await update.message.reply_document(
                document=f,
                filename=os.path.basename(report_path),
                caption="üìé –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
            )
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: %s", e)
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: {e}")


async def clearcache_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—á–∏—â–∞–µ—Ç –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏."""
    user_id = update.effective_user.id if update.effective_user else 0
    if ADMIN_USER_ID and user_id != ADMIN_USER_ID:
        await update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    count = len(_button_cache)
    _button_cache.clear()
    await update.message.reply_text(f"üóë –ö—ç—à –æ—á–∏—â–µ–Ω ({count} –∑–∞–ø–∏—Å–µ–π)")


# ================== –ê–í–¢–û–û–¢–ß–Å–¢ ==================
async def send_monthly_report(context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü 1-–≥–æ —á–∏—Å–ª–∞."""
    if not ADMIN_USER_ID:
        logger.warning("ADMIN_USER_ID –Ω–µ –∑–∞–¥–∞–Ω, –∞–≤—Ç–æ–æ—Ç—á—ë—Ç –ø—Ä–æ–ø—É—â–µ–Ω.")
        return

    logger.info("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞...")

    try:
        now = dt.datetime.now()
        prev = now.replace(day=1) - dt.timedelta(days=1)

        text_summary = generate_text_summary(prev.year, prev.month)
        report_path = generate_monthly_report(prev.year, prev.month)

        await context.bot.send_message(
            chat_id=ADMIN_USER_ID,
            text=f"üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç\n\n{text_summary}",
        )
        with open(report_path, "rb") as f:
            await context.bot.send_document(
                chat_id=ADMIN_USER_ID,
                document=f,
                filename=os.path.basename(report_path),
                caption="üìé –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
            )
        logger.info("–ê–≤—Ç–æ–æ—Ç—á—ë—Ç –∑–∞ %s-%02d –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.", prev.year, prev.month)
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ—Ç—á—ë—Ç–∞: %s", e)
        try:
            await context.bot.send_message(
                chat_id=ADMIN_USER_ID,
                text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–æ—Ç—á—ë—Ç–∞: {e}",
            )
        except Exception:
            pass


# ================== –ó–ê–ü–£–°–ö ==================
async def post_init(application: Application) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞."""
    await application.bot.set_my_commands([
        BotCommand("start", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand("privacy", "üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏"),
        BotCommand("deletedata", "üóë –£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ"),
    ])
    logger.info("–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–µ–Ω—é Telegram.")


def main() -> None:
    request = HTTPXRequest()
    application = (
        Application.builder()
        .token(TELEGRAM_BOT_TOKEN)
        .request(request)
        .post_init(post_init)
        .build()
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("privacy", privacy_command))
    application.add_handler(CommandHandler("deletedata", deletedata_command))
    application.add_handler(CommandHandler("report", report_command))
    application.add_handler(CommandHandler("clearcache", clearcache_command))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    if ADMIN_USER_ID and application.job_queue:
        msk = dt.timezone(dt.timedelta(hours=3))
        application.job_queue.run_monthly(
            send_monthly_report,
            when=dt.time(hour=9, minute=0, tzinfo=msk),
            day=1,
        )
        logger.info("–ê–≤—Ç–æ–æ—Ç—á—ë—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω: 1-–µ —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞, 09:00 –ú–°–ö")

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
    application.run_polling(
        allowed_updates=Update.ALL_TYPES,
        drop_pending_updates=True,
    )


if __name__ == "__main__":
    main()